@using Income.Database.Models.Common
@using Income.Database.Queries
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IToastService ToastService
@inject PreloadService preloadService

<div class="page p-0 w-100">
    <main class="px-0 py-0 w-100">
        <div class="navbar m-0 p-0 w-100 custom-badge">
            <div class="navbar-brand d-flex align-items-center">
                <img src="images/nsso75logo.svg" alt="Income" title="Income" height="48" class="logo-img" />
                <h4 class="m-0 badge badge-outline badge-primary">Household Income Survey</h4>
            </div>
            <ul class="navbar-nav ms-auto">
                @* <div class="dropdown"> *@
                @*     <button class="btn btn-outline-secondary  dropdown-toggle d-flex align-items-center" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false"> *@
                @*         <i class="fi fi-rr-language-exchange me-2" style="font-size:25px; line-height:0px;"></i> <span class="d-none d-sm-block">@(language.Resources.LanguageName ?? "English")</span> *@
                @*     </button> *@
                @*     <ul class="dropdown-menu" aria-labelledby="languageDropdown"> *@
                @*         <li><button class="dropdown-item" onclick="@(() => SetLanguage("en-US"))">English</button></li> *@
                @*         <li><button class="dropdown-item" onclick="@(() => SetLanguage("hi-IN"))">Hindi</button></li> *@
                @*         <li><button class="dropdown-item" onclick="@(() => SetLanguage("ta-IN"))">Tamil</button></li> *@
                @*     </ul> *@
                @* </div> *@
                <li class="nav-item">
                    <i class="fi fi-rr-cloud-download-alt fs-3" style="cursor: pointer" @onclick="() => ExportDB()"></i>
                </li>
                <li class="nav-item">
                    <div class="badge badge-outline badge-info">
                        @version_code
                    </div>
                </li>
                <li class="nav-item user-dropdown dropdown">
                    <a class="nav-link d-flex align-items-center dropdown-toggle" href="#" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="user-panel d-flex align-items-center">
                            <div class="image avatar-latter color5">
                                @short_code
                            </div>
                            <div class="info d-none d-sm-block">
                                <div class="info">
                                    <div class="info-name">@full_name</div>
                                    <small>@SessionStorage.user_name - @SessionStorage.role_name</small>
                                </div>
                            </div>
                        </div>
                    </a>
                    <ul class="dropdown-menu rounded-3" aria-labelledby="languageDropdown">
                        <li>
                            <a class="dropdown-item notify-item text-center mt-0" onclick="@Logout"><i class="fi fi-ss-sign-out-alt align-middle me-2"></i> Logout</a>
                        </li>
                    </ul>
                </li>
                @* <ThemeSwitcher /> *@
            </ul>
        </div>
        <article class="bg-light pb-2 mb-1">
            @Body
        </article>
    </main>
</div>

<BlazoredToasts />
<Preload LoadingText="Loading...." />
<Modal IsServiceModal="true" />

@code {
    private CommonQueries CommonQueries = new CommonQueries();
    string version_code = "V " + CommonConfig.APP_VERSION;
    string full_name = SessionStorage.full_name;
    string short_code = "";
    NetworkService common = new NetworkService();
    CommonFunction commonfuncs = new();

    protected override void OnInitialized()
    {
        try
        {
            var name = SessionStorage.full_name;
            var splitted_name = name.Split(" ");
            if (splitted_name.Length > 1)
            {
                short_code = splitted_name[0].Substring(0, 1).ToUpper() + splitted_name[1].Substring(0, 1).ToUpper();
            }
            else
            {
                short_code = name.Substring(0, 2).ToUpper();
            }
            StateHasChanged();
            return;
        }
        catch (Exception ex)
        {
            return;
        }
    }

    async Task ExportDB()
    {
        var message = await commonfuncs.Export();
        if (string.IsNullOrEmpty(message))
        {
            ToastService.ShowError("Failed to EXPORT DB");
            return;
        }
        else
        {
            if (message.Contains(CommonConstants.FAILURE_TEXT))
            {
                ToastService.ShowError(message);
                return;
            }
            else
            {
                ToastService.ShowSuccess(message);
                return;
            }
        }
        return;
    }

    async Task Logout()
    {
        if (!commonfuncs.checkHasInternet())
        {
            ToastService.ShowWarning("No Internet Connection. Please try again when you're back online!");
            return;
        }
        preloadService.Show(SpinnerColor.Light, "Logout in progress...");
        Tbl_User_Details? deleteduserinfo = await CommonQueries.GetUserDetailsAsync()!;
        if (deleteduserinfo == null)
        {
            preloadService.Hide();
            ToastService.ShowError("Error occured while deleting user data. unable to logout! please try again.");
            return;
        }
        var LogoutResponse = await common.LogoutService(deleteduserinfo.username);
        if (LogoutResponse!= null && LogoutResponse.IsSuccessStatusCode)
        {
            SessionStorage.ClearSession();
            var response = await CommonQueries.DeleteUserData();
            if (response == 0)
            {
                preloadService.Hide();
                ToastService.ShowError("Error occured while deleting user data. unable to logout! please try again.");
                return;
            } 
            preloadService.Hide();
            NavigationManager.NavigateTo("/login", replace: true);
        }
        else
        {
            preloadService.Hide();
            ToastService.ShowError("Logout from server Unsucessful! please try again.");
            return;
        }
    }
}
