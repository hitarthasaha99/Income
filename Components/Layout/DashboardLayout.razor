@using Income.Database.Models.Common
@using Income.Database.Queries
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IToastService ToastService
@inject PreloadService preloadService

<div class="page p-0 w-100">
    <main class="px-0 py-0 w-100">
        <div class="navbar m-0 p-0 w-100">
            <div class="appHeader">
                <div class="navbar-brand d-flex align-items-center">
                    <img src="images/nsso75logo.svg" alt="TRAVEL" title="Travel" height="48" class="border-right pe-3" />
                    <h4 class="m-0 d-none d-sm-block site-survayname"><b>Household Income Survey</b></h4>
                </div>
                <div class="d-flex ms-auto align-items-center">
                    @* <div class="dropdown"> *@
                    @*     <button class="btn btn-outline-secondary  dropdown-toggle d-flex align-items-center" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false"> *@
                    @*         <i class="fi fi-rr-language-exchange me-2" style="font-size:25px; line-height:0px;"></i> <span class="d-none d-sm-block">@(language.Resources.LanguageName ?? "English")</span> *@
                    @*     </button> *@
                    @*     <ul class="dropdown-menu" aria-labelledby="languageDropdown"> *@
                    @*         <li><button class="dropdown-item" onclick="@(() => SetLanguage("en-US"))">English</button></li> *@
                    @*         <li><button class="dropdown-item" onclick="@(() => SetLanguage("hi-IN"))">Hindi</button></li> *@
                    @*         <li><button class="dropdown-item" onclick="@(() => SetLanguage("ta-IN"))">Tamil</button></li> *@
                    @*     </ul> *@
                    @* </div> *@
                    <div><i class="bi bi-database-fill-down me-2 fs-20 text-primary" style="cursor: pointer" @onclick="()=> ExportDB()"></i></div>
                    <span class="badge bg-light-primary text-primary me-3">
                        @version_code
                    </span>
                    <div class="dropdown">
                        <a class="nav-link d-flex align-items-center dropdown-toggle" href="#" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-panel d-flex">
                                <div class="image avatar-latter color1 bg-custom-cyan">
                                    @short_code
                                </div>
                                <div class="info d-none d-sm-block">
                                    <small class="m-0 text-muted">Welcome ! <strong>@full_name</strong></small>
                                    <strong class="d-block" style="line-height: 12px;">@SessionStorage.user_name - @SessionStorage.role_name</strong>
                                </div>
                            </div>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                            <li><a class="dropdown-item" onclick="@Logout"><i class="fi fi-rc-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </div>
                    @* <ThemeSwitcher /> *@
                </div>
            </div>
        </div>
        <article class="bg-light pb-2 mb-1">
            @Body
        </article>
    </main>
</div>

<BlazoredToasts />
<Preload LoadingText="Loading...." />
<Modal IsServiceModal="true" />

@code {
    private CommonQueries CommonQueries = new CommonQueries();
    string version_code = "V" + VersionTracking.CurrentVersion;
    string full_name = SessionStorage.full_name;
    string short_code = "";
    NetworkService common = new NetworkService();
    CommonFunction commonfuncs = new();

    protected override void OnInitialized()
    {
        try
        {
            var name = SessionStorage.full_name;
            var splitted_name = name.Split(" ");
            if (splitted_name.Length > 1)
            {
                short_code = splitted_name[0].Substring(0, 1).ToUpper() + splitted_name[1].Substring(0, 1).ToUpper();
            }
            else
            {
                short_code = name.Substring(0, 2).ToUpper();
            }
            StateHasChanged();
            return;
        }
        catch (Exception ex)
        {
            return;
        }
    }

    async Task ExportDB()
    {
        var message = await commonfuncs.Export();
        if (string.IsNullOrEmpty(message))
        {
            ToastService.ShowError("Failed to EXPORT DB");
            return;
        }
        else
        {
            if (message.Contains(CommonConstants.FAILURE_TEXT))
            {
                ToastService.ShowError(message);
                return;
            }
            else
            {
                ToastService.ShowSuccess(message);
                return;
            }
        }
        return;
    }

    async Task Logout()
    {
        if (!commonfuncs.checkHasInternet())
        {
            ToastService.ShowWarning("No Internet Connection. Please try again when you're back online!");
            return;
        }
        preloadService.Show(SpinnerColor.Light, "Logout in progress...");
        Tbl_User_Details? deleteduserinfo = await CommonQueries.GetUserDetailsAsync()!;
        if (deleteduserinfo == null)
        {
            preloadService.Hide();
            ToastService.ShowError("Error occured while deleting user data. unable to logout! please try again.");
            return;
        }
        var LogoutResponse = await common.LogoutService(deleteduserinfo.username);
        if (LogoutResponse!= null && LogoutResponse.IsSuccessStatusCode)
        {
            SessionStorage.ClearSession();
            var response = await CommonQueries.DeleteUserData();
            if (response == 0)
            {
                preloadService.Hide();
                ToastService.ShowError("Error occured while deleting user data. unable to logout! please try again.");
                return;
            } 
            preloadService.Hide();
            NavigationManager.NavigateTo("/login", replace: true);
        }
        else
        {
            preloadService.Hide();
            ToastService.ShowError("Logout from server Unsucessful! please try again.");
            return;
        }
    }
}
