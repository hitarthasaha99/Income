@using Income.Database.Models.Common
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject PreloadService preloadService

<div>
    <div class="d-flex mb-2 mt-2">
        <i class="bi bi-arrow-left me-2" style="font-size: 20px; cursor: pointer;" @onclick="() => GoBack()"></i>
        <div class="d-flex">
            <p style="font-weight: bold; font-size: 20px;" class="mt-0 mb-0 me-2">FSUID: @SelectedFsuId</p>
            @if (SessionStorage.selected_hhd_id != 0)
            {
                <p style="font-weight: bold; font-size: 20px;" class="m-0">HHD ID: @SessionStorage.selected_hhd_id</p>
            }
        </div>
    </div>   
    <div class="card-style2 card" hidden="@((ShowVisitedBlock == true ? false : true))">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div class="d-flex text-start">
                <i style="font-size: 35px;" class="bi bi-geo-alt-fill text-danger"></i>
                <div class="ms-2">
                    <label class="form-label fs-13 mb-0">Coordinate</label>
                    <p style="font-weight: bold;">@location</p>
                </div>
            </div>
            <div class="d-flex text-start">
                <i style="font-size: 35px;" class="bi bi-clock-fill text-success"></i>
                <div class="ms-2">
                    <label class="form-label fs-13 mb-0">Timestamp</label>
                    <p style="font-weight: bold;">@SessionStorage.survey_timestamp</p>
                </div>
            </div>
            @if (ShowVisitedBlock) 
            { 
                <div class="form-group w-25">
                    <label class="form-label fs-13 mb-0">Switch To Visited Block</label>
                    <select class="form-select form-select-sm w-100" id="exampleFormControlSelect1" @onchange="@((ChangeEventArgs e) => HandleBlockNavigation(e))">
                        <option value="">Select</option>
                        @if (visited_Blocks != null && visited_Blocks.Count > 0)
                        {
                            foreach (var item in visited_Blocks)
                            {
                                <option value="@item.block_uri">@item.block_title</option>
                            }
                        }
                    </select>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int SelectedFsuId { get; set; }
    [Parameter]
    public DateTime? survey_time { get; set; } = SessionStorage.survey_timestamp;    
    [Parameter]
    public string? page_name { get; set; } = string.Empty;
    [Parameter]
    public bool ShowVisitedBlock { get; set; } = true;
    CommonQueries commonQueries = new CommonQueries();
    List<Tbl_Visited_Blocks>? visited_Blocks = new();
    int hhd_id = SessionStorage.selected_hhd_id;
    string location = SessionStorage.location;
    string dateTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
    CommonFunction funcs = new();

    protected override async Task OnParametersSetAsync()
    {
        StateHasChanged();
        return;
    }

    async Task GoBack()
    {
        if (string.IsNullOrEmpty(page_name))
        {
            await JSRuntime.InvokeVoidAsync("__handleGoBack");
            return;
        }
        NavigationManager.NavigateTo(page_name);
        return;
    }
    protected override async Task OnInitializedAsync()
    {
        visited_Blocks = new();
        var result = await commonQueries.GetVisitedBlocks()!;
        SelectedFsuId = SessionStorage.SelectedFSUId;
        if (result != null && result.Count > 0)
        {
            visited_Blocks = result;
        }
        dateTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");

        if (string.IsNullOrEmpty(SessionStorage.location) && ShowVisitedBlock == true)
        {
            preloadService.Show(SpinnerColor.Light, "Fetching Location Details...");
            location = await funcs.fetchGeoLocation();
        }
        else
        {
            location = SessionStorage.location;
        }
        preloadService.Hide();
        StateHasChanged();
        return;
    }

    void HandleBlockNavigation(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value.ToString()))
        {
            return;
        }
        var blockUri = e.Value.ToString();
        NavigationManager.NavigateTo(blockUri);
        return;
    }
}
