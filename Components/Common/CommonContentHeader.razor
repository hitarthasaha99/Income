@using Income.Database.Models.Common
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject PreloadService preloadService

<div>
    <div class="d-flex align-items-center my-3">
        <i class="fi fi-rr-arrow-left me-2 fs-5" style="cursor:pointer;" @onclick="() => GoBack()"></i>
        <div class="d-flex">
            <h3 class="page-heading m-0">FSUID: @SelectedFsuId</h3>
            @if (SessionStorage.selected_hhd_seq != 0)
            {
                <h3 class="page-heading m-0 ms-2">SSS: @SessionStorage.sss</h3>
                <h3 class="page-heading m-0 ms-2">Selected HHD No: @SessionStorage.selected_hhd_seq</h3>
                <h3 class="page-heading m-0 ms-2">HHD Head Name: @SessionStorage.hhd_head</h3>
            }
        </div>
    </div>
    <div class="card custom-card" hidden="@((ShowVisitedBlock == true ? false : true))">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-start">
                <i class="fi fi-ss-marker text-danger fs-3"></i>
                <div class="ms-2">
                    <label class="form-label">Coordinate</label>
                    <p class="mb-0 fw-bolder">
                        @if (isLocationLoading)
                        {
                            // Display a simple inline indicator (using a common Bootstrap spinner and text)
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                            <span>Loading...</span>
                        }
                        else
                        {
                            @location
                        }
                    </p>
                </div>
            </div>
            <div class="d-flex align-items-start">
                <i class="fi fi-ss-clock-five text-success fs-3"></i>
                <div class="ms-2">
                    <label class="form-label">Timestamp</label>
                    <p class="mb-0 fw-bolder">@Time</p>
                </div>
            </div>
            @if (ShowVisitedBlock)
            {
                <div class="form-group w-25">
                    <label class="form-label">Switch To Visited Block</label>
                    <select class="form-select form-select-sm w-100" id="exampleFormControlSelect1" @onchange="@((ChangeEventArgs e) => HandleBlockNavigation(e))">
                        <option value="">Select</option>
                        @if (visited_Blocks != null && visited_Blocks.Count > 0)
                        {
                            foreach (var item in visited_Blocks)
                            {
                                <option value="@item.block_uri">@item.block_title</option>
                            }
                        }
                    </select>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int SelectedFsuId { get; set; }
    [Parameter]
    public DateTime? survey_time { get; set; }
    [Parameter]
    public string? page_name { get; set; } = string.Empty;
    [Parameter]
    public bool ShowVisitedBlock { get; set; } = true;

    // 1. New variable for location loading state
    private bool isLocationLoading = false;

    CommonQueries commonQueries = new CommonQueries();
    List<Tbl_Visited_Blocks>? visited_Blocks = new();
    int hhd_id = SessionStorage.selected_hhd_id;
    string location = SessionStorage.location;
    [Parameter]
    public string Time { get; set; } = string.Empty;
    [Parameter]
    public EventCallback OnGoBack { get; set; }
    CommonFunction funcs = new();

    protected override async Task OnParametersSetAsync()
    {
        // No change needed here for this problem
        Time = survey_time.HasValue
        ? survey_time.Value.ToString("dd-MM-yyyy HH:mm:ss")
        : string.Empty;

        StateHasChanged();
        return;
    }

    async Task GoBack()
    {
        if (OnGoBack.HasDelegate)
        {
            await OnGoBack.InvokeAsync();
            return;
        }
        if (string.IsNullOrEmpty(page_name))
        {
            await JSRuntime.InvokeVoidAsync("__handleGoBack");
            return;
        }
        NavigationManager.NavigateTo(page_name);
        return;
    }

    protected override async Task OnInitializedAsync()
    {
        // **Part 1: Initial/Quick Load (Visited Blocks and Time)**
        visited_Blocks = new();
        // This is kept synchronous or quick to load initially
        var result = await commonQueries.GetVisitedBlocks()!;
        SelectedFsuId = SessionStorage.SelectedFSUId;
        if (result != null && result.Count > 0)
        {
            visited_Blocks = result;
        }
        //Time = survey_time != null ? survey_time.GetValueOrDefault().ToString("dd-MM-yyyy HH:mm:ss") : DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss");

        // **Part 2: Asynchronous Location Load**
        if (string.IsNullOrEmpty(SessionStorage.location) && ShowVisitedBlock == true)
        {
            // 2. Set loading state to true and immediately call StateHasChanged()
            isLocationLoading = true;
            StateHasChanged(); // Update the UI to show the 'Loading...' spinner

            // 3. Remove the full-page preloadService calls
            // preloadService.Show(SpinnerColor.Light, "Fetching Location Details..."); // REMOVED

            location = await funcs.fetchGeoLocation(); // Start fetching location
            SessionStorage.location = location;
            // 4. Update the location and set loading state back to false
            isLocationLoading = false;
        }
        else
        {
            location = SessionStorage.location;
        }

        // 5. Remove the full-page preloadService.Hide()
        // preloadService.Hide(); // REMOVED

        // 6. Ensure final UI update after location is fetched (if it was loading)
        StateHasChanged();
        return;
    }

    void HandleBlockNavigation(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value.ToString()))
        {
            return;
        }
        var blockUri = e.Value.ToString();
        if (blockUri == "/dashboard/sch0.0/block_3")
        {
            blockUri = "/dashboard/sch0.0/block_3/false";
        }
        else if (blockUri == "/dashboard/sch0.0/block_6")
        {
            blockUri = "/dashboard/sch0.0/block_3/true";
        }
        NavigationManager.NavigateTo(blockUri);
        return;
    }

    public async Task ReloadVisitedBlocksAsync()
    {
        var result = await commonQueries.GetVisitedBlocks();

        visited_Blocks = result ?? new List<Tbl_Visited_Blocks>();

        StateHasChanged();
    }
}