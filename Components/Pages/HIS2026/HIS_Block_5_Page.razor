@page "/dashboard/his/block_5"
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@using FluentValidation
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Database.Models.SCH0_0
@using Income.Viewmodels
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JSRuntime
@inject ILoggingService loggingService
@inject Warning_VM warningVM
@* @inject DBQueries DBQueries *@

<div class="main-content">
    <CommonContentHeader SelectedFsuId="@SelectedFsuId" survey_time="@survey_time" />
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary me-2">[Block 5]</span>Income from employment – regular wage/salary
            </h3>
            <div class="card-tools">
                <div class="d-flex align-items-center" hidden="@SessionStorage.FSU_Submitted">
                    @*  <button class="btn btn-outline-primary me-2" @onclick="@(() => Generate())">
                        <i class="fi fi-rr-settings me-1"></i>Generate
                    </button> *@
                    <button class="btn btn-primary" @onclick="@(() => HandleModal("ADD"))">
                        <i class="fi fi-rr-plus me-1"></i>Add
                    </button>
                </div>

            </div>
        </div>
        @* Card Body *@
        <div class="card-body p-0">
            <div class="table-responsive table-wrapper">
                <table class="table table-striped table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Q.no.</th>
                            <th>Question description</th>
                            <th>
                                Reference Period
                            </th>
                        </tr>
                        <tr>
                            <th>Q5.1</th>
                            <th>Number of months worked</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
<Modal @ref="AddModal"
       CloseOnEscape="false"
       UseStaticBackdrop="true"
       ShowCloseButton="false"
       Fullscreen="ModalFullscreen.MediumDown">

    <HeaderTemplate>
        <h5 class="modal-title">@((isAdd ? "Add Member" : "Update Member"))</h5>
    </HeaderTemplate>

    <BodyTemplate>
        <EditForm Model="@newMember">
            <div class="modal-body">
                @* <h4>Question description</h4> *@

                <div class="container-fluid">
                    <div class="row">
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2">Q5.1</span> Number of months worked (Last 365 days)
                            </label>
                            <InputNumber @bind-Value="newMember.item_2"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         min="1" max="12"
                                         maxlength="2"
                                         @oninput="item2OnInput"
                                         onkeypress="if (this.value.length >= 2) return false; return event.key >= '0' && event.key <= '9';">
                            </InputNumber>
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2">Q5.2</span> gross salary(Last month)
                            </label>
                            <InputNumber @bind-Value="newMember.item_3"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_3 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">
                            </InputNumber>
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <div class="d-flex flex-column">
                                    @* //Q5.3(i) *@
                                    <span class="me-2">Q5.3</span> <span>i) allowances received (including overtime allowance, shift allowance, project allowance) (Last month)</span>
                                </div>
                            </label>
                            <InputNumber @bind-Value="newMember.item_4"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_4 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">
                            </InputNumber> 
                            @* <input type="number" class="form-control no-spinner form-control-sm" value="@newMember.item_4" @oninput="e => { newMember.item_4 = int.TryParse(e.Value?.ToString(), out var v) ? v : 0; handleCalculateIncome(); }" /> *@
                        
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2">ii) Other including tips, fees of consultants etc. (Last month)</span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_5"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_5 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                         
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2"> <span>Q5.4</span>i) bonuses received (festival bonus, profit-sharing or production bonuses or other forms of profit-related payment, performance-based incentive)(Last 365 days)</span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_6"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_6 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                         
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2">ii) other including commission from sales, etc. (Last 365 days)</span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_7"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_7 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                         
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2"> <span>Q5.5</span>sale value of shares offered as part of employee remuneration (employee stock option)(Last 365 days)</span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_8"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_8 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                         
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2"> <span>Q5.6</span>leave encashments; remuneration for time not worked such as for annual leave, holidays or other paid leave, Leave Fare Concession etc.(Last 365 days)</span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_9"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_9 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                        
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2"> <span>Q5.7</span>severance and termination pay, termination benefits including social security benefits like maturity benefits of CGEGIS etc.(Last 365 days) </span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_10"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_10 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                        
                        </div>
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2"> <span>Q5.8</span>others - directors’ fees (fees given to the directors for attending meetings), sitting fees of experts etc. (Last 365 days) </span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_11"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         @oninput="e => { newMember.item_11 = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? (int?)null : int.TryParse(e.Value?.ToString(), out var v) ? v : (int?)null; handleCalculateIncome(); }">

                            </InputNumber>
                          
                        </div>
                        @* //Calculate Ans *@
                        <div>
                            <label class="form-label fw-bold d-flex align-items-start">
                                <span class="me-2"> Total monthly income (Q5.1+Q5.2+(Q5.3+Q5.4+Q5.5+Q5.6+Q5.7+Q5.8)/12) </span>
                            </label>
                            <InputNumber @bind-Value="newMember.item_12"
                                         class="form-control no-spinner form-control-sm"
                                         autocomplete="off"
                                         onkeypress="return event.key >= '0' && event.key <= '9'"
                                         autocorrect="off"
                                         autocapitalize="off"
                                         spellcheck="false"
                                         readonly>
                            </InputNumber>

                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
    </BodyTemplate>

    <FooterTemplate>
        <button class="btn btn-secondary"
                @onclick="(() => HandleModal())">
            Close
        </button>

        <button class="btn btn-primary"
                @onclick="HandleAddMember">
            Save
        </button>

    </FooterTemplate>

</Modal>


@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    private CommonConfig commonConfig = new CommonConfig();
    DateTime survey_time = DateTime.Now;
    private Tbl_Block_5 newMember = new();
    private List<Tbl_Block_5> block5Members = new();
    bool error = false;
    DBQueries dbq = new();

    Modal AddModal = default!;
    bool isAdd = false;

    private void item2OnInput(ChangeEventArgs e)
    {
        // Convert input value
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            if (value > 12)
                newMember.item_2 = 12;
            else if (value < 1)
                newMember.item_2 = 1;
            else
                newMember.item_2 = value;
        }
        else
        {
            newMember.item_2 = null;
        }

        handleCalculateIncome();
    }




    //Handle CalculateIncome
    private void handleCalculateIncome()
    {
        // int item_2 = newMember.item_2 ?? 0;
        int item_3 = newMember.item_3 ?? 0; //5.2
        int item_4 = newMember.item_4 ?? 0; //5.3(i)
        int item_5 = newMember.item_5 ?? 0; //5.3(ii)
        int item_6 = newMember.item_6 ?? 0; //5.4(i)
        int item_7 = newMember.item_7 ?? 0; //5.4(ii)
        int item_8 = newMember.item_8 ?? 0; //5.5
        int item_9 = newMember.item_9 ?? 0; //5.6
        int item_10 = newMember.item_10 ?? 0; //5.7
        int item_11 = newMember.item_11 ?? 0; //5.8


        int ans = (item_6 + item_7 + item_8 + item_9 + item_10 + item_11) / 12 + item_3 + item_4 + item_5 ;
        newMember.item_12 = ans;
        StateHasChanged();
    }

    async Task HandleModal(string action = "", Tbl_Block_5? data = null)
    {
        try
        {
            if (action == "ADD")
            {
                isAdd = true;

                newMember = new Tbl_Block_5
                {
                    id = Guid.NewGuid(),
                    item_1 = ReturnCurrentMemberSerialNumber()
                };

                await AddModal.ShowAsync();
            }
            else if (action == "UPDATE")
            {
                isAdd = false;

                if (data != null)
                {
                    newMember = data; // or clone if required
                    await AddModal.ShowAsync();
                }
            }
            else
            {
                await AddModal.HideAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    int ReturnCurrentMemberSerialNumber()
    {
        try
        {
            return (block5Members?.Count ?? 0) + 1;
        }
        catch
        {
            return 1;
        }
    }


    private async Task LoadData()
    {
        block5Members = await dbq.Fetch_SCH_HIS_Block5(SessionStorage.selected_hhd_id);
        StateHasChanged();
    }



    private async Task HandleAddMember()
    {

        // Validate();

        if (error)
        {
            toastService.ShowError("Please resolve pending errors");
            return;
        }

        await dbq.Save_SCH_HIS_Block5(newMember);
        toastService.ShowSuccess("Member added successfully!");
        await AddModal.HideAsync();
        await LoadData();

    }

    async void HandleSubmit(string action = "")
    {
        NavigationManager.NavigateTo("/dashboard/his/block_4_1");
    }
}
