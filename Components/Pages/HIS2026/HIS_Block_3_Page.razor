@page "/dashboard/his/block_3"
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@using FluentValidation
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Viewmodels
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JSRuntime
@inject ILoggingService loggingService
@inject Warning_VM warningVM


<div class="main-content">
    <!-- Header component showing selected FSU and survey time -->
    <CommonContentHeader SelectedFsuId="@SelectedFsuId" survey_time="@survey_time" />
    <div class="card custom-card">
        <!-- 🔹 Sticky Top Action Header -->
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary me-2">[Block 3]</span>demographic and other particulars of household members
            </h3>
            <div class="card-tools">
                <div class="d-flex align-items-center" hidden="@SessionStorage.FSU_Submitted">
                   @*  <button class="btn btn-outline-primary me-2" @onclick="@(() => Generate())">
                        <i class="fi fi-rr-settings me-1"></i>Generate
                    </button> *@
                    <button class="btn btn-primary" @onclick="@(() => HandleModal("ADD"))">
                        <i class="fi fi-rr-plus me-1"></i>Add
                    </button>
                </div>

            </div>
        </div>
        <!-- Scrollable table -->
        <div class="card-body p-0">
            <div class="table-responsive table-wrapper">
                <!-- Table displaying household members -->
                <table class="table table-striped table-bordered mb-0">
                    <thead>
                        <tr>
                            <th rowspan="3">s.no.</th>
                            <th rowspan="3">name of member</th>
                            <th rowspan="3">relation to head(code)</th>
                            <th rowspan="3">gender(code)</th>
                            <th rowspan="3">age (years)</th>
                            <th rowspan="3">marital status(code)</th>
                            <th rowspan="3">highest educational level attained(code)</th>
                            <th colspan="4">activity status</th>
                            <th rowspan="3" style="min-width:200px">whether a beneficiary of any Central/State Government social assistance scheme as on date of survey(<i>yes-1/no-2</i>)</th>
                            <th rowspan="3">action</th>
                        </tr>
                        <tr>
                            <th colspan="2">during 30 days</th>
                            <th colspan="2">during 365 days</th>
                        </tr>
                        <tr>
                            <th>primary(code)</th>
                            <th>secondary(code)</th>
                            <th>primary(code)</th>
                            <th>secondary(code)</th>
                        </tr>
                        <tr>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                            <th>(5)</th>
                            <th>(6)</th>
                            <th>(7)</th>
                            <th>(8)</th>
                            <th>(9)</th>
                            <th>(10)</th>
                            <th>(11)</th>
                            <th>(12)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var member in block3Members)
                        {
                            <tr>
                                <td>@member.serial_no</td>
                                <td>@member.item_2</td>
                                <td>@member.item_3</td>
                                <td>@member.gender</td>
                                <td>@member.age</td>
                                <td>@member.item_6</td>
                                <td>@member.item_7</td>
                                <td>@member.item_8</td>
                                <td>@member.item_9</td>
                                <td>@member.item_10</td>
                                <td>@member.item_11</td>
                                <td>@(member.item_12 == 1 ? "Yes" : "No")</td>
                                <td class="d-flex align-items-center">
                                    <button class="btn btn-link me-3 fs-6"
                                            hidden="@SessionStorage.FSU_Submitted"
                                            @onclick="@(() => HandleModal("UPDATE", member))">
                                        <i class="fi fi-rr-pencil"></i>
                                    </button>
                                    <button class="btn btn-link fs-6 text-danger"
                                            hidden="@SessionStorage.FSU_Submitted"
                                            @onclick="@(() => HandleDelete(member.id))">
                                        <i class="fi fi-rr-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Remarks textarea -->
    <div class="mb-3 px-2">
        <label for="remarksTextarea" class="form-label">Remarks</label>
        <textarea class="form-control" id="remarksTextarea" rows="3" placeholder="Enter remarks here"></textarea>
    </div>
</div>
<!-- 🔹 Footer Navigation (Always visible) -->
<div class="footer">
    <div class="row">
        <div class="col-sm-6">
            <div class="d-flex">
                <NavLink class="btn btn-outline-secondary" onclick="@GoBack">
                    <i class="fi fi-rr-angle-left me-1"></i>Back
                </NavLink>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                <NavLink class="btn btn-primary" @onclick="@(() => HandleSubmit("NEXT"))">
                    Next<i class="fi fi-rr-angle-right ms-1"></i>
                </NavLink>
            </div>
        </div>
    </div>
</div>
    

<Modal @ref="AddModal" CloseOnEscape="false" UseStaticBackdrop="true" ShowCloseButton="false" Size="ModalSize.ExtraLarge" Fullscreen="ModalFullscreen.MediumDown">
    <HeaderTemplate>
        <h5 class="modal-title">@((isAdd ? "Add Member" : "Update Member"))</h5>
    </HeaderTemplate>
    <BodyTemplate>
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <EditForm Model="@newMember">

                    <div class="modal-header">
                        <h5 class="modal-title" id="addModalLabel">Add Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- Sl no input (readonly) -->
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">1.</span> Sl no.
                                    </label>
                                    <input type="text" class="form-control form-control-sm" value="@(newMember.serial_no)" disabled />
                                </div>

                                <!-- Name of Member input -->
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">2.</span> Name of Member
                                    </label>
                                    <InputText class="form-control form-control-sm" @bind-Value="newMember.item_2" placeholder="Enter Name of member" @oninput="ClearNameError" />
                                    @if (!string.IsNullOrEmpty(nameError))
                                    {
                                        <small class="text-danger">@nameError</small>
                                    }
                                </div>

                                <!-- Relation to head select -->
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">3.</span> Relation to head (code)
                                    </label>
                                    <select class="form-select form-select-sm" value="@newMember.item_3" @onchange="item_3_changed">
                                        <option value="">-Select-</option>
                                        <option value="1">self-1</option>
                                        <option value="2">spouse of head-2</option>
                                        <option value="3">married child-3</option>
                                        <option value="4">spouse of married child-4</option>
                                        <option value="5">unmarried child-5</option>
                                        <option value="6">grandchild-6</option>
                                        <option value="7">father/mother/father-in-law/mother-in-law-7</option>
                                        <option value="8">brother/sister/brother-in-law/sister-in-law/other relatives-8</option>
                                        <option value="9">servants/employees/other non-relatives-9 </option>
                                    </select>
                                    @if (!string.IsNullOrEmpty(relationError))
                                    {
                                        <small class="text-danger">@relationError</small>
                                    }
                                </div>

                                <!-- Gender select -->
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">4.</span> Gender (code)
                                    </label>
                                    <select class="form-select form-select-sm" value="@newMember.gender" @onchange= "genderClear">
                                        <option value="">-Select-</option>
                                        <option value="1">male-1</option>
                                        <option value="2">female-2</option>
                                        <option value="3">transgender-3</option>
                                    </select>
                                    @if (!string.IsNullOrEmpty(genderError))
                                    {
                                        <small class="text-danger">@genderError</small>
                                    }
                                    @if (!string.IsNullOrEmpty(genderWarning))
                                    {
                                        <div class="text-success" role="alert">@genderWarning</div>
                                    }

                                </div>


                                <!-- Age input -->
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">5.</span> Age(years)
                                    </label>
                                    <InputNumber class="form-control form-control-sm" @bind-Value="newMember.age" @onchange="ageClear" />
                                    @if (!string.IsNullOrEmpty(ageError))
                                    {
                                        <small class="text-danger">@ageError</small>
                                    }
                                    @if (!string.IsNullOrEmpty(ageWarning))
                                    {
                                        <small class="text-success">@ageWarning</small>
                                    }
                                    <!-- For education-age warnings -->
                                    @if (!string.IsNullOrEmpty(eduAgeWarning))
                                    {
                                        <div class="text-success">@eduAgeWarning</div>
                                    }
                                </div>

                                <!-- Marital status select -->
                                <div class="col-sm-6 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">6.</span> Marital status (code)
                                    </label>
                                    <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_6" @oninput="clearItem_6">
                                        <option value="">-Select-</option>
                                        <option value="1">never married – 1</option>
                                        <option value="2">currently married (including living together) – 2</option>
                                        <option value="3">widowed – 3</option>
                                        <option value="4">divorced/separated – 4</option>
                                    </InputSelect>
                                    @if (!string.IsNullOrEmpty(item_6Error))
                                    {
                                        <small class="text-danger">@item_6Error</small>
                                    }
                                    @if (!string.IsNullOrEmpty(maritalStatusWarning))
                                    {
                                        <small class="text-success">@maritalStatusWarning</small>
                                    }
                                </div>

                                <!-- Highest education level select -->
                                <div class="col-sm-12 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">7.</span> Highest level of complete education (code)
                                    </label>
                                    <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_7" @oninput="ClearItem7">
                                        <option value="">-Select-</option>
                                        <option value="1">not literate (i.e. not able to read or write a simple message with understanding in any language) -01 </option>
                                        <option value="2">literate without formal schooling (like NFEC, AEC, TLC, literate without any schooling, etc.)-02 </option>
                                        <option value="3">literate with formal education below primary-03 </option>
                                        <option value="4">primary -04 </option>
                                        <option value="5">upper primary/middle -05 </option>
                                        <option value="6">secondary -06 </option>
                                        <option value="7">higher secondary -07 </option>
                                        <option value="8">diploma /certificate course - 08 </option>
                                        <option value="9">graduate -10 </option>
                                        <option value="10">postgraduate and above - 11 </option>
                                    </InputSelect>
                                    @if (!string.IsNullOrEmpty(item_7Error))
                                    {
                                        <small class="text-danger">@item_7Error</small>
                                    }
                                    @if (!string.IsNullOrEmpty(eduAgeWarning))
                                    {
                                        <div class="text-success">@eduAgeWarning</div>
                                    }

                                </div>

                                <!-- Activity status during 30 days -->
                                <h4>Activity status (During 30 days)</h4>
                                <div class="row">
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2">8.</span> Primary
                                        </label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_8" @oninput="ClearItem8">
                                            <option value="">-Select-</option>
                                            <option value="1">self-employed in agriculture (own account worker/employer) - 01 </option>
                                            <option value="2">self-employed in non- agriculture (own account worker/employer) – 02 </option>
                                            <option value="3">unpaid family worker in agriculture or non-agriculture – 03 </option>
                                            <option value="4">regular wage/ salary – 04 </option>
                                            <option value="5">casual labour – 05 </option>
                                            <option value="6">did not work but was seeking and/or available for work – 06 </option>
                                            <option value="7">student / attended educational institution - 07 </option>
                                            <option value="8">attended domestic duties only – 08 </option>
                                            <option value="9">attended domestic duties and was also engaged in free collection of goods (vegetables, roots, firewood, cattle feed, etc.), sewing, tailoring, weaving, etc. for household use - 09 </option>
                                            <option value="10">earning from rent – 10 </option>
                                            <option value="11">earning from pensions -11 </option>
                                            <option value="12">earning from remittances -12 </option>
                                            <option value="13">earning from interest - 13 </option>
                                            <option value="14">unfit for work due to disability or illness – 14 </option>
                                            <option value="15">others (including children not attending school, begging, prostitution, etc.) – 15 </option>
                                        </InputSelect>
                                        @if (!string.IsNullOrEmpty(item_8Error))
                                        {
                                            <small class="text-danger">@item_8Error</small>
                                        }
                                        @if (!string.IsNullOrEmpty(item_8Warning))
                                        {
                                            <div class="text-success">@item_8Warning</div>
                                        }
                                    </div>
                                    @* Item9 *@
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2">9.</span> Secondary
                                        </label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_9" @oninput="ClearItem9">
                                            <option value="">-Select-</option>
                                            <!-- Same options as above -->
                                            <option value="1">self-employed in agriculture (own account worker/employer) - 01 </option>
                                            <option value="2">self-employed in non- agriculture (own account worker/employer) – 02 </option>
                                            <option value="3">unpaid family worker in agriculture or non-agriculture – 03 </option>
                                            <option value="4">regular wage/ salary – 04 </option>
                                            <option value="5">casual labour – 05 </option>
                                            <option value="6">did not work but was seeking and/or available for work – 06 </option>
                                            <option value="7">student / attended educational institution - 07 </option>
                                            <option value="8">attended domestic duties only – 08 </option>
                                            <option value="9">attended domestic duties and was also engaged in free collection of goods (vegetables, roots, firewood, cattle feed, etc.), sewing, tailoring, weaving, etc. for household use - 09 </option>
                                            <option value="10">earning from rent – 10 </option>
                                            <option value="11">earning from pensions -11 </option>
                                            <option value="12">earning from remittances -12 </option>
                                            <option value="13">earning from interest - 13 </option>
                                            <option value="14">unfit for work due to disability or illness – 14 </option>
                                            <option value="15">others (including children not attending school, begging, prostitution, etc.) – 15 </option>
                                        </InputSelect>
                                        @if (!string.IsNullOrEmpty(item_9Error))
                                        {
                                            <div class="text-danger">
                                                @item_9Error
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(item_9Warning))
                                        {
                                            <div class="text-success">@item_9Warning</div>
                                        }
                                    </div>
                                </div>

                                <!-- Activity status during 365 days -->
                                <h4>Activity status (During 365 days)</h4>
                                <div class="row">
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2">10.</span> Primary
                                        </label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_10" @oninput="ClearItem10">
                                            <option value="">-Select-</option>
                                            <!-- Same options as above for primary -->
                                            <option value="1">self-employed in agriculture (own account worker/employer) - 01 </option>
                                            <option value="2">self-employed in non- agriculture (own account worker/employer) – 02 </option>
                                            <option value="3">unpaid family worker in agriculture or non-agriculture – 03 </option>
                                            <option value="4">regular wage/ salary – 04 </option>
                                            <option value="5">casual labour – 05 </option>
                                            <option value="6">did not work but was seeking and/or available for work – 06 </option>
                                            <option value="7">student / attended educational institution - 07 </option>
                                            <option value="8">attended domestic duties only – 08 </option>
                                            <option value="9">attended domestic duties and was also engaged in free collection of goods (vegetables, roots, firewood, cattle feed, etc.), sewing, tailoring, weaving, etc. for household use - 09 </option>
                                            <option value="10">earning from rent – 10 </option>
                                            <option value="11">earning from pensions -11 </option>
                                            <option value="12">earning from remittances -12 </option>
                                            <option value="13">earning from interest - 13 </option>
                                            <option value="14">unfit for work due to disability or illness – 14 </option>
                                            <option value="15">others (including children not attending school, begging, prostitution, etc.) – 15 </option>
                                        </InputSelect>
                                        @if (!string.IsNullOrEmpty(item_10Error))
                                        {
                                            <div class="text-danger small mt-1">@item_10Error</div>
                                        }
                                        @if (!string.IsNullOrEmpty(item_10Warning))
                                        {
                                            <div class="text-success">@item_10Warning</div>
                                        }
                                    </div>
                                    @* Iter11 *@
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2">11.</span> Secondary
                                        </label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_11" @oninput="ClearItem11">
                                            <option value="">-Select-</option>
                                            <!-- Same options as above for secondary -->
                                            <option value="1">self-employed in agriculture (own account worker/employer) - 01 </option>
                                            <option value="2">self-employed in non- agriculture (own account worker/employer) – 02 </option>
                                            <option value="3">unpaid family worker in agriculture or non-agriculture – 03 </option>
                                            <option value="4">regular wage/ salary – 04 </option>
                                            <option value="5">casual labour – 05 </option>
                                            <option value="6">did not work but was seeking and/or available for work – 06 </option>
                                            <option value="7">student / attended educational institution - 07 </option>
                                            <option value="8">attended domestic duties only – 08 </option>
                                            <option value="9">attended domestic duties and was also engaged in free collection of goods (vegetables, roots, firewood, cattle feed, etc.), sewing, tailoring, weaving, etc. for household use - 09 </option>
                                            <option value="10">earning from rent – 10 </option>
                                            <option value="11">earning from pensions -11 </option>
                                            <option value="12">earning from remittances -12 </option>
                                            <option value="13">earning from interest - 13 </option>
                                            <option value="14">unfit for work due to disability or illness – 14 </option>
                                            <option value="15">others (including children not attending school, begging, prostitution, etc.) – 15 </option>
                                        </InputSelect>
                                        @if (!string.IsNullOrEmpty(item_11Error))
                                        {
                                            <div class="text-danger small mt-1">
                                                @item_11Error
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(item_11Warning))
                                        {
                                            <div class="text-success">@item_11Warning</div>
                                        }
                                    </div>
                                </div>

                                <!-- Item 12 -->
                                <div class="col-sm-12 mb-3">
                                    <label class="form-label fw-bold d-flex align-items-start">
                                        <span class="me-2">12.</span> whether a beneficiary of any Central/ State Government social assistance scheme as on date of survey (yes-1/ no-2)
                                    </label>
                                    <InputSelect class="form-select form-select-sm" @bind-Value="newMember.item_12" @oninput="ClearItem12Error">
                                        <option value="">-Select-</option>
                                        <option value="1">yes-1</option>
                                        <option value="2">no-2</option>
                                    </InputSelect>
                                    @if (!string.IsNullOrEmpty(item_12Error))
                                    {
                                        <div class="text-danger small mt-1">@item_12Error</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <button class="btn btn-outline-secondary me-auto" @onclick="@(() => HandleModal("CLOSE"))">Close</button>
        <button type="submit" @onclick="@(() => HandleAddMember())" class="btn btn-primary" form="YourEditFormId"><i class="fi fi-rr-disk me-1"></i>@((isAdd ? "Save" : "Update"))</button>
    </FooterTemplate>
</Modal>
    
@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    private CommonConfig commonConfig = new CommonConfig();
    DateTime survey_time = DateTime.Now;
    Modal AddModal = default!;
    // List for holding household members data
    private List<Tbl_Block_3>  block3Members = new();
    private Tbl_Block_3 newMember = new Tbl_Block_3();
    private String? nameError = null;
    private string? relationError = null;
    // Errors and warnings for fields
    private string? genderError = null;
    private string? genderWarning = null;

    private string? ageError = null;
    private string? item_6Error = null;
    private string? item_7Error = null;
    private string? item_8Error = null;
    private string? item_9Error = null;
    private string? item_10Error = null;
    private string? item_11Error = null;
    private string? item_12Error = null;
    //Age Warning
    private string? ageWarning = null;
    private string? maritalStatusWarning = null;
    private string? eduAgeWarning = null;
    private string? item_8Warning = null;
    private string? item_9Warning = null;

    private string? item_10Warning = null;
    private string? item_11Warning = null;

    DBQueries DBQueries = new();
    CommonQueries commonQueries = new();
    bool isAdd = false;
    private string? remarks = string.Empty;

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/his/block_3",
            block_title = "HIS Block 3",
            block_code = CommonEnum.sch_0_0_block_7.ToString(),
        };

        await commonQueries.InsertVisitedBlock(vb);
        await LoadData();
        StateHasChanged();
    }

    private async Task LoadData()
    {
        block3Members = await DBQueries.Fetch_SCH_HIS_Block3(SessionStorage.selected_hhd_id);
        StateHasChanged();
    }

    bool error = false;

    private void genderClear(ChangeEventArgs e)
    {
        ClearGenderError();

        var value = e.Value?.ToString();

        if (string.IsNullOrEmpty(value))
            newMember.gender = null;
        else
            newMember.gender = int.Parse(value);
        CheckGenderWarning();
        StateHasChanged();

    }

    private void item_3_changed(ChangeEventArgs e)
    {
        ClearRelationError();
        var value = e.Value?.ToString();

        if (string.IsNullOrEmpty(value))
            newMember.item_3 = null;
        else
            newMember.item_3 = int.Parse(value);
    }

    private void ageClear()
    {
        ClearAgeError();
        // CheckAgeWarnings();
        StateHasChanged();
        // CheckEduAgeWarnings();
    }

    private void clearItem_6()
    {
        clearItem_6Error();
        // CheckMaritalStatusWarning();
        StateHasChanged();
    }
    private void ClearItem7()
    {
        ClearItem7Error();
        // CheckEduAgeWarnings();
    }
    private void ClearItem8()
    {
        ClearItem8Error();
        // CheckItem8Warning();
        StateHasChanged();
    }
    private void ClearItem9()
    {
        ClearItem9Error();
        // CheckItem9Warning();
        StateHasChanged();
    }
    private void ClearItem10()
    {
        ClearItem10Error();
        // CheckItem10Warning();
        StateHasChanged();
    }
    private void ClearItem11()
    {
        ClearItem11Error();
        // CheckItem11Warning();
        StateHasChanged();
    }
    //Validator Method
    private void Validate()
    {
        ClearErrors();
        error = false; // Reset error flag

        //int nextSerialNo = block3Members.Count + 1;


        // Name validation: not blank and only letters/spaces
        if (string.IsNullOrWhiteSpace(newMember.item_2))
        {
            nameError = "Please enter a name.";
            error = true;
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(newMember.item_2, @"^[a-zA-Z ]+$"))
        {
            nameError = "Name must contain only letters and spaces.";
            error = true;
        }
        else
        {
            nameError = null;
        }

        //sl.no4 Hard Check

        if (!(newMember.item_3.HasValue && newMember.item_3 >= 1 && newMember.item_3 <= 9))
        {
            relationError = "H004(i): Invalid Entry, Please check the entry";
            error = true;
        }
        else if (newMember.serial_no == 1 && newMember.item_3 != 1)
        {
            relationError = "H004(ii): Invalid Entry, Please check the entry";
            error = true;
        }
        else if (newMember.serial_no > 1 && newMember.item_3 == 1)
        {
            relationError = "H004(ii): Invalid Entry, Please check the entry";
            error = true;
        }
        else if (newMember.item_3 == 1 && block3Members.Any(m => m.item_3 == 1) && isAdd)
        {
            relationError = "H004(iii): Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            relationError = null;
        }



        // sl.no 5 Hard Check
        if (!(newMember.gender.HasValue && (newMember.gender == 1 || newMember.gender == 2 || newMember.gender == 3)))
        {
            genderError = "H005(i): Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            genderError = null;
        }




        // 5. Age Error Check
        if (!newMember.age.HasValue || newMember.age < 1 || newMember.age > 120)
        {
            ageError = "H006(i): Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            ageError = null;
        }

        //sl.no7 hard check
        if (!(newMember.item_6.HasValue && newMember.item_6 >= 1 && newMember.item_6 <= 4))
        {
            item_6Error = "H007(i): Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            item_6Error = null;

            // Rule ii) If entry in Col.3 == 2, then entry in Col.6 must be 2
            if (newMember.item_3 == 2 && newMember.item_6 != 2)
            {
                item_6Error = "H007(ii): Invalid Entry, Please check the entryies recorded against cols. 3 & 6";
                error = true;
            }
            // Rule iii) If entry in Col.3 == 3 or 4, then entry in Col.6 must NOT be 1
            else if ((newMember.item_3 == 3 || newMember.item_3 == 4) && newMember.item_6 == 1)
            {
                item_6Error = "H007(iii): Invalid Entry, Please check the entryies recorded against cols. 3 & 6";
                error = true;
            }
            // Rule iv) If entry in Col.3 == 5, then entry in Col.6 must be 1
            else if (newMember.item_3 == 5 && newMember.item_6 != 1)
            {
                item_6Error = "H007(iv): Invalid Entry, Please check the entryies recorded against cols. 3 & 6";
                error = true;
            }
        }


        //sl.no8 hard check
        if (!newMember.item_7.HasValue ||!((newMember.item_7 >= 1 && newMember.item_7 <= 8) || newMember.item_7 == 10 || newMember.item_7 == 11))
        {
            item_7Error = "H008(i): Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            item_7Error = null;
        }



        //sl.no8 Col8 hard check

        if (!newMember.item_8.HasValue || !(newMember.item_8 >= 1 && newMember.item_8 <= 15))
        {
            item_8Error = "H008(i): Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            item_8Error = null;
        }

        //col9 Error
        if (newMember.item_8.HasValue && newMember.item_8 >= 1 && newMember.item_8 <= 13)
        {
            if (!newMember.item_9.HasValue || newMember.item_9 < 1 || newMember.item_9 > 15)
            {
                item_9Error = "H009(i): Invalid Entry, Please check the entry";
                error = true;
            }
            else
            {
                item_9Error = null;
            }
        }
        else
        {
            if (newMember.item_9.HasValue)
            {
                item_9Error = "H009(i): Entry in Col.9 must be empty if no admissible code in Col.8";
                error = true;
            }
            else
            {
                item_9Error = null;
            }
        }


        //Col 10

        // Validate Col.10 (item_10) admissible codes: 1 to 15
        if (!newMember.item_10.HasValue || newMember.item_10 < 1 || newMember.item_10 > 15)
        {
            item_10Error = "H0010(i)Invalid Entry, Please check the entry";
            error = true;
        }
        else
        {
            item_10Error = null;
        }

        // col11
        if (newMember.item_10.HasValue && newMember.item_10 >= 1 && newMember.item_10 <= 13)
        {
            if (!newMember.item_11.HasValue || newMember.item_11 < 1 || newMember.item_11 > 15)
            {
                item_11Error = "H0011(i): Invalid Entry, Please check the entry";
                error = true;
            }
            else if (newMember.item_10 == newMember.item_11)
            {
                item_11Error = "H0011(iii): Please recheck entries recorded against cols. 10 & 11.";
                error = true;
            }
            else
            {
                item_11Error = null;
            }
        }
        else
        {
            if (newMember.item_11.HasValue)
            {
                item_11Error = "Error: Column 11 must be empty if column 10 does not have code 1-13";
                error = true;
            }
            else
            {
                item_11Error = null;
            }
        }


        // sl.no12 hard check

        if (newMember.age.HasValue && newMember.age >= 15)
        {
            // When age is 15 or above, entry must be 1 or 2
            if (!newMember.item_12.HasValue || (newMember.item_12 != 1 && newMember.item_12 != 2))
            {
                item_12Error = "H0012(ii): Invalid Entry, Please check the entry";
                error = true;
            }
            else
            {
                item_12Error = null;
            }
        }
        else
        {
            // When age less than 15, entry in item_12 should be null or empty
            if (newMember.item_12.HasValue)
            {
                item_12Error = "H0012(i):Invalid Entry, Please check the entry";
                error = true;
            }
            else
            {
                item_12Error = null;
            }
        }





    }

    //Gender Warning

    private void CheckGenderWarning()
    {
        var head = block3Members.FirstOrDefault(m => m.item_3 == 1);
        var spouse = newMember;

        if (head != null && head.gender.HasValue)
        {
            if (spouse != null && spouse.item_3 == 2 && spouse.gender.HasValue && spouse.gender == head.gender)
            {
                genderWarning = "W: Gender of head and spouse should not be the same. Please verify.";
                StateHasChanged();
                return;
            }

        }

        genderWarning = null;
        StateHasChanged();
    }


    // Clear All Errors After Input Anything.................................
    private void ClearNameError() => nameError = null;
    private void ClearRelationError() => relationError = null;
    private void ClearGenderError() => genderError = null;
    private void ClearAgeError() => ageError = null;
    private void clearItem_6Error() => item_6Error = null;
    private void ClearItem7Error() => item_7Error = null;
    private void clearItem7Error() => item_8Error = null;
    private void ClearItem8Error() => item_8Error = null;
    private void ClearItem9Error() => item_9Error = null;
    private void ClearItem10Error() => item_10Error = null;
    private void ClearItem11Error() => item_11Error = null;
    private void ClearItem12Error() => item_12Error = null;

    private void ClearErrors()
    {
        // Clear all previous errors before validation
        nameError = null;
        relationError = null;
        genderError = null;
        ageError = null;
        item_6Error = null;
        item_7Error = null;
        item_8Error = null;
        item_9Error = null;
        item_10Error = null;
        item_11Error = null;
        item_12Error = null;
        genderWarning = null;
        ageWarning = null;
        maritalStatusWarning = null;
        eduAgeWarning = null;
        item_8Warning = null;
        item_9Warning = null;
        item_10Warning = null;
        item_11Warning = null;
    }

    async Task HandleModal(string action = "", Tbl_Block_3? data = null)
    {
        try
        {
            if (action == "ADD")
            {
                isAdd = true;
                if (data == null)
                {
                    newMember = new();
                    newMember.serial_no = ReturnCurrentMemberSerialNumber();
                    newMember.id = Guid.NewGuid();
                }
                else
                {
                    newMember = data;
                }

                await AddModal.ShowAsync();
            }
            else if (action == "UPDATE")
            {
                isAdd = false;
                if (data != null)
                {
                    newMember = data;
                    await AddModal.ShowAsync();
                }
            }
            else
            {
                await AddModal.HideAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }

    }

    int ReturnCurrentMemberSerialNumber()
    {
        try
        {
            if (block3Members != null && block3Members.Count > 0)
            {
                return block3Members.Count + 1;
            }
            else
            {
                return 1;
            }
        }
        catch
        {
            return 1;
        }
    }

    async Task HandleDelete(Guid id)
    {
        int item_index = block3Members.FindIndex(l => l.id == id);
        if (item_index != -1)
        {
            block3Members[item_index].is_deleted = true;
            await DBQueries.DeleteHISBlock3(id);
            toastService.ShowSuccess("Entry deleted successfully!");
            await LoadData();
        }
        else
        {
            toastService.ShowError("Not Able to delete row, Please try again!");
            return;
        }
    }


    // Logic: Add member to List when form is submitted
    private async Task HandleAddMember()
    {

        Validate();

        if (error)
        {
            toastService.ShowError("Please resolve pending errors");
            return;
        }

        await DBQueries.Save_SCH_HIS_Block3(newMember);
        toastService.ShowSuccess("Member added successfully!");
        await AddModal.HideAsync();
        await LoadData();

    }

    async void HandleSubmit(string action="")
    {
        NavigationManager.NavigateTo("/dashboard/his/block_4_1");
    }
}

