@page "/dashboard/his/block_7a"
@using Blazored.FluentValidation
@using FluentValidation
@using Income.Common.HIS2026
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Validators.HIS2026
@using Income.Viewmodels
@using System.Linq.Expressions
@using System.Reflection
@inject IJSRuntime JSRuntime
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject Comment_vm comment_vm
@inject LocalizationService Loc
@inject IValidator<Tbl_Block_7a_1> Validator

<div class="pb-5">
    <CommonContentHeader SelectedFsuId="@SessionStorage.SelectedFSUId" survey_time="DateTime.Now"/>
     @* 7.1 *@
    <div class="card card-style2 rounded-4">
        <div class="card-header d-flex align-items-center justify-content-between bg-transparent">
            <h5 class="card-title m-0">
                <span class="text-primary me-1">Block 7a:</span>
                 Income from Self-employment - Crop cultivation
            </h5>
            @if (!SessionStorage.FSU_Submitted)
            {
                <div class="card-tools ms-auto">
                    <button class="btn btn-primary" disabled="@(!codeListEntryNeeded)" @onclick="@(() => OnShowModalClick("ADD"))"><i class="bi bi-plus me-1"></i>Add</button>
                </div>
            }
        </div>
        <div class="row px-3 py-2">
            <div class="col">
                For Agricultural Establishment engaged in crop cultivation (includes production of cereals, pulses, oilseeds, cash-crops, vegetables, fruits, spices, flowers etc. <span class="text-primary">(entry against any one or more of S. nos. 1-2 of Q4.4 of Block 4 is selected)</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center mb-0">
                    <thead>
                        <tr>
                            <th colspan="10" class="bg-transparent text-start">
                                <label class="form-label fs-6 fw-bold m-0">
                                    <span class="badge bg-primary me-1 me-2">Q7.1 </span>
                                    Details of the crops cultivated by one or more member of the household during last 365 days?
                                </label>
                            </th>
                        </tr>
                        <tr>
                            <th style="width: 50px;">S. No.</th>
                            <th>Crop code (4 digits)</th>
                            <th>unit (Kg./no.)</th>
                            <th>Total Quantity Produced (harvested)</th>
                            <th>Total quantity sold (out of total production) </th>
                            <th>Total sale value(in Rs.)</th>
                            <th>Average per unit sale value (in Rs.)</th>
                            <th>Value of pre-harvested sale (Rs.)</th>
                            <th>Value of by-products (Rs.)</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                            <th>(5)</th>
                            <th>(6)</th>
                            <th>(7)</th>
                            <th>(8)</th>
                            <th>(9)</th>
                            <th>(10)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ActivityList)
                        {
                            <tr>
                                <td>@item.serial_number</td>
                                <td>@item.code</td>
                                <td>@item.unit</td>
                                <td>@item.item_4</td>
                                <td>@item.item_5</td>
                                <td>@item.item_6</td>
                                <td>@item.item_7</td>
                                <td>@item.item_8</td>
                                <td>@item.item_9</td>
                                @if (!SessionStorage.FSU_Submitted)
                                {
                                    <td class="d-flex align-items-center justify-content-center">
                                        <button class="btn btn-link me-2 text-muted d-flex align-items-center" @onclick="@(() => OnShowModalClick("UPDATE", item))"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-link text-danger d-flex align-items-center" @onclick="@(() => Delete(item))"><i class="bi bi-trash3"></i></button>
                                    </td>
                                }

                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>  
    </div>

   
    <div class="row">
        <div class="col-sm-6">
            <button class="btn btn-outline-primary"><i class="bi bi-chevron-left me-1"></i>Back</button>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                <NavLink class="btn btn-outline-primary" @onclick="Next">Next<i class="bi bi-chevron-right ms-1"></i></NavLink>
            </div>
        </div>
        
    </div>

    <Modal @ref="modal" title="@((isAdd ? "Add Details" : "Update Details"))" IsVerticallyCentered="true">
        <BodyTemplate>
            @if (editContext != null)
            {
                <EditForm EditContext="editContext">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">1</span> S. No.
                                </label>
                                <input type="text" class="form-control form-control-sm" disabled value="@block_7_1.serial_number">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">2</span> Crop code (4 digits)
                                </label>
                                <select disabled="@SessionStorage.FSU_Submitted" class="form-select form-select-sm" value="@block_7_1?.code"
                                        @onchange="e =>
                                        {
                                            UpdateFieldAndValidate(() => block_7_1.code, e);
                                        }">
                                      <option>Select</option>
                                    @foreach (var item in Block_7_1_Constants.CropCodes)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                </select>
                                <ValidationMessage For="@(() => block_7_1.code)" />

                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">3</span> unit (Kg./no.)
                                </label>
                                <input type="number" disabled="@SessionStorage.FSU_Submitted" value="@block_7_1?.unit" class="form-control form-control-sm no-spinner" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                       @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.unit, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.unit)" />

                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">4</span> Total Quantity Produced (harvested)
                                </label>
                                <input disabled="@SessionStorage.FSU_Submitted" type="number" class="form-control form-control-sm no-spinner" value="@block_7_1?.item_4" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                         @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.item_4, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.item_4)" />

                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">5</span> Total quantity sold (out of total production)
                                </label>
                                <input disabled="@SessionStorage.FSU_Submitted" type="number" class="form-control form-control-sm no-spinner" value="@block_7_1?.item_5" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                       @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.item_5, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.item_5)" />
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">6</span> Total sale value(in Rs.)
                                </label>
                                  <input disabled="@SessionStorage.FSU_Submitted" type="number" class="form-control form-control-sm no-spinner" value="@block_7_1?.item_6" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                         @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.item_6, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.item_6)" />
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">7</span> Average per unit sale value (in Rs.)
                                </label>
                                  <input disabled="@(block_7_1.item_6.HasValue)" type="number" class="form-control form-control-sm no-spinner" value="@block_7_1?.item_7" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                         @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.item_7, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.item_7)" />
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-3">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">8</span> Value of pre-harvested sale (Rs.)
                                </label>
                                  <input disabled="@SessionStorage.FSU_Submitted" type="number" class="form-control form-control-sm no-spinner" value="@block_7_1?.item_8" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                         @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.item_8, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.item_8)" />
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="" class="form-label mb-2 d-flex align-items-start">
                                    <span class="badge bg-primary me-1">9</span> Value of by-products (Rs.)
                                </label>
                                <input disabled="@SessionStorage.FSU_Submitted" type="number" class="form-control form-control-sm no-spinner" value="@block_7_1?.item_9" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                         @oninput="e =>
                                       {
                                           UpdateFieldAndValidate(() => block_7_1.item_9, e);
                                       }">
                                  <ValidationMessage For="@(() => block_7_1.item_9)" />
                            </div>
                        </div>
                    </div>
                </EditForm>
                
            }
            
        </BodyTemplate>
        <FooterTemplate>
            <Button class="btn btn-outline-primary" @onclick="OnHideModalClick">Close</Button>
            <Button class="btn btn-primary" @onclick="Save">Save</Button>
        </FooterTemplate>
    </Modal>
</div>


@code {
    private Modal modal = default!;
    private Tbl_Block_4? block_4 = null;
    private Tbl_Block_7a_1 block_7_1 = new();
    private List<Tbl_Block_7a_1> ActivityList = [];
    EditContext editContext;
    ValidationMessageStore messageStore;
    bool codeListEntryNeeded = false;
    DBQueries dB = new();
    bool isAdd;

    protected override async Task OnInitializedAsync()
    {
        block_4 = await dB.Fetch_SCH_HIS_Block4(SessionStorage.selected_hhd_id);
        codeListEntryNeeded = block_4 != null && (block_4.item_4_1.GetValueOrDefault() || block_4.item_4_2.GetValueOrDefault());

        await LoadData();
        StateHasChanged();
    }

    private void UpdateFieldAndValidate(Expression<Func<int?>> field, ChangeEventArgs e)
    {
        var identifier = FieldIdentifier.Create(field);

        // Try parse
        int? value = null;
        if (!string.IsNullOrWhiteSpace(e.Value?.ToString()) &&
            int.TryParse(e.Value?.ToString(), out var v))
        {
            value = v;
        }

        // 1️⃣ Update the actual model field
        var memberExpr = (MemberExpression)field.Body;
        var prop = (PropertyInfo)memberExpr.Member;
        prop.SetValue(block_7_1, value);

        // Auto-calc item_7 when possible
        if (block_7_1.item_6.GetValueOrDefault() > 0 &&
            block_7_1.item_5.GetValueOrDefault() > 0)
        {
            block_7_1.item_7 = block_7_1.item_6 / block_7_1.item_5;

            // Notify Blazor that item_7 changed
            editContext?.NotifyFieldChanged(
                new FieldIdentifier(block_7_1, nameof(block_7_1.item_7))
            );
        }

        // 2️⃣ Clear previous errors
        messageStore?.Clear(identifier);

        // 3️⃣ Notify Blazor validation system
        editContext?.NotifyFieldChanged(identifier);
    }

    private async Task OnShowModalClick(string mode = "", Tbl_Block_7a_1? data = null)
    {
        if(mode == "ADD")
        {
            isAdd = true;
            block_7_1 = new();
            block_7_1.id = Guid.NewGuid();
            block_7_1.serial_number = ActivityList.Count + 1;
            editContext = new EditContext(block_7_1);
            messageStore = new ValidationMessageStore(editContext);
            editContext.OnFieldChanged += EditContext_OnFieldChanged;
        }
        else if (mode == "UPDATE")
        {
            isAdd = false;

            if (data != null)
            {
                block_7_1 = data;
                editContext = new EditContext(block_7_1);
                messageStore = new ValidationMessageStore(editContext);
                editContext.OnFieldChanged += EditContext_OnFieldChanged;
            }
        }
        await modal.ShowAsync();
    }

    private void EditContext_OnFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        // Clear validation messages for this specific field
        messageStore.Clear(e.FieldIdentifier);

        // Update validation state
        editContext.NotifyValidationStateChanged();
    }

    private async Task OnHideModalClick()
    {
        await modal.HideAsync();
    }

    private async Task Save()
    {
        try
        {
            messageStore.Clear();
            var result = await Validator.ValidateAsync(block_7_1);
            foreach (var error in result.Errors)
            {
                var fieldIdentifier = new FieldIdentifier(block_7_1, error.PropertyName);
                messageStore.Add(fieldIdentifier, error.ErrorMessage);
            }

            editContext.NotifyValidationStateChanged();
            if (!result.IsValid)
            {
                toastService.ShowError("Please resolve pending errors");
                return;
            }
            else
            {
                int saved = await dB.Save_SCH_HIS_Block7A_CodeList(block_7_1) ?? 0;
                if (saved > 0)
                    toastService.ShowSuccess("Data saved successfully");
                else
                    toastService.ShowError("Unable to save data");
                await modal.HideAsync();
                await LoadData();
            }
        }
        catch (Exception ex)
        {

        }
    }

    private async Task LoadData()
    {
        ActivityList = await dB.Fetch_SCH_HIS_Block7A_CodeList();
        StateHasChanged();
    }

    private async Task Delete(Tbl_Block_7a_1 item)
    {
        try
        {
            int deleted = await dB.DeleteBlock7A_CodeList(item.id);
            if (deleted == 1)
            {
                toastService.ShowSuccess("Deleted successfully");
                await LoadData();
            }
            else
            {
                toastService.ShowError("Could not delete item");
                return;
            }
        }
        catch (Exception ex)
        {

        }
    }

    private void Next()
    {
        try
        {
            if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
            {
                NavigationManager.NavigateTo("/dashboard/his/block_7a_2");
                return;
            }
            if (codeListEntryNeeded && ActivityList.Count == 0)
            {
                toastService.ShowError("H037: Need to enter atleast entry in 7.1");
                return;
            }
            else
            {
                NavigationManager.NavigateTo("/dashboard/his/block_7a_2");
            }
        }
        catch (Exception ex)
        {
            
        }
    }
}
