@page "/dashboard/his/block_7a"
@using Blazored.FluentValidation
@using FluentValidation
@using Income.Common.HIS2026
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Validators.HIS2026
@using Income.Viewmodels
@using System.Linq.Expressions
@using System.Reflection
@inject IJSRuntime JSRuntime
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject Comment_vm comment_vm
@inject LocalizationService Loc
@inject IValidator<Tbl_Block_7a_1> Validator
@inject ILoggingService loggingService

<NavigationLock OnBeforeInternalNavigation="ConfirmforNavigation" />
<div class="main-content">
    <CommonContentHeader SelectedFsuId="@SessionStorage.SelectedFSUId" survey_time="@survey_time"/>
    <ConfirmDialog @ref="dialog" />
     @* 7.1 *@
    <div class="card custom-card">
        <div class="px-3 pt-3 d-flex justify-content-between">
            <h5 class="text-dark mb-2">
                <span class="text-primary me-1">Block 7:</span> Income from Self-employment
            </h5>
            @if (!SessionStorage.FSU_Submitted)
            {
                @if (SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
                {

                    <div class="card-tools pb-2">
                        <button class="btn btn-primary" @onclick="@(() => OnShowModalClick("ADD"))"><i class="fi fi-rr-plus me-1"></i>Add</button>
                    </div>
                }
            }

            @* add comment *@
            @if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
            {

                <div class="card-tools">
                    <NavLink class="btn btn-primary" onclick="@(() => commentModal.Open())"><i class="fi fi-rr-comment-alt me-2"></i>Comment</NavLink>
                </div>
            }
        </div>
        <div class="card-header border border-secondary-subtle">
            <h5 class="card-title">
                <span class="text-primary me-2">Block 7a</span>
                 Income from Self-employment - Crop cultivation
            </h5>           
        </div>
        <div class="row px-3 py-2 border-bottom">
            <div class="col">
                For Agricultural Establishment engaged in crop cultivation (includes production of cereals, pulses, oilseeds, cash-crops, vegetables, fruits, spices, flowers etc. <span class="text-primary">(entry against any one or more of S. nos. 1-2 of Q4.4 of Block 4 is selected)</span>
            </div>
        </div>
        <div class="row px-3 py-2">
            <div class="col">
                <label class="form-label fw-bold m-0">
                    <span class="form-badge me-2">Q7.1 </span>
                    Details of the crops cultivated by one or more member of the household during last 365 days?
                </label>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center mb-0 fixed-column">
                    <thead>
                        <tr>
                            <th class="col-1">Action</th>
                            <th style="width: 50px;" class="col-2">S. No.</th>
                            <th>Crop code (4 digits)</th>
                            <th>Whether the entire crop is sold before harvest</th>
                            <th>unit (Kg./no.)</th>
                            <th>Total Quantity Produced (harvested)</th>
                            <th>Total quantity sold (out of total production) </th>
                            <th>Total sale value(in Rs.)</th>
                            <th>Average per unit sale value (in Rs.)</th>
                            <th>Value of pre-harvested sale (Rs.)</th>
                            <th>Value of by-products (Rs.)</th>
                        </tr>
                        <tr>
                            <th class="col-1"></th>
                            <th class="col-2">(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                            <th>(5)</th>
                            <th>(6)</th>
                            <th>(7)</th>
                            <th>(8)</th>
                            <th>(9)</th>
                            <th>(10)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in ActivityList)
                        {
                            <tr>
                                <td class="col-1">
                                    @if (!SessionStorage.FSU_Submitted)
                                    {
                                        @if (SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
                                        {

                                            <div class="d-flex align-items-center justify-content-center">
                                                <button class="btn btn-link me-2 fs-6" @onclick="@(() => OnShowModalClick("UPDATE", item))"><i class="fi fi-rr-pencil"></i></button>
                                                <button class="btn btn-link text-danger fs-6" @onclick="@(() => Delete(item))"><i class="fi fi-rr-trash"></i></button>
                                            </div>
                                        }
                                    }
                                </td>
                                <td class="col-2">@item.serial_number</td>
                                <td>@item.code</td>
                                <td>@(item.whetherCropSold == 1 ? "Yes" : "No")</td>
                                <td>@(item.unit == 1 ? "Kg" : "No.")</td>
                                <td>@item.item_4</td>
                                <td>@item.item_5</td>
                                <td>@item.item_6</td>
                                <td>@item.item_7</td>
                                <td>@item.item_8</td>
                                <td>@item.item_9</td>
                            </tr>
                        }
                    </tbody>
                    @if (!string.IsNullOrEmpty(Block_7_ConfirmNavigation))
                    {
                        <tfoot>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="form-text text-danger">@Block_7_ConfirmNavigation</div>
                                </td>
                            </tr>
                        </tfoot>
                    }
                </table>
            </div>
        </div>  
    </div>
</div>
   
<div class="footer">
    <!-- Remarks textarea -->
    @* <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">Remarks</h3>
        </div>
        <div class="card-body">
            <textarea maxlength="500" class="form-control" rows="3" placeholder="Enter your remarks here..." rows="2" ></textarea>
        </div>
    </div> *@
    <div class="row">
        <div class="col-sm-6">
            <button class="btn btn-outline-secondary" onclick="@GoBack"><i class="fi fi-rr-angle-left me-1"></i>Back</button>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                <NavLink class="btn btn-primary" @onclick="Next">Next<i class="fi fi-rr-angle-right ms-1"></i></NavLink>
            </div>
        </div>
    </div>  
</div>

<Modal @ref="modal" title="@((isAdd ? "Add Details" : "Update Details"))" IsVerticallyCentered="true" Size="ModalSize.ExtraLarge" Fullscreen="ModalFullscreen.LargeDown">
    <BodyTemplate>
        @if (editContext != null)
        {
            <EditForm EditContext="editContext">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">1</span> S. No.
                            </label>
                            <input type="text" class="form-control" disabled value="@block_7_1.serial_number">
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">2</span> Crop code (4 digits)
                            </label>
                            <select disabled="@SessionStorage.FSU_Submitted" class="form-select" value="@block_7_1?.code"
                                    @onchange="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.code, e);
                                    }">
                                    <option>Select</option>
                                @foreach (var item in Block_7_1_Constants.CropCodes)
                                {
                                    <option value="@item.id">@item.title</option>
                                }
                            </select>
                            <ValidationMessage For="@(() => block_7_1.code)" />

                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">3</span> Whether the entire crop is sold before harvest
                            </label>
                            <select disabled="@SessionStorage.FSU_Submitted" value="@block_7_1?.whetherCropSold" class="form-select"
                                    @onchange="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.whetherCropSold, e);
                                    }">
                                  <option>Select</option>
                                  <option value="1">1 - Yes</option>
                                  <option value="2">2 - No</option>
                              </select>
                              <ValidationMessage For="@(() => block_7_1.whetherCropSold)" />

                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">4</span> unit (Kg./no.)
                            </label>
                            <select disabled="@(block_7_1?.whetherCropSold == 1)" value="@block_7_1?.unit" class="form-select"
                                    @onchange="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.unit, e);
                                    }">
                                  <option>Select</option>
                                  <option value="1">Kg</option>
                                  <option value="2">No.</option>
                            </select>
                            <ValidationMessage For="@(() => block_7_1.unit)" />

                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">5</span> Total Quantity Produced (harvested)
                            </label>
                            <input disabled="@(block_7_1?.whetherCropSold == 1)" type="number" class="form-control no-spinner" value="@block_7_1?.item_4" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                        @oninput="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.item_4, e);
                                    }">
                                <ValidationMessage For="@(() => block_7_1.item_4)" />

                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">6</span> Total quantity sold (out of total production)
                            </label>
                            <input disabled="@(block_7_1?.whetherCropSold == 1)" type="number" class="form-control no-spinner" value="@block_7_1?.item_5" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                    @oninput="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.item_5, e);
                                    }">
                                <ValidationMessage For="@(() => block_7_1.item_5)" />
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">7</span> Total sale value(in Rs.)
                            </label>
                              <input disabled="@(block_7_1?.whetherCropSold == 1 || isItem7UserEntered)" type="number" class="form-control no-spinner" value="@block_7_1?.item_6" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                        @oninput="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.item_6, e);
                                    }">
                                <ValidationMessage For="@(() => block_7_1.item_6)" />
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">8</span> Average per unit sale value (in Rs.)
                            </label>
                              <input disabled="@(block_7_1?.whetherCropSold == 1 || (block_7_1.item_6.HasValue && !isItem7UserEntered))" type="number" class="form-control no-spinner" value="@block_7_1?.item_7" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                        @oninput="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.item_7, e);
                                    }">
                                <ValidationMessage For="@(() => block_7_1.item_7)" />
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">9</span> Value of pre-harvested sale (Rs.)
                            </label>
                              <input disabled="@(block_7_1?.whetherCropSold == 1)" type="number" class="form-control no-spinner" value="@block_7_1?.item_8" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                        @oninput="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.item_8, e);
                                    }">
                                <ValidationMessage For="@(() => block_7_1.item_8)" />
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="mb-3">
                            <label for="" class="form-label">
                                <span class="form-badge">10</span> Value of by-products (Rs.)
                            </label>
                              <input disabled="@(block_7_1?.whetherCropSold == 1)" type="number" class="form-control no-spinner" value="@block_7_1?.item_9" onkeypress="return /^(\d*)$/.test(event.target.value + event.key)"
                                        @oninput="e =>
                                    {
                                        UpdateFieldAndValidate(() => block_7_1.item_9, e);
                                    }">
                                <ValidationMessage For="@(() => block_7_1.item_9)" />
                        </div>
                    </div>
                </div>
            </EditForm>
                
        }
            
    </BodyTemplate>
    <FooterTemplate>
        <Button class="btn btn-outline-secondary me-auto" @onclick="OnHideModalClick">Close</Button>
        <Button class="btn btn-primary" @onclick="Save">Save</Button>
    </FooterTemplate>
</Modal>

<CommentModal @ref="commentModal"
              MemberList=RowList
              QuestionList="@(new List<string>(){"2","3","4","5","6","7","8","9"})"
              Block="7A_1" />

@code {
    private Modal modal = default!;
    private Tbl_Block_4? block_4 = null;
    private Tbl_Block_7a_1 block_7_1 = new();
    CommonQueries commonQueries = new();
    private List<Tbl_Block_7a_1> ActivityList = [];
    EditContext editContext;
    ValidationMessageStore messageStore;
    bool codeListEntryNeeded = false;
    DBQueries dB = new();
    bool isAdd;
    CommentModal commentModal = default!;
    List<int> RowList = [];
    DateTime survey_time = DateTime.Now;
    private ConfirmDialog dialog = default!;
    private string Block_7_ConfirmNavigation { get; set; } = string.Empty;
    async void GoBack()
    {
        NavigationManager.NavigateTo("/dashboard/his/block_6");

        return;
    }

    protected override async Task OnInitializedAsync()
    {
        block_4 = await dB.Fetch_SCH_HIS_Block4(SessionStorage.selected_hhd_id);
        codeListEntryNeeded = block_4 != null && (block_4.item_4_1.GetValueOrDefault() || block_4.item_4_2.GetValueOrDefault());

        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/his/block_7a",
            block_title = "NHIS Block 7a",
            block_code = CommonEnum.his_block_7a.ToString(),
        };
        await LoadData();
        await commonQueries.InsertVisitedBlock(vb);
        if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            if (ActivityList != null)
            {
                survey_time = ActivityList
                            .OrderByDescending(x => x.survey_timestamp)
                            .Select(x => (DateTime?)x.survey_timestamp)
                            .FirstOrDefault().GetValueOrDefault();
            }
        }
        StateHasChanged();
    }

    private bool isItem7UserEntered = false;

    private void UpdateFieldAndValidate(Expression<Func<int?>> field, ChangeEventArgs e)
    {
        var identifier = FieldIdentifier.Create(field);
        var fieldName = ((MemberExpression)field.Body).Member.Name;

        // Parse value
        int? value = null;
        if (!string.IsNullOrWhiteSpace(e.Value?.ToString()) &&
            int.TryParse(e.Value?.ToString(), out var v))
        {
            value = v;
        }

        // Set value
        var prop = (PropertyInfo)((MemberExpression)field.Body).Member;
        prop.SetValue(block_7_1, value);

        if (fieldName == nameof(block_7_1.whetherCropSold))
        {
            if (value.HasValue && value == 2)
            {
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.whetherCropSold))
                );
            }
            else
            {
                block_7_1.unit = null;
                block_7_1.item_4 = null;
                block_7_1.item_5 = null;
                block_7_1.item_6 = null;
                block_7_1.item_7 = null;
                block_7_1.item_8 = null;
                block_7_1.item_9 = null;
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.unit))
                );
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_4))
                );
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_5))
                );
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_6))
                );
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_7))
                );
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_8))
                );
                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_9))
                );
            }
        }

        if (fieldName == nameof(block_7_1.item_7))
        {
            isItem7UserEntered = value.HasValue;

            if (value.HasValue && block_7_1.item_5.GetValueOrDefault() > 0)
            {
                block_7_1.item_6 = block_7_1.item_5 * value;

                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_6))
                );
            }
            else
            {
                block_7_1.item_6 = null;
            }
        }

        if (fieldName == nameof(block_7_1.item_6))
        {
            isItem7UserEntered = false;

            if (block_7_1.item_6.GetValueOrDefault() > 0 &&
                block_7_1.item_5.GetValueOrDefault() > 0)
            {
                block_7_1.item_7 = block_7_1.item_6 / block_7_1.item_5;

                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_7))
                );
            }
            else
            {
                block_7_1.item_7 = null;
            }
        }

        if (fieldName == nameof(block_7_1.item_5))
        {

            if (block_7_1.item_6.GetValueOrDefault() > 0 &&
                block_7_1.item_5.GetValueOrDefault() > 0)
            {
                block_7_1.item_7 = block_7_1.item_6 / block_7_1.item_5;

                editContext?.NotifyFieldChanged(
                    new FieldIdentifier(block_7_1, nameof(block_7_1.item_7))
                );
            }
            else
            {
                block_7_1.item_7 = null;
            }
        }

        if (block_7_1.item_5.GetValueOrDefault() == 0 && block_7_1.item_6.GetValueOrDefault() == 0)
        {
            block_7_1.item_7 = 0;
        }

        // Validation updates
        messageStore?.Clear(identifier);
        editContext?.NotifyFieldChanged(identifier);
    }


    private async Task OnShowModalClick(string mode = "", Tbl_Block_7a_1? data = null)
    {
        if(mode == "ADD")
        {
            isAdd = true;
            block_7_1 = new();
            block_7_1.id = Guid.NewGuid();
            block_7_1.serial_number = ActivityList.Count + 1;
            editContext = new EditContext(block_7_1);
            messageStore = new ValidationMessageStore(editContext);
            editContext.OnFieldChanged += EditContext_OnFieldChanged;
        }
        else if (mode == "UPDATE")
        {
            isAdd = false;

            if (data != null)
            {
                block_7_1 = data.ShallowCopy();
                editContext = new EditContext(block_7_1);
                messageStore = new ValidationMessageStore(editContext);
                editContext.OnFieldChanged += EditContext_OnFieldChanged;
            }
        }
        await modal.ShowAsync();
    }

    private void EditContext_OnFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        // Clear validation messages for this specific field
        messageStore.Clear(e.FieldIdentifier);

        // Update validation state
        editContext.NotifyValidationStateChanged();
    }

    private async Task OnHideModalClick()
    {
        await modal.HideAsync();
    }

    private async Task Save()
    {
        try
        {
            messageStore.Clear();
            if (ActivityList.Any(x => x.code == block_7_1.code && x.id != block_7_1.id && x.is_deleted != true))
            {
                toastService.ShowError("Cannot add the same crop code more than once");
                return;
            }
            var result = await Validator.ValidateAsync(block_7_1);
            foreach (var error in result.Errors)
            {
                var fieldIdentifier = new FieldIdentifier(block_7_1, error.PropertyName);
                messageStore.Add(fieldIdentifier, error.ErrorMessage);
            }

            editContext.NotifyValidationStateChanged();
            if (!result.IsValid)
            {
                toastService.ShowError("Please resolve pending errors");
                return;
            }
            else
            {
                int saved = await dB.Save_SCH_HIS_Block7A_CodeList(block_7_1) ?? 0;
                if (saved > 0)
                    toastService.ShowSuccess("Data saved successfully");
                else
                    toastService.ShowError("Unable to save data");
                await modal.HideAsync();
                await LoadData();
            }
        }
        catch (Exception ex)
        {

        }
    }

    private async Task LoadData()
    {
        ActivityList = await dB.Fetch_SCH_HIS_Block7A_CodeList();
        RowList = ActivityList.Select(x => x.serial_number).Distinct().ToList();
        StateHasChanged();
    }

    private async Task Delete(Tbl_Block_7a_1 item)
    {
        try
        {
            var options = new ConfirmDialogOptions { IsVerticallyCentered = true };
            var confirmed = await dialog.ShowAsync(
                title: "Alert",
                message1: "Are you sure you want to delete this entry?",
                confirmDialogOptions: options
            );

            if (!confirmed)
                return;
            int deleted = await dB.DeleteBlock7A_CodeList(item.id);
            if (deleted == 1)
            {
                toastService.ShowSuccess("Deleted successfully");
                await LoadData();
            }
            else
            {
                toastService.ShowError("Could not delete item");
                return;
            }
        }
        catch (Exception ex)
        {
            await loggingService.LogError(ex.ToString());
            toastService.ShowError("An unexpected error occurred while deleting.");

        }
    }

    private void Next()
    {
        try
        {
            if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
            {
                NavigationManager.NavigateTo("/dashboard/his/block_7a_2");
                return;
            }
            if (codeListEntryNeeded && ActivityList.Count == 0)
            {
                toastService.ShowError("H037: Need to enter atleast entry in 7.1");
                return;
            }
            else
            {
                NavigationManager.NavigateTo("/dashboard/his/block_7a_2");
            }
        }
        catch (Exception ex)
        {
            
        }
    }
    async Task ConfirmforNavigation(LocationChangingContext context)
    {

        if (codeListEntryNeeded && ActivityList.Count == 0 && !context.TargetLocation.EndsWith("/block_6"))
        {
            context.PreventNavigation();
            Block_7_ConfirmNavigation = $"H037: Need to enter atleast entry in 7.1";
            toastService.ShowError("Please resolve pending errors");
        }

    }

}
