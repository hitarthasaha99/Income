@page "/dashboard/his/block_6"
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@using FluentValidation
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Database.Models.SCH0_0
@using Income.Validators.HIS2026
@using Income.Viewmodels
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions
@using System.Reflection
@inject IJSRuntime JSRuntime
@inject ILoggingService loggingService
@inject Warning_VM warningVM
@inject IValidator<Tbl_Block_6> Validator

<div class="main-content">
    <CommonContentHeader SelectedFsuId="@SelectedFsuId" survey_time="@survey_time" />
    <div class="card custom-card">
        <!-- 🔹 Sticky Top Action Header -->
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary me-2">[Block 6]</span>Income from Employment – casual work
            </h3>
            <div class="card-tools">
                <div class="d-flex align-items-center" hidden="@SessionStorage.FSU_Submitted">
                    @* <button class="btn btn-primary" @onclick="@(() => HandleModal("ADD"))">
                        <i class="fi fi-rr-plus me-1"></i>Add
                    </button> *@
                </div>

            </div>
        </div>
        <!-- Scrollable table -->
        <div class="card-body p-0">
            <div class="table-responsive table-wrapper">
                <!-- Table displaying household members -->
                <table class="table table-striped table-bordered mb-0">
                    <thead>
                        <tr>
                            <th style="min-width:20px;" rowspan="2">sl.no. of member</th>
                            <th class="text-center" colspan="2">Last month</th>
                            <th class="text-center" colspan="1">Last 365 days</th>
                        </tr>
                        <tr>
                            <th style="min-width:150px;">Number of days worked in last month (no.)</th>
                            <th style="min-width:250px;">average daily wage earned in all mode except in-kind(in whole number of Rs.)</th>
                            <th style="min-width:100px;">bonuses/tips receoved</th>
                            <th style="min-width:100px;">Total monthly income
                                (Q6.1 x Q6.2) + Q6.3/12
                            </th>
                            
                        </tr>

                        <tr>
                            <th></th>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var member in block6Members)
                        {
                            <tr>
                                <td>@member.serial_member</td>
                                <td>@member.item_1</td>
                                <td>@member.item_2</td>
                                <td>@member.item_3</td>
                                <td>@member.item_4</td>
                                
                                <td class="d-flex align-items-center">
                                    <button class="btn btn-link me-3 fs-6"
                                            hidden="@SessionStorage.FSU_Submitted"
                                            @onclick="@(() => HandleModal("UPDATE", member))">
                                        <i class="fi fi-rr-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="footer">
    @* Remarks Card *@
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">Remarks</h3>
        </div>
        <div class="card-body">
            <textarea maxlength="500" type="text" class="form-control disabled w-100" disabled="@SessionStorage.FSU_Submitted" placeholder="" @bind="@remarks" rows="2"></textarea>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6">
            <div class="d-flex">
                <NavLink class="btn btn-outline-secondary" onclick="@GoBack">
                    <i class="fi fi-rr-angle-left me-1"></i>Back
                </NavLink>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                <NavLink class="btn btn-primary" @onclick="@(() => Next())">
                    Next<i class="fi fi-rr-angle-right ms-1"></i>
                </NavLink>
            </div>
        </div>
    </div>
</div>
<Modal @ref="AddModal" CloseOnEscape="false" UseStaticBackdrop="true" ShowCloseButton="false" Size="ModalSize.ExtraLarge" Fullscreen="ModalFullscreen.MediumDown">
    <HeaderTemplate>
        <h5 class="modal-title">@((isAdd ? "Add Member" : "Update Member"))</h5>
    </HeaderTemplate>
    <BodyTemplate>
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                @if (editContext != null)
                {
                    <EditForm EditContext="editContext">
                        <div class="modal-body">
                            <div class="container-fluid">
                                <div class="row">
                                    <!-- Sl no input (readonly) -->
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2">1.</span> Sl no.
                                        </label>
                                        <input type="text" class="form-control form-control-sm" value="@(newMember.serial_no)" disabled />
                                    </div>
                                    <div>
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2">Q6.1</span> number of days worked in last month (no.) (Last month)
                                        </label>

                                        <InputNumber @bind-Value="newMember.item_1"
                                                     class="form-control no-spinner form-control-sm"
                                                     autocomplete="off"
                                                     autocorrect="off"
                                                     autocapitalize="off"
                                                     spellcheck="false"
                                                     min="1"
                                                     max="31"
                                                     maxlength="2"
                                                     @oninput="item1OnInput"
                                                     onkeypress="if (this.value.length >= 2) return false; return event.key >= '0' && event.key <= '9';">
                                        </InputNumber>
                                        <ValidationMessage For="@(() => newMember.item_1)" />
                                    </div>


                                    <div>
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <div class="d-flex flex-column">
                                                <span class="me-2">Q6.2 average daily wage earned in all mode except in-kind (in whole number of Rs.)  (Last month)</span>
                                            </div>
                                        </label>
                                        <InputNumber @bind-Value="newMember.item_2"
                                                     class="form-control no-spinner form-control-sm"
                                                     autocomplete="off"
                                                     onkeypress="return event.key >= '0' && event.key <= '9'"
                                                     autocorrect="off"
                                                     autocapitalize="off"
                                                     spellcheck="false"
                                                     @oninput="item2OnInput">
                                        </InputNumber>
                                        <ValidationMessage For="@(() => newMember.item_2)" />
                                    </div>
                                    <div>
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <div class="d-flex flex-column">
                                                <span class="me-2">Q6.3 bonuses/tips received  (Last 365 days)</span>
                                            </div>
                                        </label>
                                        <InputNumber @bind-Value="newMember.item_3"
                                                     class="form-control no-spinner form-control-sm"
                                                     autocomplete="off"
                                                     onkeypress="return event.key >= '0' && event.key <= '9'"
                                                     autocorrect="off"
                                                     autocapitalize="off"
                                                     spellcheck="false"
                                                     @oninput="item3OnInput">

                                        </InputNumber>
                                        <ValidationMessage For="@(() => newMember.item_3)" />
                                    </div>
                                    <div>
                                        <label class="form-label fw-bold d-flex align-items-start">
                                            <span class="me-2"> Total monthly income (Q6.1×Q6.2) + Q6.3/12 </span>
                                        </label>
                                        <InputNumber @bind-Value="newMember.item_4"
                                                     class="form-control no-spinner form-control-sm"
                                                     autocomplete="off"
                                                     onkeypress="return event.key >= '0' && event.key <= '9'"
                                                     autocorrect="off"
                                                     autocapitalize="off"
                                                     spellcheck="false"
                                                     readonly>
                                        </InputNumber>
                                        <ValidationMessage For="@(() => newMember.item_4)" />
                                    </div>

                                </div>
                            </div>
                        </div>
                    </EditForm>
                }
                
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <button class="btn btn-outline-secondary me-auto" @onclick="@(() => HandleModal("CLOSE"))">Close</button>
        <button type="submit" @onclick="@(() => HandleAddMember())" class="btn btn-primary" form="YourEditFormId">@((isAdd ? "Save" : "Update"))</button>
    </FooterTemplate>
</Modal>


@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    private CommonConfig commonConfig = new CommonConfig();
    DateTime survey_time = DateTime.Now;
    Modal AddModal = default!;
    private List<Tbl_Block_3> block3Members = new();
    private List<Tbl_Block_6> block6Members = new();
    private Tbl_Block_6 newMember = new();
    bool isAdd = false;
    bool error = false;
    DBQueries dbq = new();
    CommonQueries commonQueries = new();
    string remarks = string.Empty;
    EditContext editContext;
    private ValidationMessageStore messageStore;

    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/his/block_6",
            block_title = "HIS Block 6",
            block_code = CommonEnum.his_block_6.ToString(),
        };

        await commonQueries.InsertVisitedBlock(vb);
        block3Members = await dbq.Fetch_SCH_HIS_Block3(SessionStorage.selected_hhd_id);
        var applicableMembers = block3Members?.Where(x => x.item_8 == 5 || x.item_9 == 5).ToList();

        await LoadData();
        if (block6Members == null || block6Members.Count == 0)
        {
            int i = 1;
            foreach (var member in applicableMembers)
            {
                Tbl_Block_6 obj = new();
                obj.id = Guid.NewGuid();
                obj.serial_member = member.serial_no;
                obj.serial_number = i++;
                obj.fk_block_3 = member.id;
                await dbq.Save_SCH_HIS_Block6(obj);
            }
            await LoadData();
        }
        else if (block6Members != null && block6Members.Count != applicableMembers?.Count)
        {
            int currentSerialNumber = block6Members.Count();
            var missingMembers = applicableMembers?
                        .Where(am => !block6Members.Any(b5 => b5.fk_block_3 == am.id))
                        .ToList();
            foreach (var member in missingMembers)
            {
                Tbl_Block_6 obj = new();
                obj.id = Guid.NewGuid();
                obj.serial_member = member.serial_no;
                obj.fk_block_3 = member.id;
                obj.serial_number = currentSerialNumber++;

                await dbq.Save_SCH_HIS_Block6(obj);
            }

        }

        StateHasChanged();
    }

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    private void UpdateFieldAndValidate(Expression<Func<int?>> field, ChangeEventArgs e)
    {
        var identifier = FieldIdentifier.Create(field);

        // Try parse
        int? value = null;
        if (!string.IsNullOrWhiteSpace(e.Value?.ToString()) &&
            int.TryParse(e.Value?.ToString(), out var v))
        {
            value = v;
        }

        // 1️⃣ Update the actual model field
        var memberExpr = (MemberExpression)field.Body;
        var prop = (PropertyInfo)memberExpr.Member;
        prop.SetValue(newMember, value);

        // 2️⃣ Clear previous errors
        messageStore?.Clear(identifier);

        // 3️⃣ Notify Blazor validation system
        editContext?.NotifyFieldChanged(identifier);
    }

    private void item1OnInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            if (value > 31)
                newMember.item_1 = 31;
            else if (value < 1)
                newMember.item_1 = 1;
            else
                newMember.item_1 = value;

            editContext?.NotifyFieldChanged(
            FieldIdentifier.Create(() => newMember.item_1));
        }
        else
        {
            newMember.item_1 = null;
        }

        handleCalculateIncome();
    }



    private void item2OnInput(ChangeEventArgs e)
    {
        var text = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(text))
            newMember.item_2 = null;
        else if (int.TryParse(text, out int v))
            newMember.item_2 = v;
        else
            newMember.item_2 = null;

        editContext?.NotifyFieldChanged(
            FieldIdentifier.Create(() => newMember.item_2));

        handleCalculateIncome();
    }

    private void item3OnInput(ChangeEventArgs e)
    {
        var text = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(text))
            newMember.item_3 = null;
        else if (int.TryParse(text, out int v))
            newMember.item_3 = v;
        else
            newMember.item_3 = null;

        editContext?.NotifyFieldChanged(
            FieldIdentifier.Create(() => newMember.item_3));

        handleCalculateIncome();
    }



    //Handle CalculateIncome
    private void handleCalculateIncome()
    {
        int item_1 = newMember.item_1 ?? 0; 
        int item_2 = newMember.item_2 ?? 0; 
        int item_3 = newMember.item_3 ?? 0; 

        int ans = (item_1 * item_2) + item_3 / 12;
        newMember.item_4 = ans;
        StateHasChanged();
    }

    async Task HandleModal(string action = "", Tbl_Block_6? data = null)
    {
        try
        {
            // if (action == "ADD")
            // {
            //     isAdd = true;
            //     if (data == null)
            //     {
            //         newMember = new();
            //         newMember.serial_no = ReturnCurrentMemberSerialNumber();
            //         newMember.id = Guid.NewGuid();
            //     }
            //     else
            //     {
            //         newMember = data;
            //     }

            //     await AddModal.ShowAsync();
            // }
            if (action == "UPDATE")
            {
                isAdd = false;
                if (data != null)
                {
                    newMember = ObjectCloneHelper.CloneTblHISBlock6(data);
                    editContext = new EditContext(newMember);
                    messageStore = new ValidationMessageStore(editContext);
                    editContext.OnFieldChanged += EditContext_OnFieldChanged;
                    await AddModal.ShowAsync();
                }
            }
            else
            {
                await AddModal.HideAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }

    }

    private void EditContext_OnFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        // Clear validation messages for this specific field
        messageStore.Clear(e.FieldIdentifier);

        // Update validation state
        editContext.NotifyValidationStateChanged();
    }

    int ReturnCurrentMemberSerialNumber()
    {
        try
        {
            if (block6Members != null && block6Members.Count > 0)
            {
                return block6Members.Count + 1;
            }
            else
            {
                return 1;
            }
        }
        catch
        {
            return 1;
        }
    }
    private async Task LoadData()
    {
        block6Members = await dbq.Fetch_SCH_HIS_Block6(SessionStorage.selected_hhd_id);
        StateHasChanged();
    }

    private async Task HandleAddMember()
    {
        messageStore.Clear();
        var result = await Validator.ValidateAsync(newMember);
        foreach (var error in result.Errors)
        {
            var fieldIdentifier = new FieldIdentifier(newMember, error.PropertyName);
            messageStore.Add(fieldIdentifier, error.ErrorMessage);
        }

        editContext.NotifyValidationStateChanged();
        if (!result.IsValid)
        {
            toastService.ShowError("Please resolve pending errors");
            return;
        }

        await dbq.Save_SCH_HIS_Block6(newMember);
        toastService.ShowSuccess("Member added successfully!");
        await AddModal.HideAsync();
        await LoadData();

    }

    void Next()
    {
        if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            NavigationManager.NavigateTo("dashboard/his/block_7a");
            return;
        }
        else
        {
            if (block6Members.Any(x => !x.isUpdated))
            {
                toastService.ShowError("Please save/update details for all entries before proceeding");
                return;
            }
            NavigationManager.NavigateTo("/dashboard/his/block_7a");
        }
    }
}
