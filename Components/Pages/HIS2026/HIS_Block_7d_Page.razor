@page "/dashboard/his/block_7d"
@using Blazored.FluentValidation
@using FluentValidation
@using Income.Common.HIS2026
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Validators.HIS2026
@using Income.Viewmodels
@using System.Linq.Expressions
@using System.Reflection
@inject IJSRuntime JSRuntime
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject Comment_vm comment_vm
@inject LocalizationService Loc

<div class="main-content">
    <CommonContentHeader />
    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title">
                <span class="text-primary me-1">Block 7d:</span>
                Mode of operation & percentage of shareholding in activities carried out during last 365 days
            </h5>
            @* add comment *@
            @if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
            {

                <div class="card-tools d-flex justify-content-end align-items-end p-2">
                    <NavLink class="btn btn-primary"><i class="fi fi-rr-comment-alt me-2"></i>Comment</NavLink>
                </div>
            }
        </div>
        @if (editContext != null)
        {
            <EditForm EditContext="editContext">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <fieldset disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)">

                            <table class="table table-bordered align-middle text-center mb-0">
                            <thead>
                                <tr>
                                    <th colspan="4" class="text-start">
                                        <label class="form-label fw-bold m-0">
                                            <span class="form-badge">Q7.12</span>
                                            Mode of operation & percentage of shareholding among activity(ies) carried out in last 365 days (To be populated from the responses of Q7.1 - crop cultivation, Q4.4 – allied activity in agriculture & Q7.9 – non-agriculture activity)
                                        </label>
                                    </th>
                                </tr>
                                <tr>
                                    <th style="width: 50px;">S. no. of activity</th>
                                    <th>Description of activity</th>
                                    <th>Mode of operation (individually operated -1, jointly operated with other household(s) -2)</th>
                                    <th>% shareholding(in case of code 2 in col. 3)</th>
                                </tr>
                                <tr>
                                    <th>(1)</th>
                                    <th>(2)</th>
                                    <th>(3)</th>
                                    <th>(4)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Block7DList?.Any() == true)
                                {
                                    foreach (var d in Block7DList)
                                    {
                                        <tr>
                                            <td>@d.item_1</td>
                                            <td>@d.item_2</td>
                                            <td>
                                                <select class="form-select" @onchange="(e) => UpdateModeOfOperation(d, e)">
                                                    <option value="">Select</option>
                                                    <option value="1" selected="@(d.item_3 == 1)">1 - Individually operated</option>
                                                    <option value="2" selected="@(d.item_3 == 2)">2 - Jointly operated with other households</option>
                                                </select>
                                                <ValidationMessage For="@(() => d.item_3)" />

                                            </td>
                                            <td>
                                                <input disabled="@(d.item_3 == 1 || d.item_3 == null)" class="form-control" value="@(d.item_4?.ToString() ?? "")" @oninput="(e) => UpdateShareholding(d, e)" />
                                                <ValidationMessage For="@(() => d.item_4)" />
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4">No activities yet.</td>
                                    </tr>
                                }
                            </tbody>
                            
                        </table>
                        </fieldset>
                    </div>
                </div>
            </EditForm>
        }
        
        
    </div>
</div>
<div class="footer">
    @* Remarks Card *@
    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title m-0">
                Remarks
            </h5>
        </div>
        <div class="card-body">
            <fieldset disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)">
                <textarea maxlength="500" class="form-control w-100" rows="2" @bind="block_1.block_7d_remark" placeholder="Enter your remarks..." oninput="this.value = this.value.replace(/[^a-zA-Z0-9 ]/g, '')"></textarea>
            </fieldset>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-6">
            <button class="btn btn-outline-secondary" @onclick="GoBack"><i class="fi fi-rr-angle-left me-1"></i>Back</button>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                @if (SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
                {
                    <button class="btn btn-outline-primary me-2" @onclick="() => SaveClicked(false)"><i class="fi fi-rr-disk me-1"></i>Save</button>
                }
                <button class="btn btn-primary" @onclick="() => SaveClicked(true)">Next<i class="fi fi-rr-angle-right ms-1"></i></button>
            </div>
        </div>
    </div>
</div>

@code {
    readonly DateTime survey_date = DateTime.Now;
    List<Tbl_Block_7a_1> CropCodeList = new();
    Tbl_Block_4? block_4;
    List<Tbl_Block_7c_NIC> NICFields = new();
    List<Tbl_Block_7d> Block7DList = new();
    private Tbl_Block_1 block_1 = new();
    CommonQueries commonQueries = new();


    EditContext? editContext;
    string remarks = string.Empty;
    DBQueries dQ = new();
    ValidationMessageStore? messageStore;

    // Guards
    private bool _isBusy = false;
    private bool _initialized = false;

    async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            // Prevent re-entrancy.
            _initialized = true;

            // Load all data in a single guarded flow.
            await LoadAllDataSafeAsync();
            editContext = new EditContext(this); // or new object(), or a wrapper model
            messageStore = new ValidationMessageStore(editContext);
            // clear errors every validation request
            editContext.OnValidationRequested += (_, __) => messageStore.Clear();
            // After completing load and sync, trigger one render.
            await InvokeAsync(StateHasChanged);
            block_1 = await dQ.FetchSingleForFsuAndHhdAsync<Tbl_Block_1>() ?? null;

        }
    }

    private void ValidateRow(Tbl_Block_7d row)
    {
        // Clear previous errors for this row only
        messageStore.Clear(new FieldIdentifier(row, nameof(row.item_3)));
        messageStore.Clear(new FieldIdentifier(row, nameof(row.item_4)));

        // Rule: item_3 must be 1 or 2
        if (row.item_3 is null or 0)
        {
            messageStore.Add(
                new FieldIdentifier(row, nameof(row.item_3)),
                "H054: Invalid entry, please check the entry"
            );
        }

        // Rule: If item_3 = 2 → item_4 must be >= 0
        if (row.item_3 == 2)
        {
            if (row.item_4 == null)
            {
                messageStore.Add(
                    new FieldIdentifier(row, nameof(row.item_4)),
                    "H055: Invalid entry, please check the entry"
                );
            }
            else if (row.item_4 < 0)
            {
                messageStore.Add(
                    new FieldIdentifier(row, nameof(row.item_4)),
                    "H055: Invalid entry, please check the entry"
                );
            }
        }

        // Notify UI to refresh validation messages
        editContext.NotifyValidationStateChanged();
    }


    private async Task LoadAllDataSafeAsync()
    {
        if (_isBusy) return;
        _isBusy = true;
        try
        {
            if(SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
            {
                // Load lists in parallel where possible (no UI changes yet).
                var fetchCropTask = dQ.Fetch_SCH_HIS_Block7A_CodeList();
                var fetchNICTask = dQ.Fetch_SCH_HIS_Block7_NICList();
                var fetchBlock4Task = dQ.Fetch_SCH_HIS_Block4(SessionStorage.selected_hhd_id);
                var fetchBlock7DTask = dQ.Fetch_SCH_HIS_Block7D();

                await Task.WhenAll(fetchCropTask, fetchNICTask, fetchBlock4Task, fetchBlock7DTask);

                CropCodeList = fetchCropTask.Result ?? new List<Tbl_Block_7a_1>();
                NICFields = fetchNICTask.Result ?? new List<Tbl_Block_7c_NIC>();
                block_4 = fetchBlock4Task.Result;
                Block7DList = fetchBlock7DTask.Result ?? new List<Tbl_Block_7d>();

                // Sync (but do not call StateHasChanged inside loops). These methods will perform DB saves
                // but we only update the in-memory list and then perform a single InvokeAsync(StateHasChanged).
                await SyncBlock7A_7DAsync_Batched();
                await SyncBlock4_7DAsync_Batched();
                await SyncBlock7C_7DAsync_Batched();
                await dQ.ReserializeBlock7DList();
            }
            else
            {
                Block7DList = await dQ.Fetch_SCH_HIS_Block7D();
            }


        }
        catch (Exception ex)
        {
            Console.WriteLine($"LoadAllDataSafeAsync error: {ex.Message}");
        }
        finally
        {
            _isBusy = false;
        }
    }

    int GetCurrentSerialNumber()
    {
        if (Block7DList != null)
        {
            return Block7DList.Count > 0 ? Block7DList.Count + 1 : 1;
        }
        return 1;
    }

    private async Task SyncBlock4_7DAsync_Batched()
    {
        // Add missing codes from CropCodeList into Block7DList in-memory first
        var toAdd = new List<Tbl_Block_7d>();
        if (block_4 != null)
        {
            bool item_3 = block_4.item_4_3.GetValueOrDefault();
            bool item_4 = block_4.item_4_4.GetValueOrDefault();
            bool item_5 = block_4.item_4_5.GetValueOrDefault();
            bool item_6 = block_4.item_4_6.GetValueOrDefault();

            //Need to define internal codes for the above items as they are not part of NIC CODES
            //item_3 -> 4003
            //item_4 -> 4004
            //item_5 -> 4005
            //item_6 -> 4006
            if (item_3)
            {
                bool exists = Block7DList.Any(d => d.code == 4003);
                if (!exists)
                {
                    var newEntry = new Tbl_Block_7d
                    {
                        id = Guid.NewGuid(),
                        serial_number = GetCurrentSerialNumber(),
                        code = 4003,
                        item_1 = 2,
                        item_2 = "Animal husbandry"
                    };
                    toAdd.Add(newEntry);
                }
            }
            if (item_4)
            {
                bool exists = Block7DList.Any(d => d.code == 4004);
                if (!exists)
                {
                    var newEntry = new Tbl_Block_7d
                    {
                        id = Guid.NewGuid(),
                        serial_number = GetCurrentSerialNumber(),
                        code = 4004,
                        item_1 = 3,
                        item_2 = "Fisheries"
                    };
                    toAdd.Add(newEntry);
                }
            }
            if (item_5)
            {
                bool exists = Block7DList.Any(d => d.code == 4005);
                if (!exists)
                {
                    var newEntry = new Tbl_Block_7d
                    {
                        id = Guid.NewGuid(),
                        serial_number = GetCurrentSerialNumber(),
                        code = 4005,
                        item_1 = 4,
                        item_2 = "Agroforestry activity"
                    };
                    toAdd.Add(newEntry);
                }
            }
            if (item_6)
            {
                bool exists = Block7DList.Any(d => d.code == 4006);
                if (!exists)
                {
                    var newEntry = new Tbl_Block_7d
                    {
                        id = Guid.NewGuid(),
                        serial_number = GetCurrentSerialNumber(),
                        code = 4006,
                        item_1 = 5,
                        item_2 = "Others (bee keeping, sericulture, lac culture, ancillary etc.)"
                    };
                    toAdd.Add(newEntry);
                }
            }
        }

        if (toAdd.Any())
        {
            // Save to DB but do it sequentially to avoid overwhelming the webview.
            foreach (var ne in toAdd)
            {
                try
                {
                    await dQ.Save_SCH_HIS_Block7D_List(ne);
                    Block7DList.Add(ne);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error saving Block7D new entry: {ex.Message}");
                }
            }
            // Single UI update after batch work
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SyncBlock7A_7DAsync_Batched()
    {
        // Add missing codes from CropCodeList into Block7DList in-memory first
        var toAdd = new List<Tbl_Block_7d>();
        foreach (var code in CropCodeList)
        {
            // assume mapping by code id is different - previously used id comparisons; adjust if needed
            bool exists = Block7DList.Any(d => d.code == code.code);
            if (!exists)
            {
                var newEntry = new Tbl_Block_7d
                {
                    id = Guid.NewGuid(),
                    block_7a_id = code.id,
                    serial_number = GetCurrentSerialNumber(),
                    code = code.code,
                    item_1 = code.serial_number,
                    item_2 = Block_7_1_Constants.CropCodes.FirstOrDefault(x => x.id == code.code)?.title ?? ""

                };
                toAdd.Add(newEntry);
            }
        }

        if (toAdd.Any())
        {
            // Save to DB but do it sequentially to avoid overwhelming the webview.
            foreach (var ne in toAdd)
            {
                try
                {
                    await dQ.Save_SCH_HIS_Block7D_List(ne);
                    Block7DList.Add(ne);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error saving Block7D new entry: {ex.Message}");
                }
            }
            // Single UI update after batch work
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SyncBlock7C_7DAsync_Batched()
    {
        var toAdd = new List<Tbl_Block_7d>();
        foreach (var code in NICFields)
        {
            bool exists = Block7DList.Any(d => d.code == code.NicCode);
            if (!exists)
            {
                var newEntry = new Tbl_Block_7d
                {
                    id = Guid.NewGuid(),
                    block_7c_id = code.id,
                    serial_number = GetCurrentSerialNumber(),
                    code = code.NicCode,
                    item_1 = code.SerialNumber,
                    item_2 = Block_4_Constants.NIC_CODES.FirstOrDefault(x => x.id == code.NicCode)?.title ?? ""

                };
                toAdd.Add(newEntry);
            }
        }

        if (toAdd.Any())
        {
            foreach (var ne in toAdd)
            {
                try
                {
                    await dQ.Save_SCH_HIS_Block7D_List(ne);
                    Block7DList.Add(ne);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error saving Block7D new NIC entry: {ex.Message}");
                }
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    // Handler for changing mode of operation (select)
    private void UpdateModeOfOperation(Tbl_Block_7d entry, ChangeEventArgs e)
    {
        if (entry == null) return;
        if (int.TryParse(e?.Value?.ToString(), out var val))
        {
            entry.item_3 = val;
            if (val == 1)
            {
                entry.item_4 = null; // Clear shareholding if individually operated
            }
        }
        else
        {
            entry.item_3 = null;
        }
        ValidateRow(entry);
    }

    private void UpdateShareholding(Tbl_Block_7d entry, ChangeEventArgs e)
    {
        if (entry == null) return;
        if (decimal.TryParse(e?.Value?.ToString(), out var val))
        {
            entry.item_4 = val;
        }
        else
        {
            entry.item_4 = null;
        }
        ValidateRow(entry);
    }


    async Task SaveClicked(bool is_go_next = false)
    {
        if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            Next();
            return;
        }
        // Simple guard
        bool hasErrors = false;
        foreach (var row in Block7DList)
        {
            ValidateRow(row);
            if (editContext.GetValidationMessages(new FieldIdentifier(row, nameof(row.item_3))).Any() ||
                editContext.GetValidationMessages(new FieldIdentifier(row, nameof(row.item_4))).Any())
            {
                hasErrors = true;
            }
        }

        if (hasErrors)
        {
            toastService.ShowError("Please resolve pending errors");
            return;
        }

        try
        {
            foreach (var item in Block7DList)
            {
                try
                {
                    await dQ.Save_SCH_HIS_Block7D_List(item);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Update_Block7D error: {ex.Message}");
                }
            }


            toastService.ShowSuccess("Saved successfully");
            // Single UI refresh at the end
            await InvokeAsync(StateHasChanged);

            if(is_go_next)
            {
                Next();
            }
            if (block_1 != null)
            {
                await dQ.SaveAsync<Tbl_Block_1>(block_1);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SaveClicked error: {ex.Message}");
            toastService.ShowError("Unable to save the data");
        }
        finally
        {
            _isBusy = false;
        }
    }

    //OnInitializedAsync
    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/his/block_7d",
            block_title = "HIS Block 7d",
            block_code = CommonEnum.his_block_7d.ToString(),
        };
        await commonQueries.InsertVisitedBlock(vb);
        StateHasChanged();
    }

    void Next()
    {
        NavigationManager.NavigateTo("/dashboard/his/block_8a");
    }
}
