@page "/dashboard/his/block_4_3"
@using Blazored.FluentValidation
@using FluentValidation
@using Income.Common.HIS2026
@using Income.Database.Models.Common
@using Income.Database.Models.HIS_2026
@using Income.Database.Models.SCH0_0
@using Income.Validators.HIS2026
@using Income.Viewmodels
@inject IJSRuntime JSRuntime
@layout Income.Components.Layout.DashboardLayout
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject Comment_vm comment_vm
@inject LocalizationService Loc
@inject IValidator<Tbl_Block_4> Validator


<div class="pb-5">

    <CommonContentHeader SelectedFsuId="@SessionStorage.SelectedFSUId"
                         survey_time="@survey_time" />

    <div class="card-style2 p-2">
        <div class="w-100 card-header d-flex justify-content-between">
            <p class="fs-5 m-0"><span class="text-primary me-2">[4]</span>Household Characteristics</p>
            <NavLink hidden="@((SessionStorage.role_name == CommonConstants.ROLE_NAME_JSO))" class="btn btn-outline-primary" @onclick="@(() => Comment())"><i class="bi bi-chat-left-text me-2"></i>Comment</NavLink>
        </div>
        <div class="card-container mt-2">
            @if (editContext != null)
            {
                <EditForm EditContext="editContext">
                    <FluentValidationValidator />
                    <div class="row card-body">

                        <!--4.6-->
                        <div class="mb-4 col-md-3">
                            <label class="form-label fw-bold">
                                <span class="badge bg-primary me-2">6</span>
                                Own any land (within the country)?
                            </label>
                            <select class="form-select w-100 is_sso"
                                    value="@block_4?.item_6"
                                    @onchange="item_6_changed"
                                    disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)">
                                <option value="">Select</option>
                                @if (commonList.LOOKUP_CONST_YES_NO != null)
                                {
                                    @foreach (var item in commonList.LOOKUP_CONST_YES_NO)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                }
                            </select>
                            <ValidationMessage For="@(() => block_4.item_6)" />
                        </div>

                        <!--4.7-->
                        <div class="mb-4 col-md-3">
                            <label class="form-label fw-bold">
                                <span class="badge bg-primary me-2">7</span>
                                If yes, total area (in acre)
                            </label>
                            <input type="text"
                                   class="form-control is_sso"
                                   value="@block_4.item_7"
                                   @oninput="OnItem7Changed"
                                   onkeypress="return /^(\d+(\.\d{0,3})?)?$/.test(this.value + event.key)"
                                   disabled="@(block_4?.item_6 != 1 || (hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12))" />
                            <ValidationMessage For="@(() => block_4.item_7)" />
                        </div>

                        <!--4.8-->
                        <div class="mb-4 col-md-6" hidden="@(block_4?.item_6 != 1)">
                            <label class="form-label fw-bold">
                                <span class="badge bg-primary me-2">8</span>
                                Use of land owned <small class="text-muted">(multiple select)</small>
                            </label>
                            <div class="d-flex flex-wrap">
                                @if (Block_4_Constants.Q4_8 != null && Block_4_Constants.Q4_8.Count > 0)
                                {
                                    @foreach (var item in Block_4_Constants.Q4_8)
                                    {
                                        <div class="form-check me-3 mb-1">
                                            <input class="form-check-input is_sso"
                                                   type="checkbox"
                                                   value="@item.id"
                                                   checked="@SelectedLandUses.Contains(item.id)"
                                                   @onchange="() => ToggleLandUse(item.id)"
                                                   disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)" />
                                            <label class="form-check-label">@item.title</label>
                                        </div>
                                    }
                                }
                            </div>
                            <ValidationMessage For="@(() => block_4.item_8)" />
                        </div>

                        <!-- Divider -->
                        <div class="col-12">
                            <hr class="border border-primary border-2 opacity-50 my-3" />
                        </div>

                        <!-- Row 1: Q4.9 and Q4.10 -->
                        <div class="row">
                            <!--4.9-->
                            <div class="mb-4 col-md-4">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">9</span>
                                    Does the household perform any economic activity on any building/structure during last 365 days?
                                </label>
                                <select class="form-select w-100 is_sso"
                                        @bind="block_4.item_9"
                                        disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)">
                                    <option value="">Select</option>
                                    @foreach (var item in Block_4_Constants.Q4_9)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                </select>
                            </div>

                            <!--4.10-->
                            <div class="mb-4 col-md-8" hidden="@(block_4?.item_9 != 1 && block_4?.item_9 != 2 && block_4?.item_9 != 3)">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">10</span>
                                    If codes 1–3 in Q4.9, type of economic activity(ies) (multiple select)
                                </label>
                                <div class="d-flex flex-wrap">
                                    @foreach (var item in Block_4_Constants.Q4_10)
                                    {
                                        <div class="form-check me-3 mb-1">
                                            <input class="form-check-input is_sso"
                                                   type="checkbox"
                                                   value="@item.id"
                                                   checked="@SelectedEconomicActivities.Contains(item.id)"
                                                   @onchange="() => ToggleEconomicActivity(item.id)"
                                                   disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)" />
                                            <label class="form-check-label">@item.title</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Q4.11 – Q4.14 -->
                        <div class="row">
                            <!--4.11-->
                            <div class="mb-4 col-md-3">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">11</span>Type of dwelling unit
                                </label>
                                <select class="form-select w-100 is_sso"
                                        @bind="block_4.item_11"
                                        disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)">
                                    <option value="">Select</option>
                                    @foreach (var item in Block_4_Constants.Q4_11)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                </select>
                            </div>

                            <!--4.12-->
                            <div class="mb-4 col-md-3" hidden="@(block_4.item_11 == 5 || block_4.item_11 == 0)">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">12</span>Carpet area (sq. ft.)
                                </label>
                                <input type="number"
                                       class="form-control is_sso"
                                       placeholder="e.g. 600"
                                       @bind="block_4.item_12"
                                       disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)" />
                            </div>

                            <!--4.13-->
                            <div class="mb-4 col-md-3" hidden="@(block_4.item_11 == 5 || block_4.item_11 == 0)">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">13</span>Type of structure
                                </label>
                                <select class="form-select w-100 is_sso"
                                        @bind="block_4.item_13"
                                        disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)">
                                    <option value="">Select</option>
                                    @foreach (var item in Block_4_Constants.Q4_13)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                </select>
                            </div>

                            <!--4.14-->
                            <div class="mb-4 col-md-3" hidden="@(block_4.item_11 == 5 || block_4.item_11 == 0)">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">14</span>Number of rooms
                                </label>
                                <input type="number"
                                       class="form-control is_sso"
                                       placeholder="e.g. 3"
                                       @bind="block_4.item_14"
                                       disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)" />
                            </div>
                        </div>

                        <!-- Row 3: Q4.15 – Q4.17 -->
                        <div class="row">
                            <!--4.15-->
                            <div class="mb-4 col-md-4">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">15</span>Outstanding loan from financial institution?
                                </label>
                                <select class="form-select w-100 is_sso"
                                        @bind="block_4.item_15"
                                        disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)">
                                    <option value="">Select</option>
                                    @foreach (var item in Block_4_Constants.Q4_15)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                </select>
                            </div>

                            <!--4.16-->
                            <div class="mb-4 col-md-4" hidden="@(block_4.item_15 != 1)">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">16</span>Purpose of the loan
                                </label>
                                <select class="form-select w-100 is_sso"
                                        @bind="block_4.item_16"
                                        disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)">
                                    <option value="">Select</option>
                                    @foreach (var item in Block_4_Constants.Q4_16)
                                    {
                                        <option value="@item.id">@item.title</option>
                                    }
                                </select>
                            </div>

                            <!--4.17-->
                            <div class="mb-4 col-md-4" hidden="@(block_4.item_15 != 1)">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary me-2">17</span>
                                    Amount paid towards repayment of loan in the last month (₹)
                                </label>
                                <input type="number"
                                       class="form-control is_sso"
                                       placeholder="e.g. 2500"
                                       @bind="block_4.item_17"
                                       disabled="@(hhdStatus != 0 && hhdStatus != 11 && hhdStatus != 12)" />
                            </div>
                        </div>

                        <div class="mb-3 col-12">
                            <label class="form-label fw-bold">Remarks</label>
                            <textarea type="text" class="form-control is_sso" disabled="@(SessionStorage.role_name != CommonConstants.ROLE_NAME_JSO))" placeholder="" cols="4"></textarea>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-outline-primary" onclick="@GoBack"><i class="bi bi-chevron-left me-1"></i>Back</button>
                        <div class="d-flex">
                            @if (SessionStorage.role_name == CommonConstants.ROLE_NAME_JSO)
                            {
                                <button type="button" class="btn btn-primary me-2 is_sso action" @onclick="@(() => Save())">
                                    <i class="bi bi-floppy-fill me-1"></i>Save
                                </button>
                            }
                            <NavLink class="btn btn-outline-primary" @onclick="@(() => Save(true))">Next<i class="bi bi-chevron-right ms-1"></i></NavLink>
                        </div>
                    </div>
                </EditForm>
            }
            
            

        </div>
    </div>
    </div>

     <Modal @ref="comment_vm.AddModal" Title="Comment" CloseOnEscape="true" UseStaticBackdrop="true" ShowCloseButton="false" Size="ModalSize.Large">
        <BodyTemplate>
            <div class="mb-3">
                <div class="row mb-2">
                    
                    <div class="col-6">
                        <label class="form-label fw-bold">
                            <span class="badge bg-primary me-2">2</span>Question Number
                        </label>
                        <select class="form-select w-100" @bind="comment_vm.item_no">
                            <option value="">Select</option>
                            @if (Question != null)
                            {
                                @foreach (var item in Question)
                                {
                                    <option value="@item">@item</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <label for="commentBox" class="form-label">Enter your comment</label>
                <textarea class="form-control" id="commentBox" rows="4" @bind="comment_vm.comment"></textarea>
                @if (comment_vm.ShowError)
                {
                    <div class="text-danger mt-2">Comment cannot be empty.</div>
                }
            </div>

            @if (CommentList != null)
            {
                <div style="overflow: auto;">
                    <table class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width: 200px;">Comment</th>
                                <th style="min-width: 100px;">Item Number</th>
                                <th style="min-width: 50px;">Member Srl.</th>
                                <th style="min-width: 20px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in CommentList)
                            {
                                <tr>
                                    <td>@item.comment</td>
                                    <td class="text-center">@item.item_no</td>
                                    <td class="text-center">@((item.serial_number == 0) ? "" : item.serial_number.ToString())</td>
                                    <td class="text-center">
                                        <button class="btn btn-success btn-sm me-2" @onclick="@(() => Update(item))" disabled="@((SessionStorage.user_role != item.role_code))"><i class="bi bi-check-circle me-1"></i>Edit</button>
                                        <button class="btn btn-danger btn-sm" @onclick="@(() => Delete(item))" disabled="@((SessionStorage.user_role != item.role_code))"><i class="bi bi-x-circle me-1"></i>Delete</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

        </BodyTemplate>
        <FooterTemplate>
            <Button class="btn btn-primary me-2" @onclick="@(() => Submit())"><i class="bi bi-check-circle me-1"></i>Submit</Button>
            <Button class="btn btn-outline-primary" @onclick="@(() => Close())"><i class="bi bi-x-circle me-1"></i>Close</Button>
        </FooterTemplate>
    </Modal>


@code {

    DateTime survey_time = DateTime.Now;
    int hhdStatus = 0;
    Tbl_Sch_0_0_Block_7? hhd;
    Tbl_Block_4? block_4;
    DBQueries dQ = new();

    Tbl_Comments comments = new();
    List<string> Question = new List<string>();
    List<Tbl_Comments> CommentList = new List<Tbl_Comments>();
    List<int> RowList = [];
    CommonList commonList = new();


    // Stores selected land use codes
    private List<int> SelectedLandUses = new();
    private List<int> SelectedActivities = new();

    private int selectedEconomicActivity;
    private List<int> SelectedEconomicActivities = new();
    private int selectedDwellingType;
    private double? CarpetArea;
    private int selectedStructureType;
    private int? NumberOfRooms;
    private int selectedLoanStatus;
    private int selectedLoanPurpose;
    private double? LoanRepaymentAmount;

    EditContext editContext;
    private Block_4_Validator validator = new();
    private ValidationMessageStore messageStore;


    protected override async Task OnInitializedAsync()
    {
        for (var i = 1; i <= 17; i++)
        {
            Question.Add(i.ToString());
        }

        CommentList = await comment_vm.LoadData("1");
        comment_vm.NotifyUiUpdate += StateHasChanged;
        if (SessionStorage.role_name != CommonConstants.ROLE_NAME_JSO)
        {
            await JSRuntime.InvokeVoidAsync("__disableFieldsAndButtons");
        }

        hhdStatus = await dQ.GetCurrentHHDStatus(SessionStorage.SelectedFSUId, SessionStorage.selected_hhd_id);

        var block3 = await dQ.Fetch_SCH_HIS_Block3(SessionStorage.selected_hhd_id);
        if (block3 != null && block3.Count > 0)
        {
            //Q4Needed = block3.Any(x => x.item_8 == 1 || x.item_9 == 1 || x.item_10 == 1);
        }
        block_4 = await dQ.Fetch_SCH_HIS_Block4(SessionStorage.selected_hhd_id) ?? null;
        if (block_4 != null)
        {
            editContext = new EditContext(block_4);
            messageStore = new ValidationMessageStore(editContext);
            editContext.OnFieldChanged += EditContext_OnFieldChanged;

        }
        StateHasChanged();
    }

    private void EditContext_OnFieldChanged(object sender, FieldChangedEventArgs e)
    {
        // Clear validation messages for this specific field
        messageStore.Clear(e.FieldIdentifier);

        // Update validation state
        editContext.NotifyValidationStateChanged();
    }


    private void item_6_changed(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();

        if (string.IsNullOrEmpty(value))
            block_4.item_6 = null;
        else
        {
            block_4.item_6 = int.Parse(value);
            if (block_4.item_6 == 2)
            {
                SelectedLandUses = [];
                block_4.item_7 = 0;
            }
            editContext?.NotifyFieldChanged(
            FieldIdentifier.Create(() => block_4.item_6));
        }
    }

    private void OnItem7Changed(ChangeEventArgs args)
    {
        if (decimal.TryParse(args.Value?.ToString(), out var result))
        {
            block_4.item_7 = result;
            editContext?.NotifyFieldChanged(
            FieldIdentifier.Create(() => block_4.item_7));
        }
        else
        {
            block_4.item_7 = null;
        }
    }

    async void Comment()
    {
        await comment_vm.AddModal.ShowAsync();
    }
    async Task Submit()
    {
        var data = await comment_vm.Save("1");
        // Reset fields
        comment_vm.Serialnumber = null;
        comment_vm.item_no = string.Empty;
        comment_vm.comment = string.Empty;
        if (data > 0)
        {
            CommentList = await comment_vm.LoadData("1");
        }
        StateHasChanged();
    }

    async void Close()
    {
        await comment_vm.AddModal.HideAsync();
    }

    async void Delete(Tbl_Comments data)
    {
        var DeleteResult = await comment_vm.Delete(data);
        if (DeleteResult > 0)
        {
            CommentList = await comment_vm.LoadData("1");
        }
        StateHasChanged();

    }

    void Update(Tbl_Comments data)
    {
        comment_vm.LoadDataById(data);
    }

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    private void ToggleEconomicActivity(int id)
    {
        if (SelectedEconomicActivities.Contains(id))
            SelectedEconomicActivities.Remove(id);
        else
            SelectedEconomicActivities.Add(id);
    }



    private void ToggleLandUse(int id)
    {
        if (SelectedLandUses.Contains(id))
            SelectedLandUses.Remove(id);
        else
            SelectedLandUses.Add(id);

        block_4.item_8 = SelectedLandUses.Any() ? string.Join(",", SelectedLandUses) : string.Empty;
        editContext?.NotifyFieldChanged(
            FieldIdentifier.Create(() => block_4.item_8));

        //Warnings for Item 8
    }

    private async Task Save(bool is_go_next = false)
    {
        if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            NavigationManager.NavigateTo("dashboard/his/block_5");
            return;
        }
        else
        {
            messageStore.Clear();
            var result = await Validator.ValidateAsync(block_4, options => options.IncludeRuleSets("Page3"));
            // 3. Push new messages
            foreach (var error in result.Errors)
            {
                var fieldIdentifier = new FieldIdentifier(block_4, error.PropertyName);
                messageStore.Add(fieldIdentifier, error.ErrorMessage);
            }

            // 4. Notify the UI
            editContext.NotifyValidationStateChanged();
            if (result.IsValid)
            {
                await dQ.Save_SCH_HIS_Block4(block_4);
                if (is_go_next)
                {
                    NavigationManager.NavigateTo("dashboard/his/block_5");
                }
            }
            else
            {
                toastService.ShowError("Please resolve pending errors");
            }
        }
    }

}