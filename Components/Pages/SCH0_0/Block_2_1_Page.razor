@page "/dashboard/sch0.0/block_2_1"
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using Income.Viewmodels.SCH0_0
@using System.Text.RegularExpressions
@layout Income.Components.Layout.DashboardLayout
@inject Block_2_1_VM block_2_1_VM
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject ILoggingService Logger


<div class="main-content">
    <CommonContentHeader 
    SelectedFsuId="@SelectedFsuId"
    survey_time="@survey_time" 
    />
    <ConfirmDialog @ref="dialog" />
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary fw-bolder me-2">[Block 2.1]</span>List of hamlets (only for rural samples with SU formation)
            </h3>
            @if (!SessionStorage.hamlet_selection_done)
            {
                <div class="card-tools">
                    <button class="btn btn-primary" @onclick="@(() => block_2_1_VM.AddRow())"><i class="fi fi-rr-plus me-1"></i>Add</button>
                </div>
            }
        </div>
        <div class="card-body p-0">
            <fieldset disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)">
                <div class="table-responsive">
                <table class="table table-striped table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Sl. no</th>
                            <th>Name of Hamlet</th>
                            <th>% of population</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (block_2_1_VM.tbl_Sch_0_0_block_2_1 != null && block_2_1_VM.tbl_Sch_0_0_block_2_1.Count > 0)
                        {
                            foreach (var item in block_2_1_VM.tbl_Sch_0_0_block_2_1)
                            {
                                @if (item.is_deleted != true)
                                {
                                    <tr>
                                        <td>@item.serial_no</td>
                                        <td><input maxlength="50" class="form-control form-control-sm" value="@item.hamlet_name" disabled="@(SessionStorage.hamlet_selection_done)" @onchange="@((ChangeEventArgs e) => block_2_1_VM.HandleChange(e, item.id, "name_of_hamlet"))"></td>
                                        <td><input type="number" step="0.1" min="0" max="100" disabled="@(SessionStorage.hamlet_selection_done)" class="form-control form-control-sm" value="@item.percentage" @oninput="(e => RestrictToOneDecimal(e, item))" onkeypress="return /^(\d+(\.\d?)?)?$/.test(event.target.value + event.key)"></td>
                                        @if (!SessionStorage.hamlet_selection_done)
                                        {
                                            <td>
                                            <button class="btn btn-link fs-6 text-danger" disabled="@(item.serial_no <= totalSU)" hidden="@(SessionStorage.hamlet_selection_done)" @onclick="@(() => block_2_1_VM.RemoveRow(item))"><i class="fi fi-rr-trash me-2"></i></button>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" class="bg-success"></td>
                            <td class="bg-success text-success fw-bolder">Total Population:- <span>@block_2_1_VM.Total_population_percentage.ToString() %</span></td>
                            <td class="bg-success"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            </fieldset>
        </div>
    </div>
</div>
<div class="footer">
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">Remarks</h3>
        </div>
        <div class="card-body">
            <fieldset disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)">
                <textarea maxlength="500" type="text" class="form-control disabled w-100" disabled="@SessionStorage.FSU_Submitted" @bind="@remarks" placeholder="Enter your remarks here..." rows="2" ></textarea>
            </fieldset>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6">
            <div class="d-flex">
                <NavLink class="btn btn-outline-secondary" onclick="@GoBack"><i class="fi fi-rr-angle-left me-1"></i>Back</NavLink>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                <NavLink class="btn btn-outline-primary me-2" hidden="@(!(SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO && !SessionStorage.hamlet_selection_done))" @onclick="@(() => HandleSubmit("SAVE"))"><i class="fi fi-rr-disk me-1"></i>Save</NavLink>
                <NavLink class="btn btn-primary" @onclick="@(() => HandleSubmit("NEXT"))">Next<i class="fi fi-rr-angle-right ms-1"></i></NavLink>
            </div>
        </div>
    </div>
</div>

    @* <div class="mt-1">
        <p class="m-0" style="color: white;">Test</p>
    </div> *@


@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries sch_0_0_Queries = new();
    private ConfirmDialog dialog = default!;
    string remarks = string.Empty;
    Tbl_Sch_0_0_Block_0_1 block_0_1 = new();
    private List<string> validationErrors = new();
    private string validationMessage = "";
    bool is_sel;
    int totalSU;
    async void GoBack()
    {
        NavigationManager.NavigateTo("/dashboard/sch0.0/block0_1");
        // await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    private void RestrictToOneDecimal(ChangeEventArgs e, Tbl_Sch_0_0_Block_2_1 row)
    {
        var input = e.Value?.ToString() ?? string.Empty;

        // Allow only valid numeric input with at most one decimal
        if (System.Text.RegularExpressions.Regex.IsMatch(input, @"^\d{0,3}(\.\d{0,1})?$"))
        {
            if (double.TryParse(input, out var value))
            {
                row.percentage = value;
            }
            else
            {
                row.percentage = null;
            }
            block_2_1_VM.HandleChange(e, row.id, "percentage");

        }
        else
        {
            // Reset to previous valid value if invalid input
            row.percentage = Math.Round(row.percentage.Value, 1);
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        //NavigationManager.LocationChanged += Nav_LocationChanged;
        is_sel = SessionStorage.hamlet_selection_done;
        block_2_1_VM.NotifyUiUpdate += StateHasChanged;
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/sch0.0/block_2_1",
            block_title = "Sch 0.0 Block 2.1",
            block_code = CommonEnum.sch_0_0_block_2_1.ToString(),
        };
        await commonQueries.InsertVisitedBlock(vb);
        await block_2_1_VM.Init(toastService);
        block_0_1 = await sch_0_0_Queries.FetchBlock1();
        var fsu_response = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
        if (fsu_response != null)
        {
            totalSU = fsu_response.totalsu.GetValueOrDefault();
        }
        remarks = block_0_1?.remarks_block_2_1;
        if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            survey_time = block_2_1_VM.tbl_Sch_0_0_block_2_1.FirstOrDefault()?.survey_timestamp.GetValueOrDefault() ?? DateTime.Now;
        }
        StateHasChanged();
    }

    private async void Nav_LocationChanged(object sender, LocationChangedEventArgs e)
    {
        if (e.IsNavigationIntercepted == false)
        {
            await OnInitializedAsync(); // replace with your initialization logic
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= Nav_LocationChanged;
    }

    private void ResetSerialNumbers()
    {
        int serial = 1;
        foreach (var item in block_2_1_VM.tbl_Sch_0_0_block_2_1)
        {
            if (item.is_deleted != true)
            {
                item.serial_no = serial;
                serial++;
            }
        }
    }

    async Task HandleSubmit(string action)
    {
        //Rules -
        //1. Total population percentage must be 100%
        //2. No hamlet name can be empty
        //3. Hamlet percentage cannot be zero/empty
        //4. Allow till one decimal place

        if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            if (SessionStorage.FSU_Sector == 1)
            {
                NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2R");
            }
            else if (SessionStorage.FSU_Sector == 2)
            {
                NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2U");
            }
            return;
        }

        var result = block_2_1_VM.Validate();
        if (result != null && result.Errors.Count > 0)
        {
            validationErrors = result.Errors;
            foreach (var err in validationErrors)
            {
                toastService.ShowError(err);
            }
            return;
        }


        await Save(action);

    }

    async Task Save(string action)
    {
        try
        {
            var response = await sch_0_0_Queries.SaveSCH0Block2_1(block_2_1_VM.tbl_Sch_0_0_block_2_1);
            if (response == null || response == 0)
            {
                toastService.ShowError("Error in saving data");
                return;
            }

            block_0_1.remarks_block_2_1 = remarks;
            await sch_0_0_Queries.SaveBlock1(block_0_1);
            
            if (action == "SAVE")
            {
                toastService.ShowSuccess("Saved successfully");
                return;
            }
            else if (action == "NEXT")
            {
                if (SessionStorage.FSU_Sector == 1)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2R");
                }
                else if (SessionStorage.FSU_Sector == 2)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2U");
                }
            }
        }
        catch (Exception ex)
        {

        }
        finally
        {
            
        }
    }

    
}

