@page "/dashboard/sch0.0/block_2_1"
@using Income.Database.Models.Common
@using Income.Viewmodels.SCH0_0
@layout Income.Components.Layout.DashboardLayout
@inject Block_2_1_VM block_2_1_VM
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService

<div class="my-2">
    <CommonContentHeader 
    SelectedFsuId="@SelectedFsuId"
    survey_time="@survey_time" 
    />
    <div class="card card-style2">
        <div class="card-header  d-flex align-items-center">
            <h3 class="card-title m-0 d-flex align-items-center">
                <span class="text-primary me-2">[Block 2.1]</span>List of hamlets (only for rural samples with SU formation)
            </h3>
            <button class="btn btn-primary btn-sm d-flex align-items-center ms-auto" @onclick="@(() => block_2_1_VM.AddRow())"><i class="bi bi-plus"></i> <span>Add</span></button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Sl. no</th>
                            <th>Name of Hamlet</th>
                            <th>% of population</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (block_2_1_VM.tbl_Sch_0_0_block_2_1 != null && block_2_1_VM.tbl_Sch_0_0_block_2_1.Count > 0)
                        {
                            foreach (var item in block_2_1_VM.tbl_Sch_0_0_block_2_1)
                            {
                                @if (item.is_deleted != true)
                                {
                                    <tr>
                                        <td>@item.serial_no</td>
                                        <td><input class="form-control form-control-sm" value="@item.hamlet_name" @onchange="@((ChangeEventArgs e) => block_2_1_VM.HandleChange(e, item.id, "name_of_hamlet"))"></td>
                                        <td><input type="number" class="form-control form-control-sm" value="@item.percentage" @onchange="@((ChangeEventArgs e) => block_2_1_VM.HandleChange(e, item.id, "percentage"))"></td>
                                        <td>
                                            <button class="btn btn-sm btn-danger d-flex align-items-center"><i class="bi bi-trash me-2"></i><span>Delete</span></button>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="2"></th>
                            <th colspan="2">@block_2_1_VM.total_population_percentage %</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <NavLink class="btn btn-outline-primary" onclick="@GoBack"><i class="bi bi-chevron-left me-1" ></i>Back</NavLink>
        <div class="d-flex">
            @* <NavLink class="btn btn-primary me-2" @onclick="@(() => HandleSubmit("SAVE"))"><i class="bi bi-floppy-fill me-1"></i>Save</NavLink> *@
            <NavLink class="btn btn-outline-primary" @onclick="@(() => HandleSubmit("NEXT"))">Next<i class="bi bi-chevron-right ms-1"></i></NavLink>
        </div>
    </div>

    <div class="mt-1">
        <p class="m-0" style="color: white;">Test</p>
    </div>
</div>

@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries sch_0_0_Queries = new();
    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    protected override async Task OnInitializedAsync()
    {
        block_2_1_VM.NotifyUiUpdate += StateHasChanged;
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/sch0.0/block_2_1",
            block_title = "Sch 0.0 Block 2.1",
            block_code = CommonEnum.sch_0_0_block_2_1.ToString(),
        };
        await commonQueries.InsertVisitedBlock(vb);
        await block_2_1_VM.Init();
        return;
    }

    async Task HandleSubmit(string action)
    {
        NavigationManager.NavigateTo("/dashboard/sch0.0/block_4_2");
        // string hamlet_name_error = string.Empty;
        // string pop_per_error = string.Empty;
        // string message = string.Empty;
        // if (block_2_1_VM.total_population_percentage != 100)
        // {
        //     message += "Population Percentage must be 100%! \n";
        // }
        // if (block_2_1_VM.tbl_Sch_0_0_block_2_1.Count > 0)
        // {
        //     foreach(var item in block_2_1_VM.tbl_Sch_0_0_block_2_1)
        //     {
        //         if ((string.IsNullOrEmpty(item.name_of_hamlet) || string.IsNullOrWhiteSpace(item.name_of_hamlet)) && item.is_deleted == false)
        //         {
        //             hamlet_name_error += $"{item.serial_no}, ";
        //         }
        //         Regex regex = new Regex(CommonConstants.REG_EXP_POSITIVE_NUMBER_ZERO);
        //         if (!regex.IsMatch(item.percentage_of_population.ToString()) && item.is_deleted == false)
        //         {
        //             pop_per_error += $"{item.serial_no}, ";
        //         }
        //     }
        //     if (!string.IsNullOrEmpty(hamlet_name_error) || !string.IsNullOrEmpty(pop_per_error))
        //     {
        //         message += $"Please provide hamlet name for serial number - {hamlet_name_error} \n Please check population percentage for serial number - {pop_per_error} \n";
        //     }
        // }
        // if (!string.IsNullOrEmpty(message))
        // {
        //     toastService.ShowError(message);
        //     return;
        // }
        // var response = await sch_0_0_Queries.SaveSCH0Block4_1(block_2_1_VM.tbl_Sch_0_0_block_2_1);
        // if (response == null || response == 0)
        // {
        //     toastService.ShowError("Error in saving data");
        //     return;
        // }
        // if (action == "SAVE")
        // {
        //     return;
        // }
        // else if (action == "NEXT")
        // {
        //     NavigationManager.NavigateTo("/dashboard/sch0.0/block_3");
        //     return;
        // }
    }
}

