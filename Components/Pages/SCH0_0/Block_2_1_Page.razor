@page "/dashboard/sch0.0/block_2_1"
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using Income.Viewmodels.SCH0_0
@using System.Text.RegularExpressions
@layout Income.Components.Layout.DashboardLayout
@inject Block_2_1_VM block_2_1_VM
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService

<div class="my-2">
    <CommonContentHeader 
    SelectedFsuId="@SelectedFsuId"
    survey_time="@survey_time" 
    />
    <div class="card card-style2">
        <div class="card-header  d-flex align-items-center">
            <h3 class="card-title m-0 d-flex align-items-center">
                <span class="text-primary me-2">[Block 2.1]</span>List of hamlets (only for rural samples with SU formation)
            </h3>
            <button class="btn btn-primary btn-sm d-flex align-items-center ms-auto" hidden="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO || SessionStorage.selection_done)" @onclick="@(() => block_2_1_VM.AddRow())"><i class="bi bi-plus"></i> <span>Add</span></button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered mb-0">
                    <thead>
                        <tr>
                            <th>Sl. no</th>
                            <th>Name of Hamlet</th>
                            <th>% of population</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (block_2_1_VM.tbl_Sch_0_0_block_2_1 != null && block_2_1_VM.tbl_Sch_0_0_block_2_1.Count > 0)
                        {
                            foreach (var item in block_2_1_VM.tbl_Sch_0_0_block_2_1)
                            {
                                @if (item.is_deleted != true)
                                {
                                    <tr>
                                        <td>@item.serial_no</td>
                                        <td><input class="form-control form-control-sm" value="@item.hamlet_name" disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO || SessionStorage.selection_done)" @onchange="@((ChangeEventArgs e) => block_2_1_VM.HandleChange(e, item.id, "name_of_hamlet"))"></td>
                                        <td><input type="number" step="0.1" min="0" max="100" disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO || SessionStorage.selection_done)" class="form-control form-control-sm" value="@item.percentage" @oninput="(e => RestrictToOneDecimal(e, item))" onkeypress="return /^(\d+(\.\d?)?)?$/.test(event.target.value + event.key)"></td>
                                        <td>
                                            <button class="btn btn-sm btn-danger d-flex align-items-center" hidden="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO || SessionStorage.selection_done)" @onclick="@(() => block_2_1_VM.RemoveRow(item))"><i class="bi bi-trash me-2"></i><span>Delete</span></button>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="2"></th>
                            <th colspan="2">@block_2_1_VM.Total_population_percentage.ToString() %</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <NavLink class="btn btn-outline-primary" onclick="@GoBack"><i class="bi bi-chevron-left me-1" ></i>Back</NavLink>
        <div class="d-flex">
            <NavLink class="btn btn-primary me-2" @onclick="@(() => HandleSubmit("SAVE"))"><i class="bi bi-floppy-fill me-1"></i>Save</NavLink>
            <NavLink class="btn btn-outline-primary" @onclick="@(() => HandleSubmit("NEXT"))">Next<i class="bi bi-chevron-right ms-1"></i></NavLink>
        </div>
    </div>

    <div class="mt-1">
        <p class="m-0" style="color: white;">Test</p>
    </div>
</div>

@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries sch_0_0_Queries = new();
    private List<string> validationErrors = new();
    private string validationMessage = "";
    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    private void RestrictToOneDecimal(ChangeEventArgs e, Tbl_Sch_0_0_Block_2_1 row)
    {
        var input = e.Value?.ToString() ?? string.Empty;

        // Allow only valid numeric input with at most one decimal
        if (System.Text.RegularExpressions.Regex.IsMatch(input, @"^\d{0,3}(\.\d{0,1})?$"))
        {
            if (double.TryParse(input, out var value))
            {
                row.percentage = value;
                block_2_1_VM.HandleChange(e, row.id, "percentage");
            }
        }
        else
        {
            // Reset to previous valid value if invalid input
            row.percentage = Math.Round(row.percentage.Value, 1);
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        block_2_1_VM.NotifyUiUpdate += StateHasChanged;
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/sch0.0/block_2_1",
            block_title = "Sch 0.0 Block 2.1",
            block_code = CommonEnum.sch_0_0_block_2_1.ToString(),
        };
        await commonQueries.InsertVisitedBlock(vb);
        await block_2_1_VM.Init();
        return;
    }

    async Task HandleSubmit(string action)
    {
        //Rules -
        //1. Total population percentage must be 100%
        //2. No hamlet name can be empty
        //3. Hamlet percentage cannot be zero/empty
        //4. Allow till one decimal place

        if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2");
            return;
        }
        
        var result = block_2_1_VM.Validate();
        if (result != null && result.Errors.Count > 0)
        {
            validationErrors = result.Errors;
            foreach (var err in validationErrors)
            {
                toastService.ShowError(err);
            }
            return;
        }

        var response = await sch_0_0_Queries.SaveSCH0Block2_1(block_2_1_VM.tbl_Sch_0_0_block_2_1);
        if (response == null || response == 0)
        {
            toastService.ShowError("Error in saving data");
            return;
        }
        if (action == "SAVE")
        {
            return;
        }
        else if (action == "NEXT")
        {
            NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2");
        }
    }
}

