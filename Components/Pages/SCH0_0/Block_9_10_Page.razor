@page "/dashboard/sch0.0/block_9"
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject ILoggingService Logger


<div class="main-content">
    <CommonContentHeader SelectedFsuId="@SelectedFsuId" />
    @* Enumerator Comments *@
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary fw-bolder me-2">[Block 9]</span> Remarks by Field Enumerator (FE)/Junior Statistical Officer (JSO)
            </h3>
        </div>
        <div class="card-body">
            <textarea maxlength="500" disabled="@SessionStorage.FSU_Submitted" class="form-control w-100" rows="4" placeholder="Enter your remarks here..." @bind="EnumeratorRemarks" ></textarea>
        </div>
    </div>
    @* Supervisor Comments *@
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary fw-bolder me-2">[Block 10]</span> Remarks by Field Supervisor (FS)/Senior Statistical Officer (SSO)
            </h3>
        </div>
        <div class="card-body">
            <textarea maxlength="500" disabled="@(!(SessionStorage.GetUserRole() == SessionStorage.UserRole.SSO))" class="form-control w-100" rows="4" placeholder="Enter your remarks here..." @bind="SupervisorRemarks" ></textarea>
        </div>
    </div>
</div>
<div class="footer">
    @* Remarks Card *@
    @* <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">Remarks</h3>
        </div>
        <div class="card-body">
            <textarea class="form-control disabled w-100" rows="2"></textarea>
        </div>
    </div> *@
    <div class="d-flex justify-content-between align-items-center">

        <!-- Left: Back button -->
        <div>
            <NavLink class="btn btn-outline-primary me-2" @onclick="GoBack">
                <i class="fi fi-rr-angle-left me-1"></i>Back
            </NavLink>
        </div>

        <!-- Right: Save + Next buttons -->
        <div class="d-flex">
            @if(ShowSaveButton)
            {
                <NavLink class="btn btn-outline-primary me-2"
                         hidden="@(SessionStorage.GetUserRole() == SessionStorage.UserRole.DS)"
                         @onclick="@(() => HandleSubmit(false))">
                    <i class="fi fi-rr-disk me-1"></i>Save
                </NavLink>
            }
            

            <NavLink class="btn btn-primary"
                     @onclick="@(() => HandleSubmit(true))">
                Next<i class="fi fi-rr-angle-right ms-1"></i>
            </NavLink>
        </div>

    </div>

</div>

@code {
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries SCH_0_0_Queries = new();
    bool is_error = false;
    Tbl_Sch_0_0_Block_0_1 tbl_Sch_0_0_Block_0_1 = new();
    string EnumeratorRemarks = string.Empty;
    string SupervisorRemarks = string.Empty;
    bool ShowSaveButton = false;
    [Inject] Repository? repository { get; set; }
    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/sch0.0/block_9",
            block_title = "Sch 0.0 Block 9/10",
            block_code = CommonEnum.sch_0_0_block_9.ToString(),
        };
        await commonQueries.InsertVisitedBlock(vb);
        tbl_Sch_0_0_Block_0_1 = await SCH_0_0_Queries.FetchBlock1();
        if (tbl_Sch_0_0_Block_0_1 != null)
        {
            EnumeratorRemarks = tbl_Sch_0_0_Block_0_1.EnumeratorRemarks ?? string.Empty;
            SupervisorRemarks = tbl_Sch_0_0_Block_0_1.SupervisorRemarks ?? string.Empty;
        }

        if (SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
        {
            ShowSaveButton = !SessionStorage.FSU_Submitted;
        }
        else if(SessionStorage.GetUserRole() == SessionStorage.UserRole.SSO)
        {
            ShowSaveButton = true;
        }
        else
        {
            ShowSaveButton = false;
        }

        StateHasChanged();
        return;
    }

    async void GoBack()
    {
        NavigationManager.NavigateTo("/dashboard/sch0.0/block_8");
        // await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    async Task HandleSubmit(bool go_next)
    {
        try
        {
            if (SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
            {
                tbl_Sch_0_0_Block_0_1.EnumeratorRemarks = EnumeratorRemarks.Trim();
            }
            else if (SessionStorage.GetUserRole() == SessionStorage.UserRole.SSO)
            {
                tbl_Sch_0_0_Block_0_1.SupervisorRemarks = SupervisorRemarks.Trim();
            }
            else
            {
                NavigationManager.NavigateTo("/dashboard/sch0.0/block_11");
                return;
            }
            //int update = await SCH_0_0_Queries.SaveBlock1(tbl_Sch_0_0_Block_0_1) ?? 0;
            int update = await repository.SaveAsync(tbl_Sch_0_0_Block_0_1);
            if (update > 0)
            {
                if (go_next)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_11");
                }
                else
                {
                    toastService.ShowSuccess("Data saved successfully.");
                }
            }
            
            else
            {
                toastService.ShowError("Failed to save data. Please try again.");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError("An error occurred while saving the data. Please try again.");
        }
        finally
        {
            
        }
    }
}
