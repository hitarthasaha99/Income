@page "/dashboard/sch0.0/block_7"
@using Blazored.FluentValidation
@using Income.Common.SCH0_0
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using Income.SurveyLibrary
@using Income.Validators.SCH0_0
@using System.Diagnostics
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject PreloadService preloadService

<style>
    .table-wrapper {
        max-height: 400px; /* adjust height */
        overflow-y: auto;
        display: block;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead th {
        position: sticky;
        top: 0;
        background: white; /* To cover rows scrolling under */
        z-index: 2;
    }

</style>
<GlobalErrorBoundary>
    <div class="my-2">
        <CommonContentHeader SelectedFsuId="@SelectedFsuId"
                             survey_time="@survey_time" />
        <ConfirmDialog @ref="dialog" />
        <div class="card card-style2">

            <!-- 🔹 Sticky Top Action Header -->
            <div class="card-header d-flex align-items-center sticky-top bg-white" style="z-index: 20;">
                <h3 class="card-title m-0 d-flex align-items-center">
                    <span class="text-primary me-1">[Block 7]</span>
                    List of households and selection of households for Schedule on HIS
                </h3>

                <div class="ms-auto d-flex gap-2" hidden="@SessionStorage.selection_done">
                    <button class="btn btn-primary btn-sm d-flex align-items-center" @onclick="@(() => HandleModal("ADD"))">
                        <i class="bi bi-plus"></i> <span class="ms-1">Add</span>
                    </button>

                    <button class="btn btn-primary btn-sm d-flex align-items-center" @onclick="@(() => Generate())">
                        <i class="bi bi-gear"></i> <span class="ms-1">Generate</span>
                    </button>
                </div>
            </div>

            <!-- 🔹 Scrollable table -->
            <div class="card-body p-0" style="max-height: 65vh; overflow-y: auto;">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="table-light sticky-top" style="top: 1px; z-index: 10;">
                        <tr>
                            <th>Srl.No.</th>
                            <th>House Number</th>
                            <th>Is the house used only for non-residential purposes? (yes-1, no-2)</th>
                            <th>Household Serial Number</th>
                            <th>Name of the head of the household</th>
                            <th>Household Size</th>
                            <th>Highest education level attained among the household members (entry in code) – (for urban only) code 2 in item 5 of Block 1)</th>
                            <th>Household Type</th>
                            <th>Total amount of land owned (possessed or leased out) by the household as on the date of the survey (in acres in three places of decimal) – ((for rural only) code 1 in item 5 of Block 1)</th>
                            <th>Usual monthly consumption expenditure of the household (Rs.)</th>
                            <th>SSS number for Schedule HIS 2026</th>
                            <th>Selected</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <th>(0)</th>
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                            <th>(5)</th>
                            <th>(6)</th>
                            <th>(7)</th>
                            <th>(8)</th>
                            <th>(9)</th>
                            <th>(10)</th>
                            <th>(11)</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (ListItems != null && ListItems.Count > 0)
                        {
                            foreach (var item in ListItems)
                            {
                                if (item.is_deleted != true)
                                {
                                    <tr>
                                        <td>@item.Block_7_1</td>
                                        <td>@item.Block_7_2</td>
                                        <td>@item.is_household</td>
                                        <td>@item.Block_7_3</td>
                                        <td>@item.Block_7_4</td>
                                        <td>@item.Block_7_5</td>
                                        <td>@item.Block_7_6</td>
                                        <td>@item.Block_7_7</td>
                                        <td>@item.Block_7_8</td>
                                        <td>@item.Block_7_9</td>
                                        <td>@item.SSS</td>
                                        <td><input type="checkbox" @bind="item.isSelected" disabled /></td>

                                        <td class="d-flex align-items-center">
                                            <button class="btn btn-sm btn-primary me-2"
                                                    @onclick="@(() => HandleModal("UPDATE", item))">
                                                <i class="bi bi-pencil-square me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-danger"
                                                    @onclick="@(() => HandleDelete(item.id))">
                                                <i class="bi bi-trash me-1"></i>Delete
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 🔹 Footer Navigation (Always visible) -->
        <div class="d-flex justify-content-between mt-3">
            <NavLink class="btn btn-outline-primary" onclick="@GoBack">
                <i class="bi bi-chevron-left me-1"></i>Back
            </NavLink>

            <NavLink class="btn btn-outline-primary" @onclick="@(() => HandleSubmit("NEXT"))">
                Next<i class="bi bi-chevron-right ms-1"></i>
            </NavLink>
        </div>

        <Modal @ref="AddModal" CloseOnEscape="false" UseStaticBackdrop="true" ShowCloseButton="false">
            <HeaderTemplate>
                <h5 class="modal-title">@((isAdd ? "Add Household" : "Update Household"))</h5>
            </HeaderTemplate>
            <BodyTemplate>
                @if (fields != null)
                {
                    <EditForm EditContext="@editContext" OnValidSubmit="@HandleAddRow">
                        <FluentValidationValidator />

                        <div class="container-fluid">
                            <div class="row g-3">
                                <!-- Serial Number -->
                                <div class="col-md-6">
                                    <label class="form-label">0. Serial Number of Row</label>
                                    <InputNumber class="form-control form-control-sm" @bind-Value="fields.Block_7_1" Disabled="true" />
                                </div>

                                <!-- House Number -->
                                <div class="col-md-6">
                                    <label class="form-label">1. House Number</label>
                                    <InputText class="form-control form-control-sm"
                                               @bind-Value="fields.Block_7_2"
                                                />
                                    <ValidationMessage For="@(() => fields.Block_7_2)" />
                                </div>

                                <!-- Is Household -->
                                <div class="col-md-6">
                                    <label class="form-label">2. Is the house for non-residential purposes?</label>
                                    <InputSelect class="form-select form-select-sm" @bind-Value="fields.is_household" oninput="@(((ChangeEventArgs e) => OnIsHouseholdChanged(e)))">
                                        <option value="">- Select -</option>
                                        @if (commonList?.LOOKUP_CONST_YES_NO != null)
                                        {
                                            foreach (var item in commonList.LOOKUP_CONST_YES_NO)
                                            {
                                                <option value="@item.id">@item.title</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => fields.is_household)" />
                                </div>

                                <!-- Household Serial Number -->
                                <div class="col-md-6">
                                    <label class="form-label">3. Household Serial Number</label>
                                    <InputNumber class="form-control form-control-sm" @bind-Value="fields.Block_7_3" Disabled="true" />
                                </div>

                                <!-- Head of Household Name -->
                                <div class="col-md-6" hidden="@(fields.is_household == 1)">
                                    <label class="form-label">4. Name of Head of Household</label>
                                    <InputText class="form-control form-control-sm"
                                               onkeypress="return /^[A-Za-z ]*$/.test(event.target.value + event.key)"
                                               @bind-Value="fields.Block_7_4"
                                               @oninput="OnHeadNameInput"/>
                                    <ValidationMessage For="@(() => fields.Block_7_4)" />
                                </div>


                                <!-- Household Size -->
                                <div class="col-md-6" hidden="@(fields.is_household == 1)">
                                    <label class="form-label">5. Household Size</label>
                                    <InputNumber class="form-control form-control-sm"
                                                 @bind-Value="fields.Block_7_5"
                                                  />
                                    <ValidationMessage For="@(() => fields.Block_7_5)" />
                                </div>

                                <!-- Highest Education Level -->
                                <div class="col-md-6" hidden="@(fields.is_household == 1)">
                                    <label class="form-label">6. Highest Education Level (Urban only)</label>
                                    <InputSelect class="form-select form-select-sm"
                                                 @bind-Value="fields.Block_7_6" Disabled="@(sector == 1)">
                                        <option value="">- Select -</option>
                                        @if (Block_7_Constants.HighestEdu != null)
                                        {
                                            foreach (var item in Block_7_Constants.HighestEdu)
                                            {
                                                <option value="@item.id">@item.title</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => fields.Block_7_6)" />
                                </div>

                                <!-- Household Type -->
                                <div class="col-md-6" hidden="@(fields.is_household == 1)">
                                    <label class="form-label">7. Household Type</label>
                                    <InputSelect class="form-select form-select-sm" @bind-Value="fields.Block_7_7">
                                        <option value="">- Select -</option>
                                        @if (Block_7_Constants.HighestEdu != null)
                                        {
                                            foreach (var item in Block_7_Constants.HighestEdu)
                                            {
                                                <option value="@item.id">@item.title</option>
                                            }
                                        }
                                        else if (sector != 1 && Block_7_Constants.HHDTypeUrban != null)
                                        {
                                            foreach (var item in Block_7_Constants.HHDTypeUrban)
                                            {
                                                <option value="@item.id">@item.title</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => fields.Block_7_7)" />
                                </div>

                                <!-- Total Land Owned -->
                                <div class="col-md-6" hidden="@(fields.is_household == 1)">
                                    <label class="form-label">8. Total Land Owned (Rural only)</label>
                                    <InputNumber class="form-control form-control-sm no-spinner"
                                                 @bind-Value="fields.Block_7_8"
                                                 step="any"
                                                 Disabled="@(sector == 2)"
                                                 onkeypress="return /^(\d+(\.\d{0,3})?)?$/.test(event.target.value + event.key)" />
                                    <ValidationMessage For="@(() => fields.Block_7_8)" />
                                </div>

                                <!-- Monthly Expenditure -->
                                <div class="col-md-6" hidden="@(fields.is_household == 1)">
                                    <label class="form-label">9. Usual Monthly Consumption Expenditure</label>
                                    <InputNumber class="form-control form-control-sm no-spinner"
                                                 step="any"
                                                 @bind-Value="fields.Block_7_9"
                                                 oninput="this.value=this.value.replace(/[^0-9]/g,'')" />
                                    <ValidationMessage For="@(() => fields.Block_7_9)" />
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-outline-primary"
                                    @onclick="@(() => HandleModal("CLOSE"))">
                                Close
                            </button>
                        </div>
                    </EditForm>
                }



            </BodyTemplate>


        </Modal>
    </div>
</GlobalErrorBoundary>



@code {
    EditContext editContext;
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries SCH_0_0_Queries = new();
    CommonConfig commonConfig = new();
    Modal AddModal = default;
    public int sector { get; set; } = 0;
    Tbl_Sch_0_0_Block_7 fields = new();
    List<Tbl_Sch_0_0_Block_7> ListItems = new();
    ValidationComponent house_number_ref = new();
    ValidationComponent purpose_ref = new();
    ValidationComponent head_name_ref = new();
    ValidationComponent size_ref = new();
    CommonList commonList = new();
    Tbl_Sch_0_0_Block_0_1 block_1_obj;
    private ValidationMessageStore messageStore;
    private ConfirmDialog dialog = default!;

    bool isAdd = false;

    CommonFunction commonFunctions = new();
    bool is_error = false;

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }
    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
            {
                block_uri = "/dashboard/sch0.0/block_7",
                block_title = "Sch 0.0 Block 7",
                block_code = CommonEnum.sch_0_0_block_7.ToString(),
            };

        await commonQueries.InsertVisitedBlock(vb);
        var block_0_1 = await SCH_0_0_Queries.FetchBlock1();
        if (block_0_1 != null)
        {
            block_1_obj = block_0_1;
            SessionStorage.FSU_Sector = sector = block_0_1.Block_1_5.GetValueOrDefault();
        }
        var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
        if (response != null && response.Count > 0)
        {
            ListItems = new();
            ListItems = response.OrderBy(x => x.Block_7_1).ToList();
            StateHasChanged();
        }
        return;
    }

    private void OnIsHouseholdChanged(ChangeEventArgs e)
    {
        var selectedValue = e.Value?.ToString();

        if (selectedValue == "1")
        {
            fields.Block_7_4 = string.Empty;
            fields.Block_7_5 = 0;
            fields.Block_7_6 = null;
            fields.Block_7_7 = null;
            fields.Block_7_8 = null;
            fields.Block_7_9 = 0;
            fields.Block_7_3 = 0;
        }
        else if (selectedValue == "2")
        {
        }

    }


    private async Task LoadData()
    {
        var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
        if (response != null && response.Count > 0)
        {
            ListItems?.Clear();
            ListItems?.AddRange(response.OrderBy(x => x.Block_7_1).ToList());
            StateHasChanged();
        }
    }

    /// <summary>
    /// Generates true random households based on sector(n=size)
    /// Weightage - 80% households and 20% non-households
    /// </summary>
    /// <returns></returns>
    private async Task Generate()
    {
        try
        {
            List<Tbl_Sch_0_0_Block_7> generatedHHDs = new();
            var education_levels = Block_7_Constants.HighestEdu.Select(x => x.id).ToArray();
            var household_types = sector == 1 ? Block_7_Constants.HHDTypeRural.Select(x => x.id).ToArray() : Block_7_Constants.HHDTypeUrban.Select(x => x.id).ToArray();
            int size = 700;
            Random gen = new();
            for(int i = 1; i<=size; i++)
            {
                Tbl_Sch_0_0_Block_7 obj = new();
                obj.id = Guid.NewGuid();
                obj.is_household = (gen.NextDouble() < 0.8) ? 2 : 1;
                obj.Block_7_1 = generatedHHDs.Count > 0 ?  (generatedHHDs.Max(x => x.Block_7_1.GetValueOrDefault())  + 1) : 1;
                obj.Block_7_2 = $"H-{obj.Block_7_1}";
                obj.Block_7_3 = obj.is_household == 2 ? (generatedHHDs.Count > 0 ? (generatedHHDs.Max(x => x.Block_7_3.GetValueOrDefault()) + 1) : 1) : 0;
                obj.Block_7_4 = $"Head {obj.Block_7_1}";
                obj.Block_7_5 = obj.is_household == 2 ? gen.Next(1, 11) : 0;
                obj.Block_7_6 = obj.is_household == 2 ? (sector == 1 ? null : education_levels[gen.Next(education_levels.Length)]) : null;
                obj.Block_7_7 = obj.is_household == 2 ? household_types[gen.Next(household_types.Length)] : null;
                obj.Block_7_8 = obj.is_household == 2 ? (sector == 1 ? Math.Round(gen.NextDouble() * 5, 3) : null) : 0;
                obj.Block_7_9 = obj.is_household == 2 ? gen.Next(5000, 100000) : 0;
                obj.UMPCE = obj.is_household == 2 ? (obj.Block_7_9 / obj.Block_7_5) : 0;
                generatedHHDs.Add(obj);
            }
            var response = await SCH_0_0_Queries.SaveBulkBlock7(generatedHHDs);
            await LoadData();
        }
        catch(Exception ex)
        {
            toastService.ShowError($"Getting Error while generating households {ex}, Please try again!");
        }
    }

    private async Task CalculateSSS()
    {
        //1. Separate logic for rural (consider both A and B) and urban (only A)
        //2. A - Arrange usual monthly consumption expenditure (Block_7_9) in ascending order and find median
        //3. B - Arrange land area (Block_7_8) in ascending order and find 60th percentile value
        //4. Calculate SSS using formula below -
        /*
         * Rural:
         * SSS - 11 = Block_7_7 = 1 and Block_7_8 < B
         * SSS - 12 = Block_7_7 = 1 and Block_7_8 >= B
         * SSS - 21 = Block_7_7 = 2 and Block_7_9 < A
         * SSS - 22 = Block_7_7 = 2 and Block_7_9 >= A
         * SSS - 31 = Block_7_7 = 3 and Block_7_9 < A
         * SSS - 32 = Block_7_7 = 3 and Block_7_9 >= A
         * SSS - 40 = Block_7_7 = 4
         * SSS - 90 = Block_7_7 = 9
         * Urban:
         * SSS - 11 = Block_7_7 = 1 and Block_7_9 < A
         * SSS - 121 = Block_7_7 = 1 and Block_7_9 >= A and Block_7_6 in [1,2,3,4,5,6]
         * SSS - 122 = Block_7_7 = 1 and Block_7_9 >= A and Block_7_6 in [7,8,10,11]
         * SSS - 21 = Block_7_7 = 2 and Block_7_9 < A
         * SSS - 221 = Block_7_7 = 2 and Block_7_9 >= A and Block_7_6 in [1,2,3,4,5,6]
         * SSS - 222 = Block_7_7 = 2 and Block_7_9 >= A and Block_7_6 in [7,8,10,11]
         * SSS - 40 = Block_7_7 = 3
         * SSS - 90 = Block_7_7 in [4,9]
         */
        try
        {
            preloadService.Show(SpinnerColor.Info, "Assigning SSS");
            // Fetch data
            var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
           
            if (response == null || response.Count == 0)
                return;

            response = response.Where(x => x.is_household == 2).ToList(); // Consider only households
            // --- Calculate A: median of Block_7_9 ---
            var allExpenditure = response.Where(x => x.UMPCE.HasValue)
                             .Select(x => (decimal)x.UMPCE.Value)
                             .OrderBy(x => x)
                             .ToList();

            decimal A = 0;
            int count = allExpenditure.Count;

            if (count > 0)
            {
                if (count % 2 == 1)
                    A = allExpenditure[count / 2];
                else
                    A = (allExpenditure[(count / 2) - 1] + allExpenditure[count / 2]) / 2;
            }


            // --- Calculate B: 60th percentile of Block_7_8 ---
            var landAreas = response.Where(x => x.Block_7_8.HasValue)
                                    .Select(x => x.Block_7_8.Value)
                                    .OrderBy(x => x)
                                    .ToList();
            decimal B = 0;
            int landCount = landAreas.Count;
            if (landCount > 0)
            {
                double percentileIndex = 0.6 * (landCount - 1);
                int lowerIndex = (int)Math.Floor(percentileIndex);
                int upperIndex = (int)Math.Ceiling(percentileIndex);
                B = (decimal)(landAreas[lowerIndex] + (landAreas[upperIndex] - landAreas[lowerIndex]) * (percentileIndex - lowerIndex));
            }

            // --- Assign A and B to each household ---
            foreach (var item in response)
            {
                item.a = A;
                item.b = B;
            }

            // --- Assign SSS based on sector ---
            foreach (var item in response)
            {
                int block7 = item.Block_7_7 ?? 0;
                var expenditure = item.UMPCE ?? 0;
                double landArea = item.Block_7_8 ?? 0;
                int education = item.Block_7_6 ?? 0;

                if (sector == 1) // Rural
                {
                    switch (block7)
                    {
                        case 1:
                            item.SSS = landArea < (double)B ? 11 : 12;
                            item.Stratum = 10;
                            break;
                        case 2:
                            item.SSS = expenditure < (int)A ? 21 : 22;
                            item.Stratum = 20;
                            break;
                        case 3:
                            item.SSS = expenditure < (int)A ? 31 : 32;
                            item.Stratum = 30;
                            break;
                        case 4:
                            item.SSS = 40;
                            item.Stratum = 40;
                            break;
                        case 9:
                            item.SSS = 90;
                            item.Stratum = 90;
                            break;
                        default:
                            item.SSS = 0;
                            item.Stratum = 0;
                            break;
                    }
                }
                else if (sector == 2) // Urban
                {
                    switch (block7)
                    {
                        case 1:
                            item.Stratum = 10;
                            if (expenditure < (int)A)
                                item.SSS = 11;
                            else if (new int[] { 1, 2, 3, 4, 5, 6 }.Contains(education))
                                item.SSS = 121;
                            else if (new int[] { 7, 8, 10, 11 }.Contains(education))
                                item.SSS = 122;
                            else
                                item.SSS = 0;
                            break;

                        case 2:
                            item.Stratum = 20;
                            if (expenditure < (int)A)
                                item.SSS = 21;
                            else if (new int[] { 1, 2, 3, 4, 5, 6 }.Contains(education))
                                item.SSS = 221;
                            else if (new int[] { 7, 8, 10, 11 }.Contains(education))
                                item.SSS = 222;
                            else
                                item.SSS = 0;
                            break;

                        case 3:
                            item.Stratum = 40;
                            item.SSS = expenditure < (int)A ? 40 : 0;
                            break;

                        case 4:
                        case 9:
                            item.Stratum = 90;
                            item.SSS = 90;
                            break;

                        default:
                            item.Stratum = 0;
                            item.SSS = 0;
                            break;
                    }
                }
            }

            // Optionally: Save updated response to database here
            var update = await SCH_0_0_Queries.SaveSSSToDatabase(response);
            if (update == 1)
            {
                toastService.ShowSuccess("SSS assignment successful");
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            // Handle/log exception
            Console.WriteLine(ex.Message);
        }
        finally
        {
            preloadService.Hide();
        }
    }

    async Task DoSelection()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Doing Selection, Please wait...");
            List<SSSItem> s1List = new List<SSSItem>();

            await SCH_0_0_Queries.UpdateAllRowsForColumnAsync(SessionStorage.SelectedFSUId);
            var existingListingData = await SCH_0_0_Queries.Get_SCH0_0_Block_5A_HouseHoldBy_FSUP(SessionStorage.SelectedFSUId);
            var sss_selection_done = existingListingData.Any(x => x.SSS != 0);

            if (sss_selection_done == false)
            {
                toastService.ShowError("Please calculate SSS before doing selection, Please try again!");
                return;
            }

            if (existingListingData.Count > 0)
            {
                var config = SelectionConfigFactory.Build(sector);
                var selector = new HouseholdSelector(config, randomSeed: 42);
                var result = selector.Select(existingListingData, sector);

                foreach (var item in result.Households)
                {
                    await SCH_0_0_Queries.Update_SCH0_0_Block_7(item);
                }

                Debug.WriteLine("Selected households:");
                foreach (var hh in result.Households.Where(h => h.isSelected))
                {
                    Debug.WriteLine($"Id={hh.Block_7_3} Stratum={hh.Stratum} FromSSS={hh.SelectedFromSSS} PostedSSS={hh.SelectedPostedSSS}");
                }

                Debug.WriteLine("\nLogs:");
                foreach (var log in result.Logs)
                {
                    Debug.WriteLine($"{log.HouseholdId} origSSS={log.OriginalSSS} posted={log.PostedSSS} note={log.Reason}");
                }
                toastService.ShowSuccess("Selection done successfully!");
                await LoadData();
                
            }

        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during selection: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }



    async Task HandleSubmit(string action = "")
    {
        int total_listed_population = ListItems.Sum(x => x.Block_7_5.GetValueOrDefault());
        int no_of_sd = block_1_obj.number_of_sub_division_of_su_to_be_formed.GetValueOrDefault();
        int su_population = block_1_obj.approximate_population_su.GetValueOrDefault();

        int approx_population_fsu = block_1_obj.Block_1_14.GetValueOrDefault();
        int number_of_sub_units = block_1_obj.Block_1_15.GetValueOrDefault();

        int listedTotal = total_listed_population * no_of_sd;

        double lowerLimit = su_population * 0.95;
        double upperLimit = su_population * 1.05;

        bool isWithin5Percent = listedTotal >= lowerLimit && listedTotal <= upperLimit;
        if (!isWithin5Percent)
        {
            string validationMessage = $"Population mismatch: {listedTotal} should be within ±5% of {su_population}.\nDo you want to continue?";
            var options = new ConfirmDialogOptions { IsVerticallyCentered = true };
            var confirmation = await dialog.ShowAsync(
                title: "Alert",
                message1: validationMessage,
                confirmDialogOptions: options);

            if (confirmation)
            {
                NavigationManager.NavigateTo("/dashboard/sch0.0/block_7_selection");
            }
        }
        else
        {
            NavigationManager.NavigateTo("/dashboard/sch0.0/block_7_selection");
        }
    }

    async Task HandleDelete(Guid id)
    {
        int item_index = ListItems.FindIndex(l => l.id == id);
        if (item_index != -1)
        {
            ListItems[item_index].is_deleted = true;
            await SCH_0_0_Queries.DeleteHHD(id);
            toastService.ShowSuccess("Row deleted successfully!");
            await LoadData();
        }
        else
        {
            toastService.ShowError("Not Able to delete row, Please try again!");
            return;
        }
    }

    async Task HandleModal(string action = "", Tbl_Sch_0_0_Block_7? data = null)
    {
        try
        {
            if (action == "ADD")
            {
                isAdd = true;
                if (data == null)
                {
                    fields = new();
                    fields.id = Guid.NewGuid();
                    fields.Block_7_1 = ReturnHHDSerialNumber().GetValueOrDefault();
                    fields.Block_7_3 = ReturnHHDSamplingSerialNumber().GetValueOrDefault();
                }
                else
                {
                    fields = data;
                }
                // Recreate EditContext for the new model
                editContext = new EditContext(fields);
                messageStore = new ValidationMessageStore(editContext);
                editContext.OnFieldChanged += ClearFieldErrorsOnChange;

                await AddModal.ShowAsync();
            }
            else if (action == "UPDATE")
            {
                isAdd = false;
                if (data != null)
                {
                    fields = data;
                    // Recreate EditContext for the new model
                    editContext = new EditContext(fields);
                    messageStore = new ValidationMessageStore(editContext);
                    editContext.OnFieldChanged += ClearFieldErrorsOnChange;
                    await AddModal.ShowAsync();
                }
            }
            else
            {
                await AddModal.HideAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }

    }

    private void ClearFieldErrorsOnChange(object? sender, FieldChangedEventArgs e)
    {
        // Remove only that field's messages
        messageStore.Clear(e.FieldIdentifier);

        // Tell Blazor to re-render the validation summary/messages
        editContext.NotifyValidationStateChanged();
    }

    private void OnHeadNameInput(ChangeEventArgs e)
    {
        fields.Block_7_4 = e.Value?.ToString() ?? string.Empty;

        var fieldIdentifier = editContext.Field(nameof(fields.Block_7_4));
        messageStore.Clear(fieldIdentifier);
        editContext.NotifyValidationStateChanged();

        // Optional: if you want live revalidation after clearing:
        editContext.Validate();

        StateHasChanged();
    }


    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (editContext != null)
        {
            editContext.Validate();
            StateHasChanged();
        }
    }

    /// <summary>
    /// Save or Update Row
    /// </summary>
    /// <returns></returns>
    async Task HandleAddRow()
    {
        var block_5_obj = fields;
        if (block_5_obj != null)
        {
            await SCH_0_0_Queries.SaveUpdateSCH0Block7(block_5_obj);
        }
        await AddModal.HideAsync();
        await LoadData();
               
    }

    int? ReturnHHDSerialNumber()
    {
        try
        {
            // Get the maximum Block_7_1 value from non-deleted items
            if (ListItems.Count() > 0)
            {
                return ListItems.Max(x => x.Block_7_1.GetValueOrDefault()) + 1;
            }
            else
            {
                return 0;
            }
        }
        catch(Exception ex)
        {
            toastService.ShowError($"Getting Error while generating Household Serial Number {ex}, Please try again!");
            return 0;
        }
    }

    int? ReturnHHDSamplingSerialNumber()
    {
        try
        {
            // Get the maximum Block_7_1 value from non-deleted items
            if (ListItems.Count() > 0)
            {
                var households = ListItems.Where(x => x.is_household == 2);
                if (households != null && households.Count() > 0)
                {
                    return households.Max(x => x.Block_7_3.GetValueOrDefault()) + 1;
                }
                else
                {
                    return 0;
                }
            }
            else
            {
                return 0;
            }
        }
        catch(Exception ex)
        {
            toastService.ShowError($"Getting Error while generating Household sampling Serial Number {ex}, Please try again!");
            return 0;
        }
    }
}
