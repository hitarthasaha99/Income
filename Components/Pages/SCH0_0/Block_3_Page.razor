@page "/dashboard/sch0.0/block_3/{is_sub_unit:bool}"
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using SkiaSharp
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject IToastService toastService
@inject NavigationManager NavigationManager
@inject ILoggingService Logger


<div class="main-content">
    <CommonContentHeader 
        SelectedFsuId="@SelectedFsuId"
        survey_time="@survey_time" 
    />
    <ConfirmDialog @ref="dialog" />
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary fw-bolder me-2">@block</span>@block_heading
            </h3>
            <span class="text-primary me-2"></span>
        </div>
        <div class="card-body">
            <fieldset disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)">
                <div class="card p-4 d-flex align-items-center">
                @if(!string.IsNullOrEmpty(file.file_image_source))
                {
                        <img src="@file.file_image_source" alt="sketch map" title="Sketch Map" height="400" class="img-fluid"/>
                }
            
                @if(!SessionStorage.selection_done)
                {
                    <div class="d-flex align-items-center mt-3">
                        <button class="btn btn-outline-primary d-flex align-items-center me-2" hidden=@SessionStorage.FSU_Submitted @onclick="@(() => FileHandler("CAMERA"))"><i class="fi fi-rr-camera me-2"></i>Open Camera</button>
                        <button class="btn btn-primary d-flex align-items-center me-2" hidden=@SessionStorage.FSU_Submitted @onclick="@(() => FileHandler("GALLERY"))"><i class="fi fi-ss-mode-landscape me-2"></i>Choose from gallery</button>
                        @if (!string.IsNullOrEmpty(file.file_image_source))
                        {
                            <button class="btn btn-danger d-flex align-items-center p-2 px-3" hidden=@SessionStorage.FSU_Submitted @onclick="DeleteFile"><i class="fi fi-rr-trash fs-5"></i></button>
                        }
                    </div>
                }
 
            </div>
            </fieldset>
        </div>
    </div>
</div>
<div class="footer">
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">Remarks</h3>
        </div>
        <div class="card-body">
            <fieldset disabled="@(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)">
                <textarea maxlength="500" class="form-control disabled w-100" disabled="@SessionStorage.FSU_Submitted" placeholder="Enter your remarks here..." @bind="@remarks" rows="2" oninput="validateRemarks(event)"></textarea>
            </fieldset>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6">
            <div class="d-flex">
                <NavLink class="btn btn-outline-secondary" onclick="@GoBack"><i class="fi fi-rr-angle-left me-1"></i>Back</NavLink>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                @* <NavLink class="btn btn-outline-secondary me-2" @onclick="@(() => HandleSubmit("SAVE"))"><i class="fi fi-rr-disk me-1"></i>Save</NavLink> *@
                <NavLink class="btn btn-primary" @onclick="@(() => HandleSubmit("NEXT"))">Next<i class="fi fi-rr-angle-right ms-1"></i></NavLink>
            </div>
        </div>
    </div>
    
    

@* <div class="mt-1">
    <p class="m-0" style="color: white;">Test</p>
</div> *@
</div>

@code {
    [Parameter]
    public bool is_sub_unit { get; set; }
    public string block { get; set; } = string.Empty;
    public string block_heading { get; set; } = string.Empty;
    Tbl_Sch_0_0_Block_3? file = new();
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries CommonQueries = new CommonQueries();
    DBQueries SCH_0_0_Querie = new();
    string? remarks = string.Empty;
    Tbl_Sch_0_0_Block_0_1 block_0_1 = new();
    private ConfirmDialog dialog = default!;
    SKBitmap sKBitmap = new SKBitmap();
    async void GoBack()
    {
        // await JSRuntime.InvokeVoidAsync("__handleGoBack");
        // return;
        if(is_sub_unit)
        {
            //nav to block 5
            NavigationManager.NavigateTo("/dashboard/sch0.0/block_5");
        }
        else
        {
            if(block_0_1.Block_1_15.GetValueOrDefault() <= 1)
            {
                NavigationManager.NavigateTo("/dashboard/sch0.0/block0_1");
            }
            else
            {
                //2.2
                if(SessionStorage.FSU_Sector == 1)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2R");
                }
                else
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_2_2U");
                }
            }
            
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/sch0.0/block_3",
            block_title = "Sch 0.0 Block 3",
            block_code = CommonEnum.sch_0_0_block_3.ToString(),
        };
        block = is_sub_unit ? "[Block 6]" : "[Block 3]";
        block_heading = is_sub_unit ? "sketch map of sub-division formation" : "Sketch map of sub-units (SU) formation";
        await CommonQueries.InsertVisitedBlock(vb);
        block_0_1 = await SCH_0_0_Querie.FetchBlock1();
        if (is_sub_unit)
        {
            remarks = block_0_1?.remarks_block_6;
        }
        else
        {
            remarks = block_0_1?.remarks_block_3;
        }
        Tbl_Sch_0_0_Block_3? response = await SCH_0_0_Querie.GetFileData(is_sub_unit ? 1 : 0);
        if (response != null)
        {
            file = response;
            var base64string = file != null ? Convert.ToBase64String(file.file_byte): "";
            //Now create ImageSource from the stream again
            file.file_image_source = $"data:{file.file_type};base64,{base64string}"; //Provide a fresh MemoryStream each time
            StateHasChanged();
        }
        if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            survey_time = response?.survey_timestamp.GetValueOrDefault() ?? DateTime.Now;
        }
        return;
    }
    async Task FileHandler(string type)
    {
        try
        {
            if (type == "CAMERA")
            {
                var cameraStatus = await Permissions.RequestAsync<Permissions.Camera>();
                if (cameraStatus != PermissionStatus.Granted)
                {
                    await Shell.Current.DisplayAlert("Permission Denied", "Camera permission is required", "OK");
                    return;
                }
                var photo = await MediaPicker.CapturePhotoAsync();
                if (photo != null)
                {
                    file = new();
                    var stream = await photo.OpenReadAsync();
                    long fileSize = stream.Length;
                    
                    file.id = Guid.NewGuid();
                    file.block_name = CommonEnum.sch_0_0_block_3.ToString();
                    file.file_name = photo.FileName;
                    file.file_type = photo.ContentType;
                    file.file_byte = CompressImageAsync(stream);

                    file.file_type = "image/jpeg";
                    file.file_name = Path.ChangeExtension(file.file_name, ".jpg");

                    var base64string = Convert.ToBase64String(file.file_byte);
                    file.file_image_source = $"data:image/jpeg;base64,{base64string}";
                }
                StateHasChanged();
                return;
            }
            else
            {
                var photo = await FilePicker.PickAsync(new PickOptions
                {
                    FileTypes = FilePickerFileType.Images // Filter for image files
                });
                if (photo != null)
                {
                    file = new();
                    var stream = await photo.OpenReadAsync();
                    long fileSize = stream.Length;
                    
                    file.id = Guid.NewGuid();
                    file.block_name = CommonEnum.sch_0_0_block_3.ToString();
                    file.file_name = photo.FileName;
                    file.file_type = photo.ContentType;
                    file.file_byte = CompressImageAsync(stream);

                    file.file_type = "image/jpeg";
                    file.file_name = Path.ChangeExtension(file.file_name, ".jpg");

                    var base64string = Convert.ToBase64String(file.file_byte);
                    file.file_image_source = $"data:image/jpeg;base64,{base64string}";
                }
                StateHasChanged();
                return;
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
            toastService.ShowError(ex.ToString());
            return;
        }
    }

    private byte[] CompressImageAsync(
    Stream inputStream,
    int maxSizeBytes = 1 * 1024 * 1024)
    {
        inputStream.Position = 0;

        using var managedStream = new SKManagedStream(inputStream);
        using var codec = SKCodec.Create(managedStream);

        if (codec == null)
            throw new InvalidOperationException("Unable to decode image.");

        var info = codec.Info;
        using var bitmap = new SKBitmap(info);
        codec.GetPixels(info, bitmap.GetPixels());

        int quality = 90;
        int width = info.Width;
        int height = info.Height;

        var sampling = new SKSamplingOptions(
            SKFilterMode.Linear,
            SKMipmapMode.None);

        while (true)
        {
            using var resizedBitmap = bitmap.Resize(
                new SKImageInfo(width, height),
                sampling);

            using var image = SKImage.FromBitmap(resizedBitmap);
            using var data = image.Encode(SKEncodedImageFormat.Jpeg, quality);

            if (data.Size <= maxSizeBytes)
                return data.ToArray();

            // 1️⃣ Reduce quality first
            if (quality > 40)
            {
                quality -= 10;
            }
            // 2️⃣ Then reduce dimensions
            else
            {
                width = (int)(width * 0.85);
                height = (int)(height * 0.85);

                if (width < 600 || height < 600)
                    return data.ToArray(); // final safe fallback
            }
        }
    }



    async Task HandleSubmit(string type)
    {

        //NavigationManager.NavigateTo("/dashboard/sch0.0/block_4_1");
        try
        {
            if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
            {
                if (is_sub_unit)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_7");
                }
                else
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_4");
                }
                return;
            }
            if (string.IsNullOrEmpty(file.file_image_source))
            {
                toastService.ShowError("Please select a file");
                return;
            }
            file.is_sub_unit = is_sub_unit;
            var status = await SCH_0_0_Querie.SaveFileData(new List<Tbl_Sch_0_0_Block_3>() { file});
            if (status != 1)
            {
                toastService.ShowError("Getting Error while saving file, please try agian!");
                return;
            }
            if(is_sub_unit)
                block_0_1.remarks_block_6 = remarks;
            else
                block_0_1.remarks_block_3 = remarks;
            await SCH_0_0_Querie.SaveBlock1(block_0_1);
            if (type == "NEXT")
            {
                if(is_sub_unit)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_7");
                }
                else
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_4");
                }
            }
            return;
        }
        catch (Exception ex)
        {
            toastService.ShowError(ex.ToString());
            return;
        }
    }

    


    async Task DeleteFile()
    {
        try
        {
            var options = new ConfirmDialogOptions { IsVerticallyCentered = true };
            var confirmed = await dialog.ShowAsync(
                title: "Alert",
                message1: "Are you sure you want to delete this entry?",
                confirmDialogOptions: options
            );

            if (!confirmed)
                return;
            if (file != null)
            {
                // Clear all file properties
                file.file_image_source = null;
                file.file_byte = null;
                file.file_name = null;
                file.file_type = null;
                file.id = Guid.Empty;

                // Optionally, you can delete from DB if already saved
                // await SCH_0_0_Querie.DeleteFileData(file.id);

                toastService.ShowSuccess("File deleted successfully.");
                StateHasChanged();
            }
            else
            {
                toastService.ShowWarning("No file to delete.");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError("Error deleting file: " + ex.Message);
        }
    }

}
