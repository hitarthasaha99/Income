@page "/dashboard/sch0.0/block_3/{is_sub_unit:bool}"
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject IToastService toastService
@inject NavigationManager NavigationManager
@inject ILoggingService Logger


<div class="main-content">
    <CommonContentHeader 
        SelectedFsuId="@SelectedFsuId"
        survey_time="@survey_time" 
    />
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="text-primary fw-bolder me-2">@block</span>@block_heading
            </h3>
            <span class="text-primary me-2"></span>
        </div>
        <div class="card-body">
            <div class="card p-4 d-flex align-items-center">
                @if(!string.IsNullOrEmpty(file.file_image_source))
                {
                        <img src="@file.file_image_source" alt="sketch map" title="Sketch Map" height="400" />
                }
            
                @if(!SessionStorage.selection_done)
            {
                <div class="d-flex align-items-center mt-3">
                    <button class="btn btn-outline-primary d-flex align-items-center me-2" hidden=@SessionStorage.FSU_Submitted @onclick="@(() => FileHandler("CAMERA"))"><i class="fi fi-rr-camera me-2"></i>Open Camera</button>
                    <button class="btn btn-primary d-flex align-items-center me-2" hidden=@SessionStorage.FSU_Submitted @onclick="@(() => FileHandler("GALLERY"))"><i class="fi fi-ss-mode-landscape me-2"></i>Choose from gallery</button>
                    @if (!string.IsNullOrEmpty(file.file_image_source))
                    {
                        <button class="btn btn-danger d-flex align-items-center p-2 px-3" hidden=@SessionStorage.FSU_Submitted @onclick="DeleteFile"><i class="fi fi-rr-trash fs-5"></i></button>
                    }
                </div>
            }
 
            </div>
        </div>
    </div>
</div>
<div class="footer">
    <div class="card custom-card">
        <div class="card-header">
            <h3 class="card-title">Remarks</h3>
        </div>
        <div class="card-body">
            <textarea maxlength="500" class="form-control disabled w-100" disabled="@SessionStorage.FSU_Submitted" placeholder="" @bind="@remarks" rows="2"></textarea>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6">
            <div class="d-flex">
                <NavLink class="btn btn-outline-secondary" onclick="@GoBack"><i class="fi fi-rr-angle-left me-1"></i>Back</NavLink>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="d-flex align-items-center justify-content-end">
                @* <NavLink class="btn btn-outline-secondary me-2" @onclick="@(() => HandleSubmit("SAVE"))"><i class="fi fi-rr-disk me-1"></i>Save</NavLink> *@
                <NavLink class="btn btn-primary" @onclick="@(() => HandleSubmit("NEXT"))">Next<i class="fi fi-rr-angle-right ms-1"></i></NavLink>
            </div>
        </div>
    </div>
    
    

@* <div class="mt-1">
    <p class="m-0" style="color: white;">Test</p>
</div> *@
</div>

@code {
    [Parameter]
    public bool is_sub_unit { get; set; }
    public string block { get; set; } = string.Empty;
    public string block_heading { get; set; } = string.Empty;
    Tbl_Sch_0_0_Block_3? file = new();
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries CommonQueries = new CommonQueries();
    DBQueries SCH_0_0_Querie = new();
    string? remarks = string.Empty;
    Tbl_Sch_0_0_Block_0_1 block_0_1 = new();

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }

    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
        {
            block_uri = "/dashboard/sch0.0/block_3",
            block_title = "Sch 0.0 Block 3",
            block_code = CommonEnum.sch_0_0_block_3.ToString(),
        };
        block = is_sub_unit ? "[Block 6]" : "[Block 3]";
        block_heading = is_sub_unit ? "sketch map of sub-division formation" : "Sketch map of sub-units (SU) formation";
        await CommonQueries.InsertVisitedBlock(vb);
        block_0_1 = await SCH_0_0_Querie.FetchBlock1();
        if (is_sub_unit)
        {
            remarks = block_0_1?.remarks_block_6;
        }
        else
        {
            remarks = block_0_1?.remarks_block_3;
        }
        Tbl_Sch_0_0_Block_3? response = await SCH_0_0_Querie.GetFileData(is_sub_unit ? 1 : 0);
        if (response != null)
        {
            file = response;
            var base64string = file != null ? Convert.ToBase64String(file.file_byte): "";
            //Now create ImageSource from the stream again
            file.file_image_source = $"data:{file.file_type};base64,{base64string}"; //Provide a fresh MemoryStream each time
            StateHasChanged();
        }
        return;
    }
    async Task FileHandler(string type)
    {
        try
        {
            if (type == "CAMERA")
            {
                var cameraStatus = await Permissions.RequestAsync<Permissions.Camera>();
                if (cameraStatus != PermissionStatus.Granted)
                {
                    await Shell.Current.DisplayAlert("Permission Denied", "Camera permission is required", "OK");
                    return;
                }
                var photo = await MediaPicker.CapturePhotoAsync();
                if (photo != null)
                {
                    file = new();
                    var stream = await photo.OpenReadAsync();
                    long fileSize = stream.Length;
                    if (fileSize > CommonConstants.MAX_FILE_SIZE)
                    {
                        toastService.ShowError("File Size exceeds allowed file size. (5MB)");
                        return;
                    }
                    file.id = Guid.NewGuid();
                    file.block_name = CommonEnum.sch_0_0_block_3.ToString();
                    file.file_name = photo.FileName;
                    file.file_type = photo.ContentType;
                    using (MemoryStream ms = new MemoryStream())
                    {
                        await stream.CopyToAsync(ms);  //Copy the stream to the memory stream
                        file.file_byte = ms.ToArray();     // Convert memory stream to byte array
                        ms.Seek(0, SeekOrigin.Begin);
                        var base64string = Convert.ToBase64String(file.file_byte);
                        //Now create ImageSource from the stream again
                        file.file_image_source = $"data:{file.file_type};base64,{base64string}"; //Provide a fresh MemoryStream each time
                    }
                }
                StateHasChanged();
                return;
            }
            else
            {
                var photo = await FilePicker.PickAsync(new PickOptions
                {
                    FileTypes = FilePickerFileType.Images // Filter for image files
                });
                if (photo != null)
                {
                    file = new();
                    var stream = await photo.OpenReadAsync();
                    long fileSize = stream.Length;
                    if (fileSize > CommonConstants.MAX_FILE_SIZE)
                    {
                        toastService.ShowError("File Size exceeds allowed file size. (5MB)");
                        return;
                    }
                    file.id = Guid.NewGuid();
                    file.block_name = CommonEnum.sch_0_0_block_3.ToString();
                    file.file_name = photo.FileName;
                    file.file_type = photo.ContentType;
                    using (MemoryStream ms = new MemoryStream())
                    {
                        await stream.CopyToAsync(ms);  //Copy the stream to the memory stream
                        file.file_byte = ms.ToArray();     // Convert memory stream to byte array
                        ms.Seek(0, SeekOrigin.Begin);
                        var base64string = Convert.ToBase64String(file.file_byte);
                        //Now create ImageSource from the stream again
                        file.file_image_source = $"data:{file.file_type};base64,{base64string}"; //Provide a fresh MemoryStream each time
                    }
                }
                StateHasChanged();
                return;
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
            toastService.ShowError(ex.ToString());
            return;
        }
    }

    async Task HandleSubmit(string type)
    {

        //NavigationManager.NavigateTo("/dashboard/sch0.0/block_4_1");
        try
        {
            if(SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
            {
                if (is_sub_unit)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_7");
                }
                else
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_4");
                }
                return;
            }
            if (string.IsNullOrEmpty(file.file_image_source))
            {
                toastService.ShowError("Please select a file");
                return;
            }
            file.is_sub_unit = is_sub_unit;
            var status = await SCH_0_0_Querie.SaveFileData(new List<Tbl_Sch_0_0_Block_3>() { file});
            if (status != 1)
            {
                toastService.ShowError("Getting Error while saving file, please try agian!");
                return;
            }
            if(is_sub_unit)
                block_0_1.remarks_block_6 = remarks;
            else
                block_0_1.remarks_block_3 = remarks;
            await SCH_0_0_Querie.SaveBlock1(block_0_1);
            if (type == "NEXT")
            {
                if(is_sub_unit)
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_7");
                }
                else
                {
                    NavigationManager.NavigateTo("/dashboard/sch0.0/block_4");
                }
            }
            return;
        }
        catch (Exception ex)
        {
            toastService.ShowError(ex.ToString());
            return;
        }
    }

    async Task DeleteFile()
    {
        try
        {
            if (file != null)
            {
                // Clear all file properties
                file.file_image_source = null;
                file.file_byte = null;
                file.file_name = null;
                file.file_type = null;
                file.id = Guid.Empty;

                // Optionally, you can delete from DB if already saved
                // await SCH_0_0_Querie.DeleteFileData(file.id);

                toastService.ShowSuccess("File deleted successfully.");
                StateHasChanged();
            }
            else
            {
                toastService.ShowWarning("No file to delete.");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError("Error deleting file: " + ex.Message);
        }
    }

}
