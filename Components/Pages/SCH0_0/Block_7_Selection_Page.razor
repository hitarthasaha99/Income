@page "/dashboard/sch0.0/block_7_selection"
@using Blazored.FluentValidation
@using Income.Common.SCH0_0
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using Income.SurveyLibrary
@using Income.Validators.SCH0_0
@using System.Diagnostics
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject PreloadService preloadService
@inject ILoggingService Logger
@inject NetworkService networkService


<GlobalErrorBoundary>
    <div class="main-content">
        <CommonContentHeader SelectedFsuId="@SelectedFsuId"
        survey_time="@survey_time" />
        <ConfirmDialog @ref="dialog" />

        <div class="card custom-card">
            <!-- 🔹 Sticky Top Action Header -->
            <div class="card-header">
                <h3 class="card-title">
                    <span class="text-primary me-2">[Block 7]</span>List of households and selection of households for Schedule on NHIS
                </h3>
                @if (SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
                {
                    <div class="card-tools">
                        <div class="d-flex align-items-center">
                            @* <button class="btn btn-outline-secondary btn-sm me-2" hidden="@SessionStorage.selection_done" @onclick="@(() => OpenGenerateModal())">
                                <i class="fi fi-rr-calculator me-1"></i>Generate
                            </button> *@

                            <button class="btn btn-outline-secondary btn-sm me-2" hidden="@SessionStorage.selection_done" @onclick="@(() => CalculateSSS())">
                                <i class="fi fi-rr-calculator me-1"></i>Calc SSS
                            </button>

                            <button class="btn btn-primary btn-sm me-2" hidden="@SessionStorage.selection_done" @onclick="@(() => DoSelection())">
                                <i class="fi fi-rr-checkbox me-1"></i>Selection
                            </button>
                            @if (SessionStorage.ShowGenerateButton)
                            {
                                <button class="btn btn-outline-primary btn-sm me-2" @onclick="@(() => ResetSelection())">
                                    <i class="fi fi-rr-rotate-left me-1"></i>Reset Selection
                                </button>

                                <button class="btn btn-primary btn-sm" @onclick="@(() => DeleteAllHHDS())">
                                    <i class="fi fi-rr-rotate-left me-1"></i>Delete All Households
                                </button>
                            }
                            
                        </div>
                    </div>
                }
                
            </div>

            <!-- 🔹 Scrollable table -->
            <div class="card-body p-0">
                <div class="table-responsive table-wrapper">
                    <table class="table table-striped table-bordered mb-0">
                        <thead>
                            <tr>
                                <th style="min-width:10px;">Srl.No.</th>
                                <th style="min-width:50px;">House Number</th>
                                <th style="min-width:150px;">Is the house used only for non-residential purposes?</th>
                                <th style="min-width:50px;">Household Serial Number</th>
                                <th style="min-width:100px;">Name of the head of the household</th>
                                <th style="min-width:50px;">Household Size</th>
                                <th style="min-width:150px;">Highest education level attained among the household members</th>
                                <th style="min-width:50px;">Household Type</th>
                                <th style="min-width:200px;">Total amount of land owned (possessed or leased out) by the household as on the date of the survey</th>
                                <th style="min-width:150px;">Usual monthly consumption expenditure of the household (Rs.)</th>
                                <th style="min-width:100px;">SSS number for Schedule NHIS 2026</th>
                                <th style="min-width:40px;">Selected</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>(0)</th>
                                <th>(1)</th>
                                <th>(2)</th>
                                <th>(3)</th>
                                <th>(4)</th>
                                <th>(5)</th>
                                <th>(6)</th>
                                <th>(7)</th>
                                <th>(8)</th>
                                <th>(9)</th>
                                <th>(10)</th>
                                <th>(11)</th>
                            </tr>
                            @if (ListItems != null && ListItems.Count > 0)
                            {
                                foreach (var item in ListItems)
                                {
                                    if (item.is_deleted != true)
                                    {
                                        <tr>
                                            <td>@item.Block_7_1</td>
                                            <td>@item.Block_7_2</td>
                                            <td>@item.is_household</td>
                                            <td>@item.Block_7_3</td>
                                            <td>@item.Block_7_4</td>
                                            <td>@item.Block_7_5</td>
                                            <td>@item.Block_7_6</td>
                                            <td>@item.Block_7_7</td>
                                            <td>@item.Block_7_8</td>
                                            <td>@item.Block_7_9</td>
                                            <td>@item.SSS</td>
                                            <td>
                                                <div class="siteCustomCheckbox">
                                                    <label>
                                                        <input type="checkbox" @bind="item.isSelected" disabled />
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 🔹 Footer Navigation (Always visible) -->
    <div class="footer">
        @* Remarks Card *@
        <div class="card custom-card">
            <div class="card-header">
                <h3 class="card-title">Remarks</h3>
            </div>
            <div class="card-body">
                <fieldset disabled="@((SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO) || SessionStorage.FSU_Submitted)">
                    <textarea maxlength="500" type="text" class="form-control disabled w-100" disabled="@SessionStorage.FSU_Submitted" placeholder="Enter your remarks here..." @bind="@remarks" rows="2" oninput="validateRemarks(event)"></textarea>
                </fieldset>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="d-flex">
                    <NavLink class="btn btn-outline-secondary" onclick="@GoBack">
                        <i class="fi fi-rr-angle-left me-1"></i>Back
                    </NavLink>
                    @if(SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
                    {
                        <button class="btn btn-primary ms-2" disabled="@(!AllowUpdateListing)" @onclick="@(() => OpenUpdateListingModal())">Update Listing</button>
                    }
                </div>
            </div>
            <div class="col-sm-6">
                <div class="d-flex align-items-center justify-content-end">
                    <NavLink class="btn btn-primary" @onclick="@(() => HandleSubmit("NEXT"))">
                        Next<i class="fi fi-rr-angle-right ms-1"></i>
                    </NavLink>
                </div>
            </div>
        </div>
    </div>

    <Modal @ref="ModalRef" Size="ModalSize.Large">
    <HeaderTemplate>
        <h5 class="modal-title">Generate Households</h5>
    </HeaderTemplate>

    <BodyTemplate>
        <div class="row">
            <div class="col-sm-12">
                <div class="mb-3">
                    <label class="form-label">Sector: @sector</label>
                </div>
                @foreach (var sss in ValidSss)
                {
                    <div class="input-group mb-2">
                        <span class="input-group-text" style="width: 80px;">@sss</span>
                        <input type="number"
                                class="form-control"
                                @bind="InputCounts[sss]"
                                min="0" />
                    </div>
                }
            </div>
        </div>
    </BodyTemplate>

    <FooterTemplate>
            <Button @onclick="@(() => Generate())">Generate</Button>
        <Button @onclick="Cancel">Cancel</Button>
    </FooterTemplate>
</Modal>

    <Modal @ref="UpdateListingModal" Size="ModalSize.Large">
        <HeaderTemplate>
            <h5 class="modal-title">Update Listing</h5>
        </HeaderTemplate>

        <BodyTemplate>
            <div class="list-group">
                <InputRadioGroup @bind-Value="SelectedReason">
                    <div class="list-group">

                        <label class="list-group-item">
                            <InputRadio Value="1" class="form-check-input me-2" />
                            FSU identification was wrong
                        </label>

                        <label class="list-group-item">
                            <InputRadio Value="2" class="form-check-input me-2" />
                            Sub-Unit formation was wrong
                        </label>

                        <label class="list-group-item">
                            <InputRadio Value="3" class="form-check-input me-2" />
                            Sub-division formation was wrong
                        </label>

                        <label class="list-group-item">
                            <InputRadio Value="4" class="form-check-input me-2" />
                            Household wrongly added/missed
                        </label>

                    </div>
                </InputRadioGroup>
            </div>
        </BodyTemplate>

        <FooterTemplate>
            <Button @onclick="@(() => DoUpdateListing())">Confirm</Button>
        </FooterTemplate>

    </Modal>
</GlobalErrorBoundary>



@code {
    private Modal ModalRef;
    private Modal UpdateListingModal;
    public Dictionary<int, int> InputCounts { get; set; } = new();
    public List<int> ValidSss { get; set; } = new();
    EditContext editContext;
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries SCH_0_0_Queries = new();
    CommonConfig commonConfig = new();
    Modal AddModal = default;
    public int sector { get; set; } = 0;
    private Tbl_Fsu_List tbl_Fsu_List;
    Tbl_Sch_0_0_Block_7 fields = new();
    List<Tbl_Sch_0_0_Block_7> ListItems = new();
    ValidationComponent house_number_ref = new();
    ValidationComponent purpose_ref = new();
    ValidationComponent head_name_ref = new();
    ValidationComponent size_ref = new();
    CommonList commonList = new();
    Tbl_Sch_0_0_Block_0_1 block_0_1 = new();
    private ValidationMessageStore messageStore;
    private bool AllowUpdateListing;
    private ConfirmDialog dialog = default!;
    private int SelectedReason { get; set; }

    private readonly Dictionary<int, int[]> SssMap = new()
{
    { 1, new[] { 11,12,21,22,31,32,40,90 } },
    { 2, new[] { 11,121,122,21,221,222,40,90 } }
};


    CommonFunction commonFunctions = new();
    bool is_error = false;
    private string? remarks = string.Empty;

    async void GoBack()
    {
        NavigationManager.NavigateTo("/dashboard/sch0.0/block_7");
        // await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }
    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
            {
                block_uri = "/dashboard/sch0.0/block_7_selection",
                block_title = "Sch 0.0 Block 7 Selection",
                block_code = CommonEnum.sch_0_0_block_7_selection.ToString(),
            };

        await commonQueries.InsertVisitedBlock(vb);
        var block_0_1 = await SCH_0_0_Queries.FetchBlock1();
        tbl_Fsu_List = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);

        if (block_0_1 != null)
        {
            this.block_0_1 = block_0_1;
            remarks = block_0_1.remarks_block_7_selection;
            SessionStorage.FSU_Sector = sector = block_0_1.Block_1_5.GetValueOrDefault();
            if (sector == 1)
                ValidSss = new() { 11, 12, 21, 22, 31, 32, 40, 90 };
            else
                ValidSss = new() { 11, 121, 122, 21, 221, 222, 40, 90 };

            foreach (var sss in ValidSss)
                InputCounts[sss] = 0;
        }
        await LoadData();
        if (SessionStorage.GetUserRole() != SessionStorage.UserRole.JSO)
        {
            survey_time = ListItems
                            .OrderByDescending(x => x.survey_timestamp)
                            .Select(x => (DateTime?)x.survey_timestamp)
                            .FirstOrDefault().GetValueOrDefault();

        }
        StateHasChanged();
        await Logger.LogInfo($"Block 7 Loaded for {SessionStorage.SelectedFSUId}");
    }

    private async Task Generate()
    {
        var list = new List<Tbl_Sch_0_0_Block_7>();

        foreach (var (sss, count) in InputCounts)
        {
            for (int i = 0; i < count; i++)
            {
                list.Add(new Tbl_Sch_0_0_Block_7
                {
                    id = Guid.NewGuid(),
                    SSS = sss,
                    Stratum = GetStratum(sss),
                    isInitialySelected = false,
                    is_household = 2,
                    isSelected = false,
                    fsu_id = SessionStorage.SelectedFSUId
                });
            }
        }
        await SCH_0_0_Queries.SaveBulkBlock7(list);
        await ModalRef.HideAsync();
        await LoadData();
    }

    private async Task OpenGenerateModal()
    {
        await ModalRef.ShowAsync();
    }

    private async Task Cancel()
    {
        await ModalRef.HideAsync();
    }

    private int GetStratum(int sss)
    {
        var firstDigit = int.Parse(sss.ToString()[0].ToString());
        return firstDigit * 10;
    }

    private async Task LoadData()
    {
        var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
        if (response != null && response.Count > 0)
        {
            ListItems?.Clear();
            ListItems?.AddRange(response.OrderBy(x => x.Block_7_1).ToList());
        }
        else
        {
            ListItems?.Clear();
        }
        if (tbl_Fsu_List != null)
        {
            if(SessionStorage.GetUserRole() == SessionStorage.UserRole.JSO)
            {
                AllowUpdateListing = tbl_Fsu_List.updatelistingcount == 0 && ListItems != null && ListItems.Any(x => x.isSelected);
                if (tbl_Fsu_List.lookup_fsu_sub_submit_status == 21)
                {
                    AllowUpdateListing = false;
                }
            }
            else
            {
                AllowUpdateListing = false;
            }
        }
        StateHasChanged();

    }

    private async Task ResetSelection()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Resetting Selection, Please wait...");
            var response = await SCH_0_0_Queries.ResetSelection();
            if (response > 0)
            {
                toastService.ShowSuccess("Selection reset successful");
                SessionStorage.selection_done = false;
                //Update selection flag at FSU level
                var fsu = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
                if (fsu != null)
                {
                    fsu.is_selection_done = false;
                    await commonQueries.UpdateFSU(fsu);
                }

                var suList = await SCH_0_0_Queries.FetchSCH0Block2_2Data();
                if (suList != null && suList.Count > 0)
                {
                    foreach(var item in suList)
                    {
                        item.IsChecked = false;
                        item.is_selected = false;
                        await SCH_0_0_Queries.SaveSCH0Block2_2(suList);
                    }
                }

                var sdList = await SCH_0_0_Queries.FetchSCH0Block5Data();
                if (sdList != null && sdList.Count > 0)
                {
                    foreach (var item in sdList)
                    {
                        item.IsChecked = false;
                    }
                    await SCH_0_0_Queries.SaveSCH0Block5(sdList);
                }
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during resetting selection: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }

    private async Task DeleteAllHHDS()
    {
        try
        {
            await ResetSelection();
            await SCH_0_0_Queries.DeleteAllHHDS();
            await LoadData();
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during deleting all households: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }

    private async Task CalculateSSS()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Assigning SSS");

            var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
            if (response == null || response.Count == 0)
                return;

            // Only households
            response = response.Where(x => x.is_household == 2).ToList();

            // Group by household type
            var grouped = response.GroupBy(x => x.Block_7_7 ?? 0).ToList();

            // ------------------------------------------------------------
            // STEP 1: Compute A (median UMPCE) and B (60th percentile land)
            // ------------------------------------------------------------
            foreach (var group in grouped)
            {
                var items = group.ToList();

                var exp = items.Where(x => x.UMPCE.HasValue)
                               .Select(x => (decimal)x.UMPCE.Value)
                               .OrderBy(x => x)
                               .ToList();

                decimal A = exp.Count == 0 ? 0 :
                    exp.Count % 2 == 1
                        ? exp[exp.Count / 2]
                        : (exp[exp.Count / 2 - 1] + exp[exp.Count / 2]) / 2;

                var land = items.Where(x => x.Block_7_8.HasValue)
                                .Select(x => x.Block_7_8.Value)
                                .OrderBy(x => x)
                                .ToList();

                decimal B = land.Count == 0 ? 0 : (decimal)Percentile_NPlus1(land, 60);

                foreach (var item in items)
                {
                    item.a = A;
                    item.b = B;
                    item.sss_overridden = false;
                }
            }

            // ------------------------------------------------------------
            // STEP 2: RURAL EXCEPTIONS
            // ------------------------------------------------------------
            if (sector == 1)
            {
                foreach (var group in grouped)
                {
                    int block7 = group.Key;
                    var items = group.ToList();
                    int N = items.Count;
                    if (N == 0) continue;

                    // block7 = 1 (Land identical)
                    if (block7 == 1 &&
                        items.Where(x => x.Block_7_8.HasValue)
                             .Select(x => x.Block_7_8.Value)
                             .Distinct()
                             .Count() == 1)
                    {
                        var ordered = items.OrderBy(x => x.Block_7_8)
                                           .ThenBy(x => x.Block_7_3)
                                           .ToList();

                        int split = N % 2 == 1 ? (N - 1) / 2 : N / 2;

                        for (int i = 0; i < N; i++)
                        {
                            ordered[i].SSS = i < split ? 11 : 12;
                            ordered[i].Stratum = 10;
                            ordered[i].sss_overridden = true;
                        }
                    }

                    // block7 = 2 or 3 (UMPCE identical)
                    if ((block7 == 2 || block7 == 3) &&
                        items.Where(x => x.UMPCE.HasValue)
                             .Select(x => x.UMPCE.Value)
                             .Distinct()
                             .Count() == 1)
                    {
                        var ordered = items.OrderBy(x => x.UMPCE)
                                           .ThenBy(x => x.Block_7_3)
                                           .ToList();

                        int split = N % 2 == 1 ? (N - 1) / 2 : N / 2;

                        for (int i = 0; i < N; i++)
                        {
                            ordered[i].SSS = block7 == 2
                                ? (i < split ? 21 : 22)
                                : (i < split ? 31 : 32);

                            ordered[i].Stratum = block7 == 2 ? 20 : 30;
                            ordered[i].sss_overridden = true;
                        }
                    }
                }

                decimal? LandAsDecimal(double? v) =>
                    v.HasValue ? (decimal)v.Value : (decimal?)null;

                decimal? UmpceAsDecimal(double? v) =>
                    v.HasValue ? (decimal)v.Value : (decimal?)null;
                // ------------------------------------------------------------
                // RURAL – MIXED (= B and > B) / (= A and > A) SPLIT EXCEPTION
                // ------------------------------------------------------------
                foreach (var group in grouped)
                {
                    int block7 = group.Key;
                    var items = group.ToList();
                    int N = items.Count;
                    if (N == 0) continue;

                    int split = N % 2 == 1 ? (N - 1) / 2 : N / 2;

                    // ---------- Block_7_7 = 1 (Land: =B and >B) ----------
                    if (block7 == 1)
                    {
                        decimal B = items.First().b;

                        bool hasEqualB = items.Any(x =>
                            LandAsDecimal(x.Block_7_8) == B);

                        bool hasGreaterB = items.Any(x =>
                            LandAsDecimal(x.Block_7_8) > B);

                        if (hasEqualB && hasGreaterB)
                        {
                            var ordered = items
                                .OrderBy(x => x.Block_7_8)
                                .ThenBy(x => x.Block_7_3)
                                .ToList();

                            for (int i = 0; i < N; i++)
                            {
                                ordered[i].SSS = i < split ? 11 : 12;
                                ordered[i].Stratum = 10;
                                ordered[i].sss_overridden = true;
                            }
                        }
                    }

                    // ---------- Block_7_7 = 2 (UMPCE: =A and >A) ----------
                    if (block7 == 2)
                    {
                        decimal A = items.First().a;

                        bool hasEqualA = items.Any(x =>
                            UmpceAsDecimal(x.UMPCE) == A);

                        bool hasGreaterA = items.Any(x =>
                            UmpceAsDecimal(x.UMPCE) > A);

                        if (hasEqualA && hasGreaterA)
                        {
                            var ordered = items
                                .OrderBy(x => x.UMPCE)
                                .ThenBy(x => x.Block_7_3)
                                .ToList();

                            for (int i = 0; i < N; i++)
                            {
                                ordered[i].SSS = i < split ? 21 : 22;
                                ordered[i].Stratum = 20;
                                ordered[i].sss_overridden = true;
                            }
                        }
                    }

                    // ---------- Block_7_7 = 3 (UMPCE: =A and >A) ----------
                    if (block7 == 3)
                    {
                        decimal A = items.First().a;

                        bool hasEqualA = items.Any(x =>
                            UmpceAsDecimal(x.UMPCE) == A);

                        bool hasGreaterA = items.Any(x =>
                            UmpceAsDecimal(x.UMPCE) > A);

                        if (hasEqualA && hasGreaterA)
                        {
                            var ordered = items
                                .OrderBy(x => x.UMPCE)
                                .ThenBy(x => x.Block_7_3)
                                .ToList();

                            for (int i = 0; i < N; i++)
                            {
                                ordered[i].SSS = i < split ? 31 : 32;
                                ordered[i].Stratum = 30;
                                ordered[i].sss_overridden = true;
                            }
                        }
                    }
                }

            }

            // ------------------------------------------------------------
            // STEP 3: URBAN EXCEPTIONS
            // ------------------------------------------------------------
            if (sector == 2)
            {
                foreach (var group in grouped)
                {
                    int block7 = group.Key;
                    if (block7 != 1 && block7 != 2) continue;

                    var items = group.ToList();
                    int N = items.Count;
                    if (N == 0) continue;

                    if (items.Where(x => x.UMPCE.HasValue)
                             .Select(x => x.UMPCE.Value)
                             .Distinct()
                             .Count() != 1)
                        continue;

                    if (items.Any(x => !x.Block_7_6.HasValue))
                        continue;

                    bool allLowEdu = items.All(x => x.Block_7_6 == 1 || x.Block_7_6 == 2 || x.Block_7_6 == 3 || x.Block_7_6 == 4 || x.Block_7_6 == 5 || x.Block_7_6 == 6);
                    bool allHighEdu = items.All(x => x.Block_7_6 == 7 || x.Block_7_6 == 8 || x.Block_7_6 == 10 || x.Block_7_6 == 11);

                    if (!allLowEdu && !allHighEdu)
                        continue;

                    foreach (var h in items)
                    {
                        h.SSS = block7 == 1
                            ? (allLowEdu ? 121 : 122)
                            : (allLowEdu ? 221 : 222);

                        h.Stratum = block7 == 1 ? 10 : 20;
                        h.sss_overridden = true;
                    }
                }
            }

            // ------------------------------------------------------------
            // STEP 4: DEFAULT SSS ASSIGNMENT
            // ------------------------------------------------------------
            foreach (var item in response.Where(x => !x.sss_overridden))
            {
                int block7 = item.Block_7_7 ?? 0;
                decimal A = item.a;
                decimal B = item.b;
                decimal exp = (decimal)(item.UMPCE ?? 0);
                decimal land = (decimal)(item.Block_7_8 ?? 0);
                int edu = item.Block_7_6 ?? 0;

                if (sector == 1) // Rural
                {
                    switch (block7)
                    {
                        case 1: item.SSS = land < B ? 11 : 12; item.Stratum = 10; break;
                        case 2: item.SSS = exp < A ? 21 : 22; item.Stratum = 20; break;
                        case 3: item.SSS = exp < A ? 31 : 32; item.Stratum = 30; break;
                        case 4: item.SSS = 40; item.Stratum = 40; break;
                        case 9: item.SSS = 90; item.Stratum = 90; break;
                    }
                }
                else // Urban
                {
                    switch (block7)
                    {
                        case 1:
                            item.Stratum = 10;
                            item.SSS = exp < A ? 11 : (edu <= 6 ? 121 : 122);
                            break;

                        case 2:
                            item.Stratum = 20;
                            item.SSS = exp < A ? 21 : (edu <= 6 ? 221 : 222);
                            break;

                        case 3: item.SSS = 40; item.Stratum = 40; break;
                        case 4:
                        case 9: item.SSS = 90; item.Stratum = 90; break;
                    }
                }
            }

            // ------------------------------------------------------------
            // STEP 5: SAVE
            // ------------------------------------------------------------
            var update = await SCH_0_0_Queries.SaveSSSToDatabase(response);
            if (update == 1)
            {
                toastService.ShowSuccess("SSS assignment successful");
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            preloadService.Hide();
        }
    }


    public static double Percentile_NPlus1(IList<double> sequence, double percentile)
    {
        if (sequence == null || sequence.Count == 0)
            throw new ArgumentException("Sequence cannot be empty.");

        if (percentile < 0 || percentile > 100)
            throw new ArgumentException("Percentile must be between 0 and 100.");

        var data = sequence.OrderBy(x => x).ToList();
        int n = data.Count;

        if (n == 1)
            return data[0];

        // Position based on Hazen's (n + 1) method
        double position = (percentile / 100.0) * (n + 1);

        // If position is below 1 → return first value
        if (position <= 1)
            return data[0];

        // If position is above n → return last value
        if (position >= n)
            return data[n - 1];

        // Find lower and upper neighbours
        int lowerIndex = (int)Math.Floor(position) - 1;  // convert to 0-based
        int upperIndex = (int)Math.Ceiling(position) - 1;

        // Interpolation weight
        double weight = position - Math.Floor(position);

        // If exact integer position → return that value
        if (lowerIndex == upperIndex)
            return data[lowerIndex];

        return data[lowerIndex] + weight * (data[upperIndex] - data[lowerIndex]);
    }


    async Task DoSelection()
    {
        try
        {
            var options = new ConfirmDialogOptions { IsVerticallyCentered = true };
            var confirmation = await dialog.ShowAsync(
                title: "Alert",
                message1: "Do you want to proceed?",
                confirmDialogOptions: options
            );
            if (!confirmation)
            {
                return;                
            }
            preloadService.Show(SpinnerColor.Info, "Doing Selection, Please wait...");

            await SCH_0_0_Queries.UpdateAllRowsForColumnAsync(SessionStorage.SelectedFSUId);
            var existingListingData = await SCH_0_0_Queries.Get_SCH0_0_Block_5A_HouseHoldBy_FSUP(SessionStorage.SelectedFSUId);
            var sss_selection_not_done = existingListingData.Any(x => x.SSS == 0);

            if (sss_selection_not_done)
            {
                toastService.ShowError("Please calculate SSS before doing selection, Please try again!");
                return;
            }
            if (existingListingData.Count > 0)
            {
                var service = new HouseholdSelectionService();
                var households = existingListingData;
                int sectorType = sector; // 1 = Rural, 2 = Urban

                var result = service.SelectHouseholds(households, sectorType);
                if (result.Success)
                {
                    foreach (var item in result.SelectedHouseholds)
                    {
                        item.isInitialySelected = item.isSelected;
                        item.SSS = item.SelectedPostedSSS.GetValueOrDefault();
                        await SCH_0_0_Queries.Update_SCH0_0_Block_7(item);
                        SessionStorage.selection_done = true;
                    }
                    await SCH_0_0_Queries.AssignSSSHouseholdIds();

                    await Logger.LogInfo("Selected households:");
                    //Update selection flag at FSU level
                    var fsu = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
                    if (fsu != null)
                    {
                        fsu.is_selection_done = true;
                        await commonQueries.UpdateFSU(fsu);
                    }
                    await Logger.LogInfo($"Total households selected: {result.SelectedHouseholds.Count}");

                    foreach (var msg in result.Messages)
                    {
                        await Logger.LogInfo(msg.Value);
                    }

                    // Process selected households
                    foreach (var hh in result.SelectedHouseholds)
                    {
                        await Logger.LogInfo($"HH {hh.Block_7_3}: SSS {hh.SSS} -> Posted as SSS {hh.SelectedPostedSSS}");
                    }
                }
                toastService.ShowSuccess("Selection done successfully!");
                await LoadData();
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            preloadService.Hide();
        }

    }

    private async void OpenUpdateListingModal()
    {
        var options = new ConfirmDialogOptions { IsVerticallyCentered = true };
        var confirmation = await dialog.ShowAsync(
            title: "Alert",
            message1: "Do you want to proceed? This will lead to data being deleted.",
            confirmDialogOptions: options);

        if (confirmation)
        {
            await UpdateListingModal.ShowAsync();
        }
    }

    private async Task DoUpdateListing()
    {
        try
        {
            await Logger.LogInfo($"Selected Reason for Update Listing: {SelectedReason}");
            if (SelectedReason > 0 && Connectivity.Current.NetworkAccess == NetworkAccess.Internet)
            {
                var response = await networkService.PostAsync(CommonConfig.BaseController, CommonConfig.UpdateListingAction, new { fsu_reference_Id = SessionStorage.SelectedFSUId, survey_Id = SessionStorage.surveyId, is_updateListingCount = true });
                if (response != null && response.IsSuccessStatusCode)
                {
                    toastService.ShowSuccess("Update Listing request submitted successfully");
                    tbl_Fsu_List.updatelistingcount += 1;
                    tbl_Fsu_List.lookupFsuSubmitStatus = 11;
                    tbl_Fsu_List.lookup_fsu_sub_submit_status = 0;
                    await commonQueries.UpdateFSU(tbl_Fsu_List);
                    var res = await SCH_0_0_Queries.DoUpdateListing(SessionStorage.SelectedFSUId, SelectedReason);
                    if (res > 0 && (SelectedReason == 1 || SelectedReason == 2 || SelectedReason == 3))
                    {
                        await UpdateListingModal.HideAsync();
                        NavigationManager.NavigateTo("/dashboard/fsulist/");
                    }
                    else if(res > 0 && SelectedReason == 4)
                    {
                        await SCH_0_0_Queries.ResetSelection();
                        await UpdateListingModal.HideAsync();
                        NavigationManager.NavigateTo("/dashboard/sch0.0/block_7");
                    }

                }
                else
                {
                    toastService.ShowError("Failed to submit Update Listing request. Please try again.");
                    return;
                }
            }
            else
            {
                toastService.ShowError("Need internet connectivity to proceed");
                return;
            }
        }
        catch (Exception ex)
        {
            
        }
        finally
        {
            preloadService.Hide();
            await UpdateListingModal.HideAsync();
        }
    }


    async Task HandleSubmit(string action = "")
    {
        block_0_1.remarks_block_7_selection = remarks;
        if (block_0_1.id != Guid.Empty)
            await SCH_0_0_Queries.SaveBlock1(block_0_1);

        var selectionDone = ListItems.Any(x => x.isSelected);
        if (!selectionDone)
        {
            toastService.ShowError($"Cannot proceed without selection");
            return;
        }
        NavigationManager.NavigateTo("/dashboard/sch0.0/block_8");
    }
}
