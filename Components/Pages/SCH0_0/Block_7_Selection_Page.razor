@page "/dashboard/sch0.0/block_7_selection"
@using Blazored.FluentValidation
@using Income.Common.SCH0_0
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using Income.SurveyLibrary
@using Income.Validators.SCH0_0
@using System.Diagnostics
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject PreloadService preloadService


<GlobalErrorBoundary>
    <div class="my-2">
        <CommonContentHeader SelectedFsuId="@SelectedFsuId"
                             survey_time="@survey_time" />

        
        <!-- 🔹 Sticky Top Action Header -->
        <div class="card-header d-flex align-items-center sticky-top bg-white" style="z-index: 20;">
            <h3 class="card-title m-0 d-flex align-items-center">
                <span class="text-primary me-1">[Block 7]</span>
                List of households and selection of households for Schedule on HIS
            </h3>

            <div class="ms-auto d-flex gap-2">
                <button class="btn btn-primary btn-sm d-flex align-items-center" hidden="@SessionStorage.selection_done" @onclick="@(() => CalculateSSS())">
                    <i class="bi bi-calculator"></i> <span class="ms-1">Calc SSS</span>
                </button>

                <button class="btn btn-primary btn-sm d-flex align-items-center" hidden="@SessionStorage.selection_done" @onclick="@(() => DoSelection())">
                    <i class="bi bi-check2-square"></i> <span class="ms-1">Selection</span>
                </button>

                <button class="btn btn-primary btn-sm d-flex align-items-center" @onclick="@(() => ResetSelection())">
                    <i class="bi bi-arrow-clockwise"></i> <span class="ms-1">Reset Selection</span>
                </button>

            </div>
        </div>

        <!-- 🔹 Scrollable table -->
        <div class="card-body p-0" style="max-height: 65vh; overflow-y: auto;">
            <table class="table table-striped table-bordered mb-0">
                <thead class="table-light sticky-top" style="top: 1px; z-index: 10;">
                    <tr>
                        <th>Srl.No.</th>
                        <th>House Number</th>
                        <th>Is the house used only for non-residential purposes? (yes-1, no-2)</th>
                        <th>Household Serial Number</th>
                        <th>Name of the head of the household</th>
                        <th>Household Size</th>
                        <th>Highest education level attained among the household members (entry in code) – (for urban only) code 2 in item 5 of Block 1)</th>
                        <th>Household Type</th>
                        <th>Total amount of land owned (possessed or leased out) by the household as on the date of the survey (in acres in three places of decimal) – ((for rural only) code 1 in item 5 of Block 1)</th>
                        <th>Usual monthly consumption expenditure of the household (Rs.)</th>
                        <th>SSS number for Schedule HIS 2026</th>
                        <th>Selected</th>
                    </tr>
                    <tr>
                        <th>(0)</th>
                        <th>(1)</th>
                        <th>(2)</th>
                        <th>(3)</th>
                        <th>(4)</th>
                        <th>(5)</th>
                        <th>(6)</th>
                        <th>(7)</th>
                        <th>(8)</th>
                        <th>(9)</th>
                        <th>(10)</th>
                        <th>(11)</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    @if (ListItems != null && ListItems.Count > 0)
                    {
                        foreach (var item in ListItems)
                        {
                            if (item.is_deleted != true)
                            {
                                <tr>
                                    <td>@item.Block_7_1</td>
                                    <td>@item.Block_7_2</td>
                                    <td>@item.is_household</td>
                                    <td>@item.Block_7_3</td>
                                    <td>@item.Block_7_4</td>
                                    <td>@item.Block_7_5</td>
                                    <td>@item.Block_7_6</td>
                                    <td>@item.Block_7_7</td>
                                    <td>@item.Block_7_8</td>
                                    <td>@item.Block_7_9</td>
                                    <td>@item.SSS</td>
                                    <td><input type="checkbox" @bind="item.isSelected" disabled /></td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- 🔹 Footer Navigation (Always visible) -->
    <div class="d-flex justify-content-between mt-3">
        <NavLink class="btn btn-outline-primary" onclick="@GoBack">
            <i class="bi bi-chevron-left me-1"></i>Back
        </NavLink>

        <NavLink class="btn btn-outline-primary" @onclick="@(() => HandleSubmit("NEXT"))">
            Next<i class="bi bi-chevron-right ms-1"></i>
        </NavLink>
    </div>
</GlobalErrorBoundary>



@code {
    EditContext editContext;
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries SCH_0_0_Queries = new();
    CommonConfig commonConfig = new();
    Modal AddModal = default;
    public int sector { get; set; } = 0;
    Tbl_Sch_0_0_Block_7 fields = new();
    List<Tbl_Sch_0_0_Block_7> ListItems = new();
    ValidationComponent house_number_ref = new();
    ValidationComponent purpose_ref = new();
    ValidationComponent head_name_ref = new();
    ValidationComponent size_ref = new();
    CommonList commonList = new();
    private ValidationMessageStore messageStore;

    CommonFunction commonFunctions = new();
    bool is_error = false;

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }
    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
            {
                block_uri = "/dashboard/sch0.0/block_7_selection",
                block_title = "Sch 0.0 Block 7 Selection",
                block_code = CommonEnum.sch_0_0_block_7_selection.ToString(),
            };

        await commonQueries.InsertVisitedBlock(vb);
        var block_0_1 = await SCH_0_0_Queries.FetchBlock1();
        if (block_0_1 != null)
        {
            SessionStorage.FSU_Sector = sector = block_0_1.Block_1_5.GetValueOrDefault();
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
        if (response != null && response.Count > 0)
        {
            ListItems?.Clear();
            ListItems?.AddRange(response.OrderBy(x => x.Block_7_1).ToList());
            StateHasChanged();
        }
    }

    private async Task ResetSelection()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Resetting Selection, Please wait...");
            var response = await SCH_0_0_Queries.ResetSelection();
            if (response > 0)
            {
                toastService.ShowSuccess("Selection reset successful");
                SessionStorage.selection_done = false;
                //Update selection flag at FSU level
                var fsu = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
                if (fsu != null)
                {
                    fsu.is_selection_done = false;
                    await commonQueries.UpdateFSU(fsu);
                }
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during resetting selection: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }


    private async Task CalculateSSS()
    {
        //1. Separate logic for rural (consider both A and B) and urban (only A)
        //2. A - Arrange usual monthly consumption expenditure (Block_7_9) in ascending order and find median
        //3. B - Arrange land area (Block_7_8) in ascending order and find 60th percentile value
        //4. Calculate SSS using formula below -
        /*
         * Rural:
         * SSS - 11 = Block_7_7 = 1 and Block_7_8 < B
         * SSS - 12 = Block_7_7 = 1 and Block_7_8 >= B
         * SSS - 21 = Block_7_7 = 2 and Block_7_9 < A
         * SSS - 22 = Block_7_7 = 2 and Block_7_9 >= A
         * SSS - 31 = Block_7_7 = 3 and Block_7_9 < A
         * SSS - 32 = Block_7_7 = 3 and Block_7_9 >= A
         * SSS - 40 = Block_7_7 = 4
         * SSS - 90 = Block_7_7 = 9
         * Urban:
         * SSS - 11 = Block_7_7 = 1 and Block_7_9 < A
         * SSS - 121 = Block_7_7 = 1 and Block_7_9 >= A and Block_7_6 in [1,2,3,4,5,6]
         * SSS - 122 = Block_7_7 = 1 and Block_7_9 >= A and Block_7_6 in [7,8,10,11]
         * SSS - 21 = Block_7_7 = 2 and Block_7_9 < A
         * SSS - 221 = Block_7_7 = 2 and Block_7_9 >= A and Block_7_6 in [1,2,3,4,5,6]
         * SSS - 222 = Block_7_7 = 2 and Block_7_9 >= A and Block_7_6 in [7,8,10,11]
         * SSS - 40 = Block_7_7 = 3
         * SSS - 90 = Block_7_7 in [4,9]
         */
        try
        {
            preloadService.Show(SpinnerColor.Info, "Assigning SSS");
            // Fetch data
            var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);

            if (response == null || response.Count == 0)
                return;

            response = response.Where(x => x.is_household == 2).ToList(); // Consider only households
            // --- Calculate A: median of Block_7_9 ---
            var allExpenditure = response.Where(x => x.UMPCE.HasValue)
                             .Select(x => (decimal)x.UMPCE.Value)
                             .OrderBy(x => x)
                             .ToList();

            decimal A = 0;
            int count = allExpenditure.Count;

            if (count > 0)
            {
                if (count % 2 == 1)
                    A = allExpenditure[count / 2];
                else
                    A = (allExpenditure[(count / 2) - 1] + allExpenditure[count / 2]) / 2;
            }


            // --- Calculate B: 60th percentile of Block_7_8 ---
            var landAreas = response.Where(x => x.Block_7_8.HasValue)
                                    .Select(x => x.Block_7_8.Value)
                                    .OrderBy(x => x)
                                    .ToList();
            decimal B = 0;
            int landCount = landAreas.Count;
            if (landCount > 0)
            {
                double percentileIndex = 0.6 * (landCount - 1);
                int lowerIndex = (int)Math.Floor(percentileIndex);
                int upperIndex = (int)Math.Ceiling(percentileIndex);
                B = (decimal)(landAreas[lowerIndex] + (landAreas[upperIndex] - landAreas[lowerIndex]) * (percentileIndex - lowerIndex));
            }

            // --- Assign A and B to each household ---
            foreach (var item in response)
            {
                item.a = A;
                item.b = B;
            }

            // --- Assign SSS based on sector ---
            foreach (var item in response)
            {
                int block7 = item.Block_7_7 ?? 0;
                var expenditure = item.UMPCE ?? 0;
                double landArea = item.Block_7_8 ?? 0;
                int education = item.Block_7_6 ?? 0;

                if (sector == 1) // Rural
                {
                    switch (block7)
                    {
                        case 1:
                            item.SSS = landArea < (double)B ? 11 : 12;
                            item.Stratum = 10;
                            break;
                        case 2:
                            item.SSS = expenditure < (int)A ? 21 : 22;
                            item.Stratum = 20;
                            break;
                        case 3:
                            item.SSS = expenditure < (int)A ? 31 : 32;
                            item.Stratum = 30;
                            break;
                        case 4:
                            item.SSS = 40;
                            item.Stratum = 40;
                            break;
                        case 9:
                            item.SSS = 90;
                            item.Stratum = 90;
                            break;
                        default:
                            item.SSS = 0;
                            item.Stratum = 0;
                            break;
                    }
                }
                else if (sector == 2) // Urban
                {
                    switch (block7)
                    {
                        case 1:
                            item.Stratum = 10;
                            if (expenditure < (int)A)
                                item.SSS = 11;
                            else if (new int[] { 1, 2, 3, 4, 5, 6 }.Contains(education))
                                item.SSS = 121;
                            else if (new int[] { 7, 8, 10, 11 }.Contains(education))
                                item.SSS = 122;
                            else
                                item.SSS = 0;
                            break;

                        case 2:
                            item.Stratum = 20;
                            if (expenditure < (int)A)
                                item.SSS = 21;
                            else if (new int[] { 1, 2, 3, 4, 5, 6 }.Contains(education))
                                item.SSS = 221;
                            else if (new int[] { 7, 8, 10, 11 }.Contains(education))
                                item.SSS = 222;
                            else
                                item.SSS = 0;
                            break;

                        case 3:
                            item.Stratum = 40;
                            item.SSS = expenditure < (int)A ? 40 : 0;
                            break;

                        case 4:
                        case 9:
                            item.Stratum = 90;
                            item.SSS = 90;
                            break;

                        default:
                            item.Stratum = 0;
                            item.SSS = 0;
                            break;
                    }
                }
            }

            // Optionally: Save updated response to database here
            var update = await SCH_0_0_Queries.SaveSSSToDatabase(response);
            if (update == 1)
            {
                toastService.ShowSuccess("SSS assignment successful");
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            // Handle/log exception
            Console.WriteLine(ex.Message);
        }
        finally
        {
            preloadService.Hide();
        }
    }

    async Task DoSelection()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Doing Selection, Please wait...");
            List<SSSItem> s1List = new List<SSSItem>();

            await SCH_0_0_Queries.UpdateAllRowsForColumnAsync(SessionStorage.SelectedFSUId);
            var existingListingData = await SCH_0_0_Queries.Get_SCH0_0_Block_5A_HouseHoldBy_FSUP(SessionStorage.SelectedFSUId);
            var sss_selection_done = existingListingData.Any(x => x.SSS != 0);

            if (sss_selection_done == false)
            {
                toastService.ShowError("Please calculate SSS before doing selection, Please try again!");
                return;
            }

            if (existingListingData.Count > 0)
            {
                var config = SelectionConfigFactory.Build(sector);
                var selector = new HouseholdSelector(config, randomSeed: 42);
                var result = selector.Select(existingListingData, sector);

                foreach (var item in result.Households)
                {
                    item.isInitialySelected = item.isSelected;
                    item.SSS = item.SelectedPostedSSS.GetValueOrDefault();
                    await SCH_0_0_Queries.Update_SCH0_0_Block_7(item);
                    SessionStorage.selection_done = true;
                }

                Debug.WriteLine("Selected households:");
                //Update selection flag at FSU level
                var fsu = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
                if (fsu != null)
                {
                    fsu.is_selection_done = true;
                    await commonQueries.UpdateFSU(fsu);
                }
                foreach (var hh in result.Households.Where(h => h.isSelected))
                {
                    Debug.WriteLine($"Id={hh.Block_7_3} Stratum={hh.Stratum} FromSSS={hh.SelectedFromSSS} PostedSSS={hh.SelectedPostedSSS}");
                }

                Debug.WriteLine("\nLogs:");
                foreach (var log in result.Logs)
                {
                    Debug.WriteLine($"{log.HouseholdId} origSSS={log.OriginalSSS} posted={log.PostedSSS} note={log.Reason}");
                }
                toastService.ShowSuccess("Selection done successfully!");
                await LoadData();

            }

        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during selection: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }

    async Task HandleSubmit(string action = "")
    {
        NavigationManager.NavigateTo("/dashboard/sch0.0/block_8");
        return;
    }
}
