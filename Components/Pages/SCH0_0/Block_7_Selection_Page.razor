@page "/dashboard/sch0.0/block_7_selection"
@using Blazored.FluentValidation
@using Income.Common.SCH0_0
@using Income.Database.Models.Common
@using Income.Database.Models.SCH0_0
@using Income.SurveyLibrary
@using Income.Validators.SCH0_0
@using System.Diagnostics
@layout Income.Components.Layout.DashboardLayout
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject PreloadService preloadService
@inject ILoggingService Logger


<GlobalErrorBoundary>
    <div class="main-content">
        <CommonContentHeader SelectedFsuId="@SelectedFsuId"
        survey_time="@survey_time" />
        <div class="card custom-card">
            <!-- 🔹 Sticky Top Action Header -->
            <div class="card-header">
                <h3 class="card-title">
                    <span class="text-primary me-2">[Block 7]</span>List of households and selection of households for Schedule on HIS
                </h3>
                <div class="card-tools">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-2" hidden="@SessionStorage.selection_done" @onclick="@(() => OpenGenerateModal())">
                            <i class="fi fi-rr-calculator me-1"></i>Generate
                        </button>

                        <button class="btn btn-outline-secondary btn-sm me-2" hidden="@SessionStorage.selection_done" @onclick="@(() => CalculateSSS())">
                            <i class="fi fi-rr-calculator me-1"></i>Calc SSS
                        </button>

                        <button class="btn btn-primary btn-sm me-2" hidden="@SessionStorage.selection_done" @onclick="@(() => DoSelection())">
                            <i class="fi fi-rr-checkbox me-1"></i>Selection
                        </button>

                        <button class="btn btn-outline-primary btn-sm" @onclick="@(() => ResetSelection())">
                            <i class="fi fi-rr-rotate-left me-1"></i>Reset Selection
                        </button>

                        <button class="btn btn-outline-primary btn-sm" @onclick="@(() => DeleteAllHHDS())">
                            <i class="fi fi-rr-rotate-left me-1"></i>Delete All Households
                        </button>
                    </div>
                </div>
            </div>

            <!-- 🔹 Scrollable table -->
            <div class="card-body p-0">
                <div class="table-responsive table-wrapper">
                    <table class="table table-striped table-bordered mb-0">
                        <thead>
                            <tr>
                                <th style="min-width:10px;">Srl.No.</th>
                                <th style="min-width:50px;">House Number</th>
                                <th style="min-width:200px;">Is the house used only for non-residential purposes? (yes-1, no-2)</th>
                                <th style="min-width:50px;">Household Serial Number</th>
                                <th style="min-width:100px;">Name of the head of the household</th>
                                <th style="min-width:50px;">Household Size</th>
                                <th style="min-width:400px;">Highest education level attained among the household members (entry in code) – (for urban only) code 2 in item 5 of Block 1)</th>
                                <th style="min-width:50px;">Household Type</th>
                                <th style="min-width:400px;">Total amount of land owned (possessed or leased out) by the household as on the date of the survey (in acres in three places of decimal) – ((for rural only) code 1 in item 5 of Block 1)</th>
                                <th style="min-width:200px;">Usual monthly consumption expenditure of the household (Rs.)</th>
                                <th style="min-width:100px;">SSS number for Schedule HIS 2026</th>
                                <th style="min-width:40px;">Selected</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>(0)</th>
                                <th>(1)</th>
                                <th>(2)</th>
                                <th>(3)</th>
                                <th>(4)</th>
                                <th>(5)</th>
                                <th>(6)</th>
                                <th>(7)</th>
                                <th>(8)</th>
                                <th>(9)</th>
                                <th>(10)</th>
                                <th>(11)</th>
                            </tr>
                            @if (ListItems != null && ListItems.Count > 0)
                            {
                                foreach (var item in ListItems)
                                {
                                    if (item.is_deleted != true)
                                    {
                                        <tr>
                                            <td>@item.Block_7_1</td>
                                            <td>@item.Block_7_2</td>
                                            <td>@item.is_household</td>
                                            <td>@item.Block_7_3</td>
                                            <td>@item.Block_7_4</td>
                                            <td>@item.Block_7_5</td>
                                            <td>@item.Block_7_6</td>
                                            <td>@item.Block_7_7</td>
                                            <td>@item.Block_7_8</td>
                                            <td>@item.Block_7_9</td>
                                            <td>@item.SSS</td>
                                            <td>
                                                <div class="siteCustomCheckbox">
                                                    <label>
                                                        <input type="checkbox" @bind="item.isSelected" disabled />
                                                    </label>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 🔹 Footer Navigation (Always visible) -->
    <div class="footer">
        @* Remarks Card *@
        <div class="card custom-card">
            <div class="card-header">
                <h3 class="card-title">Remarks</h3>
            </div>
            <div class="card-body">
                <textarea type="text" class="form-control disabled w-100" disabled="@SessionStorage.FSU_Submitted" placeholder="" @bind="@remarks" rows="2"></textarea>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="d-flex">
                    <NavLink class="btn btn-outline-secondary" onclick="@GoBack">
                        <i class="fi fi-rr-angle-left me-1"></i>Back
                    </NavLink>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="d-flex align-items-center justify-content-end">
                    <NavLink class="btn btn-primary" @onclick="@(() => HandleSubmit("NEXT"))">
                        Next<i class="fi fi-rr-angle-right ms-1"></i>
                    </NavLink>
                </div>
            </div>
        </div>
    </div>

    <Modal @ref="ModalRef" Size="ModalSize.Large">
    <HeaderTemplate>
        <h5 class="modal-title">Generate Households</h5>
    </HeaderTemplate>

    <BodyTemplate>
        <div class="mb-3">
            <label>Sector: @sector</label>
        </div>

            @foreach (var sss in ValidSss)
            {
                <div class="input-group mb-2">
                    <span class="input-group-text" style="width: 80px;">@sss</span>
                    <input type="number"
                           class="form-control"
                           @bind="InputCounts[sss]"
                           min="0" />
                </div>
            }
    </BodyTemplate>

    <FooterTemplate>
            <Button @onclick="@(() => Generate())">Generate</Button>
        <Button @onclick="Cancel">Cancel</Button>
    </FooterTemplate>
</Modal>
</GlobalErrorBoundary>



@code {
    private Modal ModalRef;

    public Dictionary<int, int> InputCounts { get; set; } = new();
    public List<int> ValidSss { get; set; } = new();
    EditContext editContext;
    int SelectedFsuId = SessionStorage.SelectedFSUId;
    DateTime survey_time = DateTime.Now;
    CommonQueries commonQueries = new();
    DBQueries SCH_0_0_Queries = new();
    CommonConfig commonConfig = new();
    Modal AddModal = default;
    public int sector { get; set; } = 0;
    Tbl_Sch_0_0_Block_7 fields = new();
    List<Tbl_Sch_0_0_Block_7> ListItems = new();
    ValidationComponent house_number_ref = new();
    ValidationComponent purpose_ref = new();
    ValidationComponent head_name_ref = new();
    ValidationComponent size_ref = new();
    CommonList commonList = new();
    Tbl_Sch_0_0_Block_0_1 block_0_1 = new();
    private ValidationMessageStore messageStore;
    private readonly Dictionary<int, int[]> SssMap = new()
{
    { 1, new[] { 11,12,21,22,31,32,40,90 } },
    { 2, new[] { 11,121,122,21,221,222,40,90 } }
};


    CommonFunction commonFunctions = new();
    bool is_error = false;
    private string? remarks = string.Empty;

    async void GoBack()
    {
        await JSRuntime.InvokeVoidAsync("__handleGoBack");
        return;
    }
    protected override async Task OnInitializedAsync()
    {
        Tbl_Visited_Blocks vb = new Tbl_Visited_Blocks
            {
                block_uri = "/dashboard/sch0.0/block_7_selection",
                block_title = "Sch 0.0 Block 7 Selection",
                block_code = CommonEnum.sch_0_0_block_7_selection.ToString(),
            };

        await commonQueries.InsertVisitedBlock(vb);
        var block_0_1 = await SCH_0_0_Queries.FetchBlock1();
        if (block_0_1 != null)
        {
            this.block_0_1 = block_0_1;
            remarks = block_0_1.remarks_block_7_selection;
            SessionStorage.FSU_Sector = sector = block_0_1.Block_1_5.GetValueOrDefault();
            if (sector == 1)
                ValidSss = new() { 11, 12, 21, 22, 31, 32, 40, 90 };
            else
                ValidSss = new() { 11, 121, 122, 21, 221, 222, 40, 90 };

            foreach (var sss in ValidSss)
                InputCounts[sss] = 0;
        }
        await LoadData();
        await Logger.LogInfo($"Block 7 Loaded for {SessionStorage.SelectedFSUId}");
    }

    private async Task Generate()
    {
        var list = new List<Tbl_Sch_0_0_Block_7>();

        foreach (var (sss, count) in InputCounts)
        {
            for (int i = 0; i < count; i++)
            {
                list.Add(new Tbl_Sch_0_0_Block_7
                {
                    id = Guid.NewGuid(),
                    SSS = sss,
                    Stratum = GetStratum(sss),
                    isInitialySelected = false,
                    is_household = 2,
                    isSelected = false,
                    fsu_id = SessionStorage.SelectedFSUId
                });
            }
        }
        await SCH_0_0_Queries.SaveBulkBlock7(list);
        await ModalRef.HideAsync();
        await LoadData();
    }

    private async Task OpenGenerateModal()
    {
        await ModalRef.ShowAsync();
    }

    private async Task Cancel()
    {
        await ModalRef.HideAsync();
    }

    private int GetStratum(int sss)
    {
        var firstDigit = int.Parse(sss.ToString()[0].ToString());
        return firstDigit * 10;
    }

    private async Task LoadData()
    {
        var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);
        if (response != null && response.Count > 0)
        {
            ListItems?.Clear();
            ListItems?.AddRange(response.OrderBy(x => x.Block_7_1).ToList());
        }
        else
        {
            ListItems?.Clear();
        }
        StateHasChanged();

    }

    private async Task ResetSelection()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Resetting Selection, Please wait...");
            var response = await SCH_0_0_Queries.ResetSelection();
            if (response > 0)
            {
                toastService.ShowSuccess("Selection reset successful");
                SessionStorage.selection_done = false;
                //Update selection flag at FSU level
                var fsu = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
                if (fsu != null)
                {
                    fsu.is_selection_done = false;
                    await commonQueries.UpdateFSU(fsu);
                }

                var suList = await SCH_0_0_Queries.FetchSCH0Block2_2Data();
                if (suList != null && suList.Count > 0)
                {
                    foreach(var item in suList)
                    {
                        item.IsChecked = false;
                        item.is_selected = false;
                        await SCH_0_0_Queries.SaveSCH0Block2_2(suList);
                    }
                }
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during resetting selection: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }

    private async Task DeleteAllHHDS()
    {
        try
        {
            await ResetSelection();
            await SCH_0_0_Queries.DeleteAllHHDS();
            await LoadData();
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Getting error during deleting all households: {ex}, Please try again!");
        }
        finally
        {
            preloadService.Hide();
        }
    }

    private async Task CalculateSSS()
    {
        //1. Separate logic for rural (consider both A and B) and urban (only A)
        //     //2. A - Arrange usual monthly consumption expenditure (Block_7_9) in ascending order and find median (This will be determined for individual household types - Block_7_7)
        //     //3. B - Arrange land area (Block_7_8) in ascending order and find 60th percentile value (This will be determined for individual household types - Block_7_7)
        //     //4. Calculate SSS using formula below -
        //     /*
        //      * Rural:
        //      * SSS - 11 = Block_7_7 = 1 and Block_7_8 < B
        //      * SSS - 12 = Block_7_7 = 1 and Block_7_8 >= B
        //      * SSS - 21 = Block_7_7 = 2 and Block_7_9 < A
        //      * SSS - 22 = Block_7_7 = 2 and Block_7_9 >= A
        //      * SSS - 31 = Block_7_7 = 3 and Block_7_9 < A
        //      * SSS - 32 = Block_7_7 = 3 and Block_7_9 >= A
        //      * SSS - 40 = Block_7_7 = 4
        //      * SSS - 90 = Block_7_7 = 9
        //      * Urban:
        //      * SSS - 11 = Block_7_7 = 1 and Block_7_9 < A
        //      * SSS - 121 = Block_7_7 = 1 and Block_7_9 >= A and Block_7_6 in [1,2,3,4,5,6]
        //      * SSS - 122 = Block_7_7 = 1 and Block_7_9 >= A and Block_7_6 in [7,8,10,11]
        //      * SSS - 21 = Block_7_7 = 2 and Block_7_9 < A
        //      * SSS - 221 = Block_7_7 = 2 and Block_7_9 >= A and Block_7_6 in [1,2,3,4,5,6]
        //      * SSS - 222 = Block_7_7 = 2 and Block_7_9 >= A and Block_7_6 in [7,8,10,11]
        //      * SSS - 40 = Block_7_7 = 3
        //      * SSS - 90 = Block_7_7 in [4,9]
        //      */
        try
        {
            preloadService.Show(SpinnerColor.Info, "Assigning SSS");

            // 1. Fetch data
            var response = await SCH_0_0_Queries.GetBlock7Data(SessionStorage.SelectedFSUId);

            if (response == null || response.Count == 0)
                return;

            // Only households
            response = response.Where(x => x.is_household == 2).ToList();

            // 2. Group by household type (Block_7_7)
            var grouped = response.GroupBy(x => x.Block_7_7 ?? 0);

            // 3. For each household type, compute A and B
            foreach (var group in grouped)
            {
                var items = group.ToList();

                // ---- Compute A: median of UMPCE ----
                var expenditures = items
                    .Where(x => x.UMPCE.HasValue)
                    .Select(x => (decimal)x.UMPCE.Value)
                    .OrderBy(x => x)
                    .ToList();

                decimal A = 0;
                int count = expenditures.Count;

                if (count > 0)
                {
                    if (count % 2 == 1)
                        A = expenditures[count / 2];
                    else
                        A = (expenditures[(count / 2) - 1] + expenditures[count / 2]) / 2;
                }

                // ---- Compute B: 60th percentile of land area ----
                var landAreas = items
                    .Where(x => x.Block_7_8.HasValue)
                    .Select(x => x.Block_7_8.Value)
                    .OrderBy(x => x)
                    .ToList();

                double B = 0;
                int landCount = landAreas.Count;

                if (landCount > 0)
                {
                    B = Percentile_NPlus1(landAreas, 60);
                    // double percentileIndex = 0.6 * (landCount - 1);
                    // int lowerIndex = (int)Math.Floor(percentileIndex);
                    // int upperIndex = (int)Math.Ceiling(percentileIndex);

                    // B = (decimal)(landAreas[lowerIndex] +
                    //     (landAreas[upperIndex] - landAreas[lowerIndex]) * (percentileIndex - lowerIndex));
                }

                // ---- Assign A & B to each member of this household type ----
                foreach (var item in items)
                {
                    item.a = A;
                    item.b = (decimal)B;
                }
            }

            // 4. Assign SSS using item.a and item.b (HH-type wise values)
            foreach (var item in response)
            {
                int block7 = item.Block_7_7 ?? 0;
                decimal A = item.a;
                decimal B = item.b;

                decimal expenditure = (decimal)(item.UMPCE ?? 0);
                decimal landArea = (decimal)(item.Block_7_8 ?? 0);
                int education = item.Block_7_6 ?? 0;

                if (sector == 1)   // ---------------------- RURAL ----------------------
                {
                    switch (block7)
                    {
                        case 1:
                            item.SSS = landArea < B ? 11 : 12;
                            item.Stratum = 10;
                            break;

                        case 2:
                            item.SSS = expenditure < A ? 21 : 22;
                            item.Stratum = 20;
                            break;

                        case 3:
                            item.SSS = expenditure < A ? 31 : 32;
                            item.Stratum = 30;
                            break;

                        case 4:
                            item.SSS = 40;
                            item.Stratum = 40;
                            break;

                        case 9:
                            item.SSS = 90;
                            item.Stratum = 90;
                            break;

                        default:
                            item.SSS = 0;
                            item.Stratum = 0;
                            break;
                    }
                }
                else if (sector == 2)  // ---------------------- URBAN ----------------------
                {
                    switch (block7)
                    {
                        case 1:
                            item.Stratum = 10;
                            if (expenditure < A)
                                item.SSS = 11;
                            else if (new[] { 1, 2, 3, 4, 5, 6 }.Contains(education))
                                item.SSS = 121;
                            else if (new[] { 7, 8, 10, 11 }.Contains(education))
                                item.SSS = 122;
                            else
                                item.SSS = 0;
                            break;

                        case 2:
                            item.Stratum = 20;
                            if (expenditure < A)
                                item.SSS = 21;
                            else if (new[] { 1, 2, 3, 4, 5, 6 }.Contains(education))
                                item.SSS = 221;
                            else if (new[] { 7, 8, 10, 11 }.Contains(education))
                                item.SSS = 222;
                            else
                                item.SSS = 0;
                            break;

                        case 3:
                            item.Stratum = 40;
                            item.SSS = 40;   // Rule: all type-3 are SSS = 40
                            break;

                        case 4:
                        case 9:
                            item.Stratum = 90;
                            item.SSS = 90;
                            break;

                        default:
                            item.Stratum = 0;
                            item.SSS = 0;
                            break;
                    }
                }
            }

            // 5. Save to DB
            var update = await SCH_0_0_Queries.SaveSSSToDatabase(response);

            if (update == 1)
            {
                toastService.ShowSuccess("SSS assignment successful");
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            preloadService.Hide();
        }
    }

    public static double Percentile_NPlus1(IList<double> sequence, double percentile)
    {
        if (sequence == null || sequence.Count == 0)
            throw new ArgumentException("Sequence cannot be empty.");

        if (percentile < 0 || percentile > 100)
            throw new ArgumentException("Percentile must be between 0 and 100.");

        var data = sequence.OrderBy(x => x).ToList();
        int n = data.Count;

        if (n == 1)
            return data[0];

        // Position based on Hazen's (n + 1) method
        double position = (percentile / 100.0) * (n + 1);

        // If position is below 1 → return first value
        if (position <= 1)
            return data[0];

        // If position is above n → return last value
        if (position >= n)
            return data[n - 1];

        // Find lower and upper neighbours
        int lowerIndex = (int)Math.Floor(position) - 1;  // convert to 0-based
        int upperIndex = (int)Math.Ceiling(position) - 1;

        // Interpolation weight
        double weight = position - Math.Floor(position);

        // If exact integer position → return that value
        if (lowerIndex == upperIndex)
            return data[lowerIndex];

        return data[lowerIndex] + weight * (data[upperIndex] - data[lowerIndex]);
    }


    async Task DoSelection()
    {
        try
        {
            preloadService.Show(SpinnerColor.Info, "Doing Selection, Please wait...");

            await SCH_0_0_Queries.UpdateAllRowsForColumnAsync(SessionStorage.SelectedFSUId);
            var existingListingData = await SCH_0_0_Queries.Get_SCH0_0_Block_5A_HouseHoldBy_FSUP(SessionStorage.SelectedFSUId);
            var sss_selection_done = existingListingData.Any(x => x.SSS != 0);

            if (!sss_selection_done)
            {
                toastService.ShowError("Please calculate SSS before doing selection, Please try again!");
                return;
            }
            if (existingListingData.Count > 0)
            {
                var service = new HouseholdSelectionService();
                var households = existingListingData;
                int sectorType = sector; // 1 = Rural, 2 = Urban

                var result = service.SelectHouseholds(households, sectorType);

                if (result.Success)
                {
                    foreach (var item in result.SelectedHouseholds)
                    {
                        item.isInitialySelected = item.isSelected;
                        //item.SSS = item.SelectedPostedSSS.GetValueOrDefault();
                        await SCH_0_0_Queries.Update_SCH0_0_Block_7(item);
                        SessionStorage.selection_done = true;
                    }
                    await SCH_0_0_Queries.AssignSSSHouseholdIds();

                    await Logger.LogInfo("Selected households:");
                    //Update selection flag at FSU level
                    var fsu = await commonQueries.FetchFsuByFsuId(SessionStorage.SelectedFSUId);
                    if (fsu != null)
                    {
                        fsu.is_selection_done = true;
                        await commonQueries.UpdateFSU(fsu);
                    }
                    await Logger.LogInfo($"Total households selected: {result.SelectedHouseholds.Count}");

                    foreach (var msg in result.Messages)
                    {
                        await Logger.LogInfo(msg.Value);
                    }

                    // Process selected households
                    foreach (var hh in result.SelectedHouseholds)
                    {
                        await Logger.LogInfo($"HH {hh.Block_7_3}: SSS {hh.SSS} -> Posted as SSS {hh.SelectedPostedSSS}");
                    }
                }
                toastService.ShowSuccess("Selection done successfully!");
                await LoadData();
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            preloadService.Hide();
        }

    }

    

    async Task HandleSubmit(string action = "")
    {
        block_0_1.remarks_block_7_selection = remarks;
        if (block_0_1.id != Guid.Empty)
            await SCH_0_0_Queries.SaveBlock1(block_0_1);

        var selectionDone = ListItems.Any(x => x.isSelected);
        if (!selectionDone)
        {
            toastService.ShowError($"Cannot proceed without selection");
            return;
        }
        NavigationManager.NavigateTo("/dashboard/sch0.0/block_8");
    }
}
